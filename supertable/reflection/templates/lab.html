{% extends "base.html" %}

{% block title %}Lab{% endblock %}

{% block head_extra %}
<style>
  .muted { color:#64748b; font-size: 12px; }
  .mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  .nb-root {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    padding: 24px 28px;
    border: 1px solid rgba(0,0,0,0.05);
    border-left: 5px solid #1c96ca;
  }

  .nb-topbar {
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 12px;
    flex-wrap: wrap;
  }

  .nb-title {
    font-size: 18px;
    font-weight: 900;
    color:#0f172a;
  }

  /* Admin-like tab bar (matches admin.html) */
  #tab-navigation {
    display: flex;
    gap: 24px;
    margin-top: 16px;
    border-bottom: 1px solid #e2e8f0;
    padding: 0 2px;
    flex-wrap: wrap;
    align-items: center;
  }

  .tab {
    padding: 8px 0;
    margin-bottom: -1px;
    border: none;
    border-bottom: 2px solid transparent;
    background: transparent;
    cursor: pointer;
    font-size: 13px;
    color: #64748b;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    user-select: none;
  }

  .tab.active {
    color: #1c96ca;
    border-bottom-color: #1c96ca;
    font-weight: 500;
  }

  .tab-sep {
    color:#94a3b8;
    margin: 0 6px;
    font-size: 13px;
    user-select:none;
  }

  .tab-add {
    min-width: 22px;
    height: 22px;
    border-radius: 999px;
    border: 1px solid #cbd5e1;
    background: #f8fafc;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    cursor: pointer;
    color: #0f172a;
    padding: 0;
    margin-bottom: 4px;
  }
  .tab-add:hover { background: #e2e8f0; }

  .tab-close {
    width: 18px;
    height: 18px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,.8);
    background: #fff;
    display: inline-flex;
    align-items:center;
    justify-content:center;
    font-size: 11px;
    color: #64748b;
    cursor:pointer;
    padding: 0;
  }
  .tab-close:hover {
    background: rgba(239,68,68,0.12);
    border-color: rgba(239,68,68,0.55);
    color: rgba(239,68,68,0.9);
  }

  .tab-doc {
    display:inline-flex;
    align-items:center;
    gap: 8px;
  }

  .hidden { display:none; }

  .panel {
    border: 1px solid rgba(15,23,42,.10);
    border-radius: 16px;
    background: #fff;
    padding: 14px 14px;
  }

  .panel + .panel { margin-top: 12px; }

  .panel-head {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    flex-wrap: wrap;
  }

  .panel-title {
    font-weight: 900;
    color:#0f172a;
    display:flex;
    align-items:center;
    gap: 8px;
    font-size: 13px;
  }

  /* Buttons match admin style */
  .btn-azure-outline {
    border: 1px solid #1c96ca;
    background: transparent;
    color: #1c96ca;
    font-weight: 600;
    transition: background-color 0.2s ease, color 0.2s ease;
  }
  .btn-azure-outline:hover { background: #1c96ca; color: #ffffff; }

  .btn-danger-outline {
    border: 1px solid rgba(239,68,68,0.75);
    background: transparent;
    color: rgba(239,68,68,0.9);
    font-weight: 700;
    transition: background-color 0.2s ease, color 0.2s ease;
  }
  .btn-danger-outline:hover { background: rgba(239,68,68,0.9); color:#fff; }

  /* Notebook list */
  .toolbar {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
  }

  .searchbox {
    display:flex;
    align-items:center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .searchbox input { min-width: 320px; }
  @media (max-width: 680px) { .searchbox input { min-width: 100%; } }

  /* Editor */
  .editor-top {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  .editor-top .left,
  .editor-top .right {
    display:flex;
    align-items:center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .editor-subbar {
    display:flex;
    align-items:center;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
  }

  .nb-name-input {
    min-width: 260px;
    font-weight: 700;
  }

  /* Cells */
  .cell {
    border: 1px solid rgba(15,23,42,.10);
    border-radius: 16px;
    background: #fff;
    overflow: hidden;
    margin-top: 12px;
  }

  .cell-head {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    padding: 10px 12px;
    background: rgba(248,250,252,.9);
    border-bottom: 1px solid rgba(15,23,42,.08);
  }

  .cell-left {
    display:flex;
    align-items:center;
    gap: 10px;
    font-weight: 900;
    color:#334155;
    font-size: 12px;
  }

  .cell-actions {
    display:flex;
    align-items:center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .cell-body { padding: 10px 12px; }

  .codebox {
    width: 100%;
    min-height: 130px;
    resize: vertical;
    border-radius: 14px;
    border: 1px solid rgba(15,23,42,.14);
    padding: 12px 12px;
    background: #ffffff;
    font-size: 13px;
    line-height: 1.35;
  }

  .output {
    margin-top: 10px;
    border-radius: 14px;
    border: 1px solid rgba(15,23,42,.10);
    background: rgba(248,250,252,.9);
    padding: 10px 12px;
    font-size: 12px;
    color:#0f172a;
    display:none;
  }
  .output.err { border-left: 4px solid rgba(239,68,68,0.7); }
  .output.ok { border-left: 4px solid rgba(16,185,129,0.7); }
  .output pre { margin:0; white-space: pre-wrap; }

  /* Tiny toast */
  .toast {
    position: fixed;
    right: 18px;
    top: 16px;
    z-index: 5000;
    background: rgba(15,23,42,0.92);
    color: #fff;
    border-radius: 14px;
    padding: 10px 12px;
    font-size: 12px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.22);
    display:none;
    max-width: min(520px, calc(100vw - 36px));
  }

  /* Modal */
  .nb-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding: 18px;
    z-index: 4000;
  }
  .nb-modal .card {
    background:#fff;
    border-radius: 16px;
    box-shadow: 0 30px 80px rgba(0,0,0,0.25);
    border: 1px solid rgba(0,0,0,0.08);
    max-width: 980px;
    width: 100%;
    padding: 14px;
  }
  .nb-modal .head {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }
  .nb-modal .title {
    font-weight: 900;
    color:#0f172a;
    font-size: 14px;
    display:flex;
    align-items:center;
    gap: 8px;
  }
  .nb-modal .body { margin-top: 10px; }
  .nb-modal .actions {
    margin-top: 12px;
    display:flex;
    justify-content:flex-end;
    gap: 10px;
    flex-wrap: wrap;
  }

  /* Snippets list */
  .sn-grid {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 12px;
  }
  @media (max-width: 980px) { .sn-grid { grid-template-columns: 1fr; } }

  .sn-card {
    border: 1px solid rgba(15,23,42,.10);
    border-radius: 16px;
    padding: 12px 12px;
    background:#fff;
  }
  .sn-card .top {
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 10px;
  }
  .sn-card .name { font-weight: 900; color:#0f172a; font-size: 13px; }
  .sn-card pre {
    margin: 10px 0 0 0;
    padding: 10px 10px;
    border-radius: 14px;
    background: rgba(248,250,252,.9);
    border: 1px solid rgba(15,23,42,.10);
    font-size: 12px;
    white-space: pre-wrap;
  }
  .sn-actions {
    display:flex;
    align-items:center;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
  }
</style>
{% endblock %}

{% block content %}

{% include "selection.html" %}

<div style="height: 18px;"></div>

<div id="nbRoot"
     class="nb-root"
     data-org="{{ sel_org }}"
     data-sup="{{ sel_sup }}"
     data-user-hash="{{ session_user_hash }}"
>
  <div class="nb-topbar">
    <div>
      <div class="nb-title">Lab</div>
      <div class="muted" style="margin-top:4px;">
        Manage lab workspaces and snippets. Open sessions in editor tabs (Synapse-style).
      </div>
    </div>
  </div>

  <div id="tab-navigation">
    <button type="button" class="tab active" data-pane="list">
      <i class="fas fa-list"></i> Lab
    </button>
    <button type="button" class="tab" data-pane="snippets">
      <i class="fas fa-wand-magic-sparkles"></i> Snippets
    </button>

    <span class="tab-sep">|</span>

    <button type="button" class="tab-add" id="btnNewNotebook" title="New lab">+</button>

    <div id="openTabs" style="display:flex; gap:24px; align-items:center; flex-wrap:wrap;"></div>
  </div>

  {% if not has_tenant %}
    <div style="margin-top: 14px; color:#64748b;">Select a tenant (organization + super) first.</div>
  {% else %}
    <!-- Notebooks list pane -->
    <div id="pane-list" style="margin-top:14px;">
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title"><i class="fas fa-flask" style="color:#1c96ca;"></i> Lab</div>
          <div class="muted">Stored locally for now. Creator = your session user hash.</div>
        </div>

        <div class="toolbar">
          <div class="searchbox">
            <i class="fas fa-magnifying-glass" style="color:#94a3b8;"></i>
            <input class="form-control form-control-sm" id="nbSearch" placeholder="Search labs by name / creator..." />
          </div>

          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button type="button" class="btn btn-sm btn-azure-outline" id="btnRefreshList">
              <i class="fas fa-rotate"></i> Refresh
            </button>
          </div>
        </div>

        <div style="height:10px;"></div>

        <div class="table-responsive">
          <table class="table table-sm" style="margin-bottom:0;">
            <thead>
              <tr>
                <th style="min-width:240px;">Name</th>
                <th style="min-width:180px;">Creator</th>
                <th style="min-width:190px;">Created</th>
                <th style="min-width:190px;">Updated</th>
                <th style="min-width:240px;">Actions</th>
              </tr>
            </thead>
            <tbody id="nbListBody"></tbody>
          </table>
        </div>

        <div id="nbEmpty" class="muted" style="margin-top:12px; display:none;">
          No labs yet. Click <b>+</b> to create one.
        </div>
      </div>
    </div>

    <!-- Snippets pane -->
    <div id="pane-snippets" class="hidden" style="margin-top:14px;">
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title"><i class="fas fa-wand-magic-sparkles" style="color:#1c96ca;"></i> Snippets</div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button type="button" class="btn btn-sm btn-azure-outline" id="btnNewSnippet">
              <i class="fas fa-plus"></i> New snippet
            </button>
          </div>
        </div>

        <div class="toolbar">
          <div class="searchbox">
            <i class="fas fa-magnifying-glass" style="color:#94a3b8;"></i>
            <input class="form-control form-control-sm" id="snSearch" placeholder="Search snippets by name or content..." />
          </div>
        </div>

        <div id="snGrid" class="sn-grid"></div>

        <div id="snEmpty" class="muted" style="margin-top:12px; display:none;">
          No snippets yet. Click <b>New snippet</b> to create one.
        </div>
      </div>
    </div>

    <!-- Editor pane (shown when an editor tab is active) -->
    <div id="pane-editor" class="hidden" style="margin-top:14px;">
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title"><i class="fas fa-code" style="color:#1c96ca;"></i> Lab editor</div>
          <div class="muted" id="editorStatus"></div>
        </div>

        <!-- Row 1: Run all / Stop -->
        <div class="editor-top">
          <div class="left">
            <input class="form-control form-control-sm nb-name-input" id="nbEditorName" placeholder="Untitled lab" />
            <span class="muted" id="nbEditorMeta"></span>
          </div>
          <div class="right">
            <button type="button" class="btn btn-sm btn-azure-outline" id="btnRunAll">
              <i class="fas fa-play"></i> Run All
            </button>
            <button type="button" class="btn btn-sm btn-danger-outline" id="btnStop">
              <i class="fas fa-stop"></i> Stop
            </button>
          </div>
        </div>

        <!-- Row 2: + / delete / search snippets / run -->
        <div class="editor-subbar">
          <button type="button" class="btn btn-sm btn-azure-outline" id="btnAddCellTop" title="Add cell">
            <i class="fas fa-plus"></i>
          </button>
          <button type="button" class="btn btn-sm btn-danger-outline" id="btnDeleteActiveCell" title="Delete active cell">
            <i class="fas fa-trash"></i>
          </button>
          <button type="button" class="btn btn-sm btn-azure-outline" id="btnSnippetPicker" title="Search snippets">
            <i class="fas fa-magnifying-glass"></i>
          </button>
          <button type="button" class="btn btn-sm btn-azure-outline" id="btnRunActive" title="Run active cell">
            <i class="fas fa-play"></i>
          </button>

          <div style="flex:1;"></div>

          <button type="button" class="btn btn-sm btn-azure-outline" id="btnSaveNotebook">
            <i class="fas fa-save"></i> Save
          </button>
          <button type="button" class="btn btn-sm btn-danger-outline" id="btnCloseTab">
            <i class="fas fa-xmark"></i> Close
          </button>
        </div>

        <div id="cells"></div>
      </div>
    </div>
  {% endif %}
</div>

<div class="toast" id="nbToast"></div>

<!-- Modal -->
<div class="nb-modal" id="nbModal">
  <div class="card">
    <div class="head">
      <div class="title" id="nbModalTitle"><i class="fas fa-pen"></i> Modal</div>
      <button type="button" class="btn btn-sm btn-danger-outline" id="nbModalClose"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="body" id="nbModalBody"></div>
    <div class="actions">
      <button type="button" class="btn btn-sm btn-azure-outline" id="nbModalConfirm"><i class="fas fa-check"></i> Save</button>
    </div>
  </div>
</div>

{% endblock %}

{% block body_scripts %}
<script>
(function () {
  const ln = document.getElementById("link-lab");
  if (ln) ln.classList.add("active");

  function root() { return document.getElementById("nbRoot"); }
  function enc(v) { return encodeURIComponent(v || ""); }
  function cssEsc(v) {
    try { return (window.CSS && CSS.escape) ? CSS.escape(String(v)) : String(v).replace(/[^a-zA-Z0-9_-]/g, '\\$&'); }
    catch (e) { return String(v || ""); }
  }
  function nowISO() { return new Date().toISOString(); }
  function fmt(ts) {
    try { return new Date(ts).toLocaleString(); } catch (e) { return String(ts || ""); }
  }

  function currentCtx() {
    const el = root();
    return {
      org: el ? (el.dataset.org || "") : "",
      sup: el ? (el.dataset.sup || "") : "",
      userHash: el ? (el.dataset.userHash || "") : "",
    };
  }

  function escapeHtml(str) {
    return String(str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function toast(msg) {
    const el = document.getElementById('nbToast');
    if (!el) return;
    el.textContent = String(msg || '');
    el.style.display = 'block';
    clearTimeout(toast._t);
    toast._t = setTimeout(() => { el.style.display = 'none'; }, 1800);
  }

  async function postJSON(url, obj, signal) {
    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(obj || {}),
      credentials: "same-origin",
      signal,
    });
    const text = await resp.text();
    let js = null;
    try { js = JSON.parse(text); } catch (e) { js = null; }
    if (!resp.ok) {
      const msg = (js && (js.detail || js.error)) || text || ("Request failed: " + resp.status);
      throw new Error(msg);
    }
    return js;
  }

  async function getJSON(url, signal) {
    const resp = await fetch(url, { credentials: "same-origin", signal });
    const text = await resp.text();
    let js = null;
    try { js = JSON.parse(text); } catch (e) { js = null; }
    if (!resp.ok) {
      const msg = (js && (js.detail || js.error)) || text || ("Request failed: " + resp.status);
      throw new Error(msg);
    }
    return js;
  }

  function k(prefix) {
    const { org, sup, userHash } = currentCtx();
    return `nb:${org}:${sup}:${userHash}:${prefix}`;
  }

  function lsGet(key, fallback) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw);
    } catch (e) {
      return fallback;
    }
  }
  function lsSet(key, value) {
    try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {}
  }

  function genId(prefix) {
    const rnd = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (String(Math.random()).slice(2) + Date.now());
    return `${prefix}_${rnd}`;
  }

  // -----------------------------
  // Storage models
  // -----------------------------
  function loadNotebooks() {
    let arr = lsGet(k('notebooks'), null);
    if (!Array.isArray(arr)) arr = [];
    return arr;
  }
  function saveNotebooks(arr) { lsSet(k('notebooks'), arr || []); }

  function loadSnippets() {
    let arr = lsGet(k('snippets'), null);
    if (!Array.isArray(arr) || !arr.length) {
      arr = [
        { id:'s_hello', name:'Hello world', code:"print('Hello from SuperTable Lab ðŸš€')", created_at: nowISO(), updated_at: nowISO() },
        { id:'s_read', name:'Read from table', code:"# returns: (df, status, message)\nres = st_read_table('table_1', limit=10)\nres[0].head()", created_at: nowISO(), updated_at: nowISO() },
        { id:'s_sql', name:'SQL query', code:"q = \"\"\"select * from table_1 limit 5\"\"\"\nst_sql(q)[0]", created_at: nowISO(), updated_at: nowISO() },
      ];
      lsSet(k('snippets'), arr);
    }
    return arr;
  }
  function saveSnippets(arr) { lsSet(k('snippets'), arr || []); }

  function kernelSessionKey(scopeId) { return k(`kernel_session:${scopeId}`); }
  function getOrCreateKernelSessionId(scopeId) {
    const kk = kernelSessionKey(scopeId);
    let v = String(lsGet(kk, '') || '');
    if (!v) {
      v = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Math.random()).slice(2);
      lsSet(kk, v);
    }
    return v;
  }

  // -----------------------------
  // UI state
  // -----------------------------
  let notebooks = [];
  let snippets = [];
  let openDocs = []; // editor tabs: { tab_id, notebook_id|null, name, cells, creator, created_at, updated_at, dirty }
  let activePane = "list"; // list | snippets | editor
  let activeTabId = ""; // for editor tabs
  let activeCellId = "";

  // run control
  let stopRequested = false;
  let activeControllers = [];

  function setPane(pane) {
    activePane = pane;
    const listEl = document.getElementById('pane-list');
    const snEl = document.getElementById('pane-snippets');
    const edEl = document.getElementById('pane-editor');

    if (listEl) listEl.classList.toggle('hidden', pane !== 'list');
    if (snEl) snEl.classList.toggle('hidden', pane !== 'snippets');
    if (edEl) edEl.classList.toggle('hidden', pane !== 'editor');

    // highlight base tabs only when in those panes
    document.querySelectorAll('#tab-navigation .tab[data-pane]').forEach(t => {
      const p = t.getAttribute('data-pane');
      t.classList.toggle('active', (p === pane));
    });
    if (pane === 'editor') {
      // base tabs not active
      document.querySelectorAll('#tab-navigation .tab[data-pane]').forEach(t => t.classList.remove('active'));
    }
  }

  function renderOpenTabs() {
    const wrap = document.getElementById('openTabs');
    if (!wrap) return;
    wrap.innerHTML = '';

    openDocs.forEach(doc => {
      const box = document.createElement('div');
      box.className = 'tab-doc';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'tab' + (doc.tab_id === activeTabId ? ' active' : '');
      const dot = doc.dirty ? ' â€¢' : '';
      btn.innerHTML = `<i class="fas fa-book"></i><span>${escapeHtml(doc.name || 'Untitled')}${dot}</span>`;
      btn.addEventListener('click', () => activateEditorTab(doc.tab_id));

      const close = document.createElement('button');
      close.type = 'button';
      close.className = 'tab-close';
      close.title = 'Close';
      close.innerHTML = '<i class="fas fa-xmark"></i>';
      close.addEventListener('click', (e) => {
        e.stopPropagation();
        closeEditorTab(doc.tab_id);
      });

      box.appendChild(btn);
      box.appendChild(close);
      wrap.appendChild(box);
    });
  }

  function renderNotebookList() {
    const body = document.getElementById('nbListBody');
    const empty = document.getElementById('nbEmpty');
    if (!body) return;

    const q = String((document.getElementById('nbSearch') || {}).value || '').trim().toLowerCase();
    const rows = notebooks.filter(n => {
      const hay = `${n.name||''} ${n.creator||''}`.toLowerCase();
      return !q || hay.includes(q);
    });

    body.innerHTML = '';
    rows.forEach(n => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b>${escapeHtml(n.name || 'Untitled')}</b></td>
        <td class="mono">${escapeHtml(String(n.creator || '').slice(0, 18))}</td>
        <td>${escapeHtml(fmt(n.created_at))}</td>
        <td>${escapeHtml(fmt(n.updated_at || n.created_at))}</td>
        <td>
          <button type="button" class="btn btn-sm btn-azure-outline" data-act="open"><i class="fas fa-up-right-from-square"></i> Open</button>
          <button type="button" class="btn btn-sm btn-danger-outline" data-act="delete"><i class="fas fa-trash"></i> Delete</button>
        </td>
      `;
      tr.querySelector('button[data-act="open"]').addEventListener('click', () => openNotebookInTab(n.id));
      tr.querySelector('button[data-act="delete"]').addEventListener('click', () => deleteNotebook(n.id));
      body.appendChild(tr);
    });

    if (empty) empty.style.display = rows.length ? 'none' : '';
  }

  function deleteNotebook(id) {
    const nb = notebooks.find(x => x.id === id);
    const name = nb ? nb.name : 'this lab';
    if (!confirm(`Delete ${name}?`)) return;

    notebooks = notebooks.filter(x => x.id !== id);
    saveNotebooks(notebooks);

    // also close any open tabs for it
    const toClose = openDocs.filter(d => d.notebook_id === id).map(d => d.tab_id);
    toClose.forEach(tid => closeEditorTab(tid, { skipConfirm: true }));

    renderNotebookList();
    toast('Lab deleted');
  }

  function openNotebookInTab(id) {
    const nb = notebooks.find(x => x.id === id);
    if (!nb) return;

    const existing = openDocs.find(d => d.notebook_id === id);
    if (existing) {
      activateEditorTab(existing.tab_id);
      return;
    }

    const tab = {
      tab_id: genId('tab'),
      notebook_id: nb.id,
      name: nb.name || 'Untitled',
      cells: Array.isArray(nb.cells) && nb.cells.length ? nb.cells.map(c => ({ id: c.id || genId('c'), code: c.code || '' })) : [{ id: genId('c'), code: '' }],
      creator: nb.creator || '',
      created_at: nb.created_at,
      updated_at: nb.updated_at || nb.created_at,
      dirty: false,
    };
    openDocs.push(tab);
    activateEditorTab(tab.tab_id);
    renderOpenTabs();
  }

  function activateEditorTab(tabId) {
    const doc = openDocs.find(d => d.tab_id === tabId);
    if (!doc) return;

    activeTabId = tabId;
    activeCellId = (doc.cells && doc.cells[0]) ? doc.cells[0].id : '';

    // show editor and populate fields
    const name = document.getElementById('nbEditorName');
    const meta = document.getElementById('nbEditorMeta');
    if (name) name.value = doc.name || '';
    if (meta) {
      const who = doc.creator ? String(doc.creator).slice(0, 18) : '';
      meta.textContent = `creator: ${who} â€¢ created: ${fmt(doc.created_at)}${doc.notebook_id ? '' : ' â€¢ (unsaved)'}`;
    }

    setPane('editor');
    renderOpenTabs();
    renderCells();
  }

  function closeEditorTab(tabId, opts) {
    const o = opts || {};
    const doc = openDocs.find(d => d.tab_id === tabId);
    if (!doc) return;

    if (!o.skipConfirm && doc.dirty) {
      if (!confirm('This lab has unsaved changes. Close anyway?')) return;
    }

    openDocs = openDocs.filter(d => d.tab_id !== tabId);

    if (activeTabId === tabId) {
      activeTabId = openDocs.length ? openDocs[openDocs.length - 1].tab_id : '';
      if (activeTabId) activateEditorTab(activeTabId);
      else setPane('list');
    }

    renderOpenTabs();
    toast('Tab closed');
  }

  function createNewNotebookTab() {
    const { userHash } = currentCtx();
    const tab = {
      tab_id: genId('tab'),
      notebook_id: null,
      name: `Untitled ${openDocs.length + 1}`,
      cells: [{ id: genId('c'), code: "print('Ready. Add a cell or insert a snippet â†’')" }],
      creator: userHash || '',
      created_at: nowISO(),
      updated_at: nowISO(),
      dirty: true,
    };
    openDocs.push(tab);
    activateEditorTab(tab.tab_id);
    renderOpenTabs();
    toast('New lab tab opened');
  }

  function getActiveDoc() {
    return openDocs.find(d => d.tab_id === activeTabId) || null;
  }

  // -----------------------------
  // Editor: cells
  // -----------------------------
  function createCellEl(cell, idx) {
    const el = document.createElement('div');
    el.className = 'cell';
    el.dataset.id = cell.id;

    el.innerHTML = `
      <div class="cell-head">
        <div class="cell-left">
          <span class="mono">In [${idx + 1}]</span>
          <span class="muted" id="status-${escapeHtml(cell.id)}"></span>
        </div>
        <div class="cell-actions">
          <button type="button" class="btn btn-sm btn-azure-outline" data-action="run"><i class="fas fa-play"></i> Run</button>
          <button type="button" class="btn btn-sm btn-azure-outline" data-action="add-below" title="Add cell below"><i class="fas fa-plus"></i></button>
          <button type="button" class="btn btn-sm btn-danger-outline" data-action="delete" title="Delete cell"><i class="fas fa-trash"></i></button>
        </div>
      </div>
      <div class="cell-body">
        <textarea class="codebox mono" spellcheck="false"></textarea>
        <div class="output mono" id="out-${escapeHtml(cell.id)}"></div>
      </div>
    `;

    const ta = el.querySelector('textarea');
    if (ta) {
      ta.value = cell.code || '';
      ta.addEventListener('focus', () => { activeCellId = cell.id; });
      ta.addEventListener('input', () => {
        const doc = getActiveDoc();
        if (!doc) return;
        const found = doc.cells.find(c => c.id === cell.id);
        if (found) found.code = ta.value;
        markDirty(doc);
      });
      ta.addEventListener('keydown', async (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          await runCell(cell.id);
        }
      });
    }

    el.addEventListener('click', () => { activeCellId = cell.id; });

    el.querySelectorAll('button[data-action]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const action = btn.getAttribute('data-action');
        if (action === 'run') await runCell(cell.id);
        if (action === 'add-below') addCellBelow(cell.id);
        if (action === 'delete') deleteCell(cell.id);
      });
    });

    return el;
  }

  function renderCells() {
    const wrap = document.getElementById('cells');
    const doc = getActiveDoc();
    if (!wrap || !doc) return;

    wrap.innerHTML = '';
    doc.cells.forEach((c, i) => wrap.appendChild(createCellEl(c, i)));
    if (!activeCellId && doc.cells.length) activeCellId = doc.cells[0].id;
  }

  function addCellBelow(id) {
    const doc = getActiveDoc();
    if (!doc) return;
    const i = doc.cells.findIndex(c => c.id === id);
    const item = { id: genId('c'), code: '' };
    if (i >= 0) doc.cells.splice(i + 1, 0, item);
    else doc.cells.push(item);
    activeCellId = item.id;
    markDirty(doc);
    renderCells();
    setTimeout(() => {
      const el = document.querySelector(`.cell[data-id="${cssEsc(item.id)}"] textarea`);
      if (el) el.focus();
    }, 30);
  }

  function addCellEnd() {
    const doc = getActiveDoc();
    if (!doc) return;
    const item = { id: genId('c'), code: '' };
    doc.cells.push(item);
    activeCellId = item.id;
    markDirty(doc);
    renderCells();
    setTimeout(() => {
      const el = document.querySelector(`.cell[data-id="${cssEsc(item.id)}"] textarea`);
      if (el) el.focus();
    }, 30);
  }

  function deleteCell(id) {
    const doc = getActiveDoc();
    if (!doc) return;
    if (doc.cells.length <= 1) return;

    doc.cells = doc.cells.filter(c => c.id !== id);
    if (activeCellId === id) activeCellId = doc.cells[0].id;
    markDirty(doc);
    renderCells();
  }

  function deleteActiveCell() {
    const doc = getActiveDoc();
    if (!doc) return;
    if (!activeCellId) return;
    deleteCell(activeCellId);
  }

  // -----------------------------
  // Snippet picker / insert
  // -----------------------------
  function insertSnippet(code) {
    const doc = getActiveDoc();
    if (!doc) return;

    const id = activeCellId || (doc.cells[0] && doc.cells[0].id) || '';
    if (!id) return;
    const cell = doc.cells.find(c => c.id === id);
    if (!cell) return;

    const el = document.querySelector(`.cell[data-id="${cssEsc(id)}"] textarea`);
    const snippet = String(code || '');
    if (el) {
      const start = el.selectionStart || 0;
      const end = el.selectionEnd || 0;
      const before = el.value.slice(0, start);
      const after = el.value.slice(end);
      const join = (before && !before.endsWith('\n')) ? '\n' : '';
      el.value = before + join + snippet + '\n' + after;
      el.selectionStart = el.selectionEnd = (before + join + snippet + '\n').length;
      el.focus();
      cell.code = el.value;
    } else {
      cell.code = (cell.code || '') + '\n' + snippet + '\n';
    }
    markDirty(doc);
  }

  function showModal(title, bodyHtml, onConfirm) {
    const wrap = document.getElementById('nbModal');
    const t = document.getElementById('nbModalTitle');
    const b = document.getElementById('nbModalBody');
    const c = document.getElementById('nbModalConfirm');
    const x = document.getElementById('nbModalClose');

    if (!wrap || !t || !b || !c || !x) return;

    t.innerHTML = title || 'Modal';
    b.innerHTML = bodyHtml || '';
    wrap.style.display = 'flex';

    const close = () => {
      wrap.style.display = 'none';
      c.onclick = null;
    };
    x.onclick = close;
    wrap.onclick = (e) => { if (e.target === wrap) close(); };

    c.onclick = async (e) => {
      e.preventDefault();
      try {
        if (onConfirm) await onConfirm();
        close();
      } catch (err) {
        toast(String(err && err.message ? err.message : err));
      }
    };
  }

  function openSnippetPicker() {
    const q = `
      <div class="muted" style="margin-bottom:8px;">Search snippets and click one to insert into the active cell.</div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <input id="pickQ" class="form-control form-control-sm" placeholder="Search..." />
        <button type="button" class="btn btn-sm btn-azure-outline" id="btnPickNew"><i class="fas fa-plus"></i> New</button>
      </div>
      <div style="height:10px;"></div>
      <div id="pickList" style="display:flex; flex-direction:column; gap:10px;"></div>
    `;
    showModal('<i class="fas fa-magnifying-glass"></i> Snippets', q, null);

    const input = document.getElementById('pickQ');
    const list = document.getElementById('pickList');
    const btnNew = document.getElementById('btnPickNew');

    function renderPick() {
      if (!list) return;
      const qq = String((input || {}).value || '').trim().toLowerCase();
      const rows = snippets.filter(s => {
        const hay = `${s.name||''}\n${s.code||''}`.toLowerCase();
        return !qq || hay.includes(qq);
      });

      list.innerHTML = '';
      if (!rows.length) {
        list.innerHTML = '<div class="muted">No matches.</div>';
        return;
      }

      rows.slice(0, 50).forEach(s => {
        const div = document.createElement('div');
        div.className = 'sn-card';
        div.style.cursor = 'pointer';
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="name"><i class="fas fa-wand-magic-sparkles" style="color:#1c96ca; margin-right:6px;"></i>${escapeHtml(s.name||'Snippet')}</div>
              <div class="muted" style="margin-top:4px;">${escapeHtml((s.code||'').slice(0, 140))}${(s.code||'').length>140?'â€¦':''}</div>
            </div>
            <div>
              <button type="button" class="btn btn-sm btn-azure-outline" data-act="copy"><i class="fas fa-copy"></i></button>
            </div>
          </div>
        `;
        div.addEventListener('click', (e) => {
          // ignore copy button click
          if (e && e.target && (e.target.closest && e.target.closest('button[data-act="copy"]'))) return;
          insertSnippet(s.code || '');
          toast('Inserted snippet');
        });
        div.querySelector('button[data-act="copy"]').addEventListener('click', async (e) => {
          e.preventDefault();
          await copyToClipboard(String(s.code||''));
          toast('Copied');
        });
        list.appendChild(div);
      });
    }

    if (input) input.addEventListener('input', renderPick);
    if (btnNew) btnNew.addEventListener('click', (e) => { e.preventDefault(); openSnippetModal(); });
    renderPick();
    setTimeout(() => { if (input) input.focus(); }, 50);
  }

  async function copyToClipboard(text) {
    const t = String(text || '');
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(t);
        return true;
      }
    } catch (e) {}
    const ta = document.createElement('textarea');
    ta.value = t;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try { document.execCommand('copy'); } catch (e) {}
    document.body.removeChild(ta);
    return true;
  }

  // -----------------------------
  // Snippets CRUD
  // -----------------------------
  function renderSnippets() {
    const grid = document.getElementById('snGrid');
    const empty = document.getElementById('snEmpty');
    if (!grid) return;

    const q = String((document.getElementById('snSearch') || {}).value || '').trim().toLowerCase();
    const rows = snippets.filter(s => {
      const hay = `${s.name||''}\n${s.code||''}`.toLowerCase();
      return !q || hay.includes(q);
    });

    grid.innerHTML = '';
    rows.forEach(s => {
      const card = document.createElement('div');
      card.className = 'sn-card';
      card.innerHTML = `
        <div class="top">
          <div>
            <div class="name">${escapeHtml(s.name || 'Snippet')}</div>
            <div class="muted" style="margin-top:4px;">updated: ${escapeHtml(fmt(s.updated_at || s.created_at))}</div>
          </div>
        </div>
        <pre class="mono">${escapeHtml((s.code || '').slice(0, 900))}${(s.code||'').length>900 ? '\nâ€¦' : ''}</pre>
        <div class="sn-actions">
          <button type="button" class="btn btn-sm btn-azure-outline" data-act="copy"><i class="fas fa-copy"></i> Copy</button>
          <button type="button" class="btn btn-sm btn-azure-outline" data-act="edit"><i class="fas fa-pen"></i> Edit</button>
          <button type="button" class="btn btn-sm btn-danger-outline" data-act="del"><i class="fas fa-trash"></i> Delete</button>
        </div>
      `;
      card.querySelector('button[data-act="copy"]').addEventListener('click', async () => {
        await copyToClipboard(String(s.code || ''));
        toast('Copied');
      });
      card.querySelector('button[data-act="edit"]').addEventListener('click', () => openSnippetModal(s));
      card.querySelector('button[data-act="del"]').addEventListener('click', () => deleteSnippet(s.id));
      grid.appendChild(card);
    });

    if (empty) empty.style.display = rows.length ? 'none' : '';
  }

  function deleteSnippet(id) {
    if (!confirm('Delete this snippet?')) return;
    snippets = snippets.filter(s => s.id !== id);
    saveSnippets(snippets);
    renderSnippets();
    toast('Snippet deleted');
  }

  function openSnippetModal(existing) {
    const s = existing || null;
    const title = s ? '<i class="fas fa-pen"></i> Edit snippet' : '<i class="fas fa-plus"></i> New snippet';
    const body = `
      <div class="form-group" style="margin-bottom:10px;">
        <label class="muted" style="font-size:12px;">Name</label>
        <input id="snName" class="form-control form-control-sm" value="${escapeHtml(s ? (s.name||'') : '')}" placeholder="My snippet" />
      </div>
      <div class="form-group" style="margin-bottom:10px;">
        <label class="muted" style="font-size:12px;">Code</label>
        <textarea id="snCode" class="form-control form-control-sm mono" rows="12" placeholder="print('hello')">${escapeHtml(s ? (s.code||'') : '')}</textarea>
      </div>
    `;
    showModal(title, body, async () => {
      const name = String((document.getElementById('snName')||{}).value || '').trim();
      const code = String((document.getElementById('snCode')||{}).value || '').trim();
      if (!name) throw new Error('Name is required');
      if (!code) throw new Error('Code is required');

      if (s) {
        s.name = name;
        s.code = code;
        s.updated_at = nowISO();
        snippets = snippets.map(x => x.id === s.id ? s : x);
      } else {
        snippets.unshift({ id: genId('sn'), name, code, created_at: nowISO(), updated_at: nowISO() });
      }
      saveSnippets(snippets);
      renderSnippets();
      toast('Snippet saved');
    });
  }

  // -----------------------------
  // Save notebook
  // -----------------------------
  function markDirty(doc) {
    doc.dirty = true;
    doc.updated_at = nowISO();
    renderOpenTabs();
  }

  function saveActiveNotebook() {
    const { userHash } = currentCtx();
    const doc = getActiveDoc();
    if (!doc) return;

    const nameVal = String((document.getElementById('nbEditorName')||{}).value || '').trim() || 'Untitled';
    doc.name = nameVal;

    if (!doc.notebook_id) {
      // first save: create a new notebook entry
      const id = genId('nb');
      const nb = {
        id,
        name: doc.name,
        creator: userHash || doc.creator || '',
        created_at: doc.created_at || nowISO(),
        updated_at: nowISO(),
        cells: doc.cells.map(c => ({ id: c.id, code: c.code })),
      };
      notebooks.unshift(nb);
      saveNotebooks(notebooks);

      doc.notebook_id = id;
      doc.creator = nb.creator;
      doc.created_at = nb.created_at;
      doc.updated_at = nb.updated_at;
      doc.dirty = false;

      renderNotebookList();
      activateEditorTab(doc.tab_id);
      toast('Lab saved');
      return;
    }

    // update existing
    notebooks = notebooks.map(n => {
      if (n.id !== doc.notebook_id) return n;
      return {
        ...n,
        name: doc.name,
        updated_at: nowISO(),
        cells: doc.cells.map(c => ({ id: c.id, code: c.code })),
      };
    });
    saveNotebooks(notebooks);

    doc.dirty = false;
    doc.updated_at = nowISO();
    renderNotebookList();
    renderOpenTabs();
    toast('Lab updated');
  }

  // -----------------------------
  // Run cells
  // -----------------------------
  function setOutput(cellId, ok, stdout, stderr, meta) {
    const box = document.getElementById(`out-${cellId}`);
    if (!box) return;
    const o = String(stdout || '');
    const e = String(stderr || '');
    const m = meta ? String(meta) : '';
    const has = (o.trim() || e.trim() || m.trim());
    box.style.display = has ? '' : 'none';
    box.className = 'output mono ' + (ok ? 'ok' : 'err');
    box.innerHTML = `
      ${m ? `<div class="muted" style="margin-bottom:8px;">${escapeHtml(m)}</div>` : ``}
      ${o ? `<div><div class="muted" style="margin-bottom:4px;">stdout</div><pre>${escapeHtml(o)}</pre></div>` : ``}
      ${e ? `<div style="margin-top:10px;"><div class="muted" style="margin-bottom:4px;">stderr</div><pre>${escapeHtml(e)}</pre></div>` : ``}
    `;
  }

  function setStatus(cellId, txt) {
    const el = document.getElementById(`status-${cellId}`);
    if (el) el.textContent = txt || '';
  }

  function stopAllRuns() {
    stopRequested = true;
    activeControllers.forEach(c => { try { c.abort(); } catch (e) {} });
    activeControllers = [];
    toast('Stopped (client-side)');
    // allow new runs
    setTimeout(() => { stopRequested = false; }, 200);
  }

  async function runCell(cellId) {
    const { org, sup, userHash } = currentCtx();
    if (!org || !sup) { alert('Select a tenant first.'); return; }
    if (!userHash) { alert('Missing user hash (session). Please re-login.'); return; }

    const doc = getActiveDoc();
    if (!doc) return;
    const cell = doc.cells.find(c => c.id === cellId);
    if (!cell) return;

    const code = String(cell.code || '').trim();
    if (!code) return;

    const controller = new AbortController();
    activeControllers.push(controller);

    const sessionScope = doc.notebook_id || doc.tab_id;
    const sessionId = getOrCreateKernelSessionId(sessionScope);

    const start = performance.now();
    setStatus(cellId, 'runningâ€¦');
    setOutput(cellId, true, '', '', '');

    const metaTick = setInterval(() => {
      const ms = performance.now() - start;
      setStatus(cellId, `running â€¢ ${(ms/1000).toFixed(3)}s`);
    }, 60);

    try {
      if (stopRequested) return;

      const created = await postJSON('/reflection/lab/jobs', {
        org, sup, user_hash: userHash,
        code,
        session_id: sessionId,
      }, controller.signal);

      const jobId = created && created.job_id ? String(created.job_id) : '';
      if (!jobId) throw new Error('Missing job_id');

      while (true) {
        if (stopRequested) return;
        const js = await getJSON(`/reflection/lab/jobs/${enc(jobId)}`, controller.signal);
        const job = js && js.job ? js.job : null;
        if (!job) throw new Error('Job not found');
        const st = String(job.status || '');
        if (st === 'queued' || st === 'running') {
          await new Promise(r => setTimeout(r, 250));
          continue;
        }

        const dur = (job.duration_ms !== undefined && job.duration_ms !== null) ? Number(job.duration_ms) : null;
        const meta = (dur !== null && Number.isFinite(dur))
          ? `Server: ${dur.toFixed(3)} ms â€¢ Client: ${(performance.now()-start).toFixed(1)} ms`
          : `Client: ${(performance.now()-start).toFixed(1)} ms`;

        if (st === 'done') {
          setStatus(cellId, 'done');
          setOutput(cellId, true, job.stdout || '', job.stderr || '', meta);
          break;
        }
        if (st === 'error') {
          setStatus(cellId, 'error');
          const msg = job.error ? String(job.error) : 'Execution failed';
          const stderr = (job.stderr ? String(job.stderr) : '');
          setOutput(cellId, false, job.stdout || '', stderr || msg, meta);
          break;
        }
        setStatus(cellId, st);
        break;
      }
    } catch (e) {
      if (String(e && e.name) === 'AbortError') {
        setStatus(cellId, 'stopped');
        setOutput(cellId, false, '', 'Stopped (client-side)', '');
      } else {
        setStatus(cellId, 'error');
        setOutput(cellId, false, '', String(e && e.message ? e.message : e), '');
      }
    } finally {
      clearInterval(metaTick);
      activeControllers = activeControllers.filter(x => x !== controller);
    }
  }

  async function runActiveCell() {
    const doc = getActiveDoc();
    if (!doc) return;
    const id = activeCellId || (doc.cells[0] && doc.cells[0].id) || '';
    if (!id) return;
    await runCell(id);
  }

  async function runAll() {
    const doc = getActiveDoc();
    if (!doc) return;
    for (const c of doc.cells) {
      if (stopRequested) return;
      const code = String(c.code || '').trim();
      if (code) await runCell(c.id);
    }
  }

  // -----------------------------
  // Wire UI
  // -----------------------------
  function wireBaseTabs() {
    document.querySelectorAll('#tab-navigation .tab[data-pane]').forEach(t => {
      t.addEventListener('click', () => {
        const p = t.getAttribute('data-pane');
        if (!p) return;
        setPane(p);
      });
    });

    const btnNew = document.getElementById('btnNewNotebook');
    if (btnNew) btnNew.addEventListener('click', createNewNotebookTab);

    const btnRefresh = document.getElementById('btnRefreshList');
    if (btnRefresh) btnRefresh.addEventListener('click', () => { notebooks = loadNotebooks(); renderNotebookList(); });

    const nbSearch = document.getElementById('nbSearch');
    if (nbSearch) nbSearch.addEventListener('input', renderNotebookList);

    const snSearch = document.getElementById('snSearch');
    if (snSearch) snSearch.addEventListener('input', renderSnippets);

    const btnNewSnippet = document.getElementById('btnNewSnippet');
    if (btnNewSnippet) btnNewSnippet.addEventListener('click', () => openSnippetModal(null));

    const btnAddCellTop = document.getElementById('btnAddCellTop');
    if (btnAddCellTop) btnAddCellTop.addEventListener('click', addCellEnd);

    const btnDelActive = document.getElementById('btnDeleteActiveCell');
    if (btnDelActive) btnDelActive.addEventListener('click', deleteActiveCell);

    const btnPick = document.getElementById('btnSnippetPicker');
    if (btnPick) btnPick.addEventListener('click', openSnippetPicker);

    const btnRunA = document.getElementById('btnRunActive');
    if (btnRunA) btnRunA.addEventListener('click', runActiveCell);

    const btnRunAll = document.getElementById('btnRunAll');
    if (btnRunAll) btnRunAll.addEventListener('click', runAll);

    const btnStop = document.getElementById('btnStop');
    if (btnStop) btnStop.addEventListener('click', stopAllRuns);

    const btnSave = document.getElementById('btnSaveNotebook');
    if (btnSave) btnSave.addEventListener('click', saveActiveNotebook);

    const btnClose = document.getElementById('btnCloseTab');
    if (btnClose) btnClose.addEventListener('click', () => closeEditorTab(activeTabId));

    const nameInput = document.getElementById('nbEditorName');
    if (nameInput) {
      nameInput.addEventListener('input', () => {
        const doc = getActiveDoc();
        if (!doc) return;
        doc.name = String(nameInput.value || '');
        markDirty(doc);
      });
    }
  }

  // Tenant change: redirect and keep on notebooks page
  window.addEventListener("supertable-changed", function(e) {
    const detail = (e && e.detail) ? e.detail : {};
    const org = detail.org || "";
    const sup = detail.sup || "";
    const u = new URL(window.location.href);
    u.pathname = "/reflection/lab";
    u.searchParams.set("org", org);
    u.searchParams.set("sup", sup);
    window.location.href = u.toString();
  });

  // Init
  notebooks = loadNotebooks();
  snippets = loadSnippets();

  wireBaseTabs();
  renderOpenTabs();
  renderNotebookList();
  renderSnippets();
  setPane('list');

})();
</script>
{% endblock %}
