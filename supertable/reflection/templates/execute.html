<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SuperTable – Execute SQL</title>

  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /*
     * Professional Styling Refinements for Execute SQL page
     * Focus: Cleanliness, Readability, Hierarchy, and Eye-Catching Execute Button.
     * Colors maintained from existing palette.
     */
    :root {
      --primary-color: #1c96ca;
      --primary-light: #e6f4fa;
      --secondary-color: #147ba3;
      --dark-color: #1a1a2e;
      --light-color: #f8f9fa;
      --text-color: #2b2d42;
      --text-light: #8d99ae;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      --panel-bg: #ffffff;
      --panel-border: #e0e5f0;
      --panel-shadow: 0 8px 20px rgba(15, 23, 42, 0.05); /* Softer shadow */
      --header-bg: #f8fafc;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f3f6fb;
      color: var(--text-color);
      line-height: 1.5; /* Improved readability */
    }

    a {
      color: var(--primary-color);
      text-decoration: none;
    }
    a:hover { text-decoration: underline; }

    /* ------------ MAIN CONTENT ------------ */

    .content-container {
      margin-left: 280px;
      min-height: 100vh;
      background-color: #f3f6fb;
      transition: var(--transition);
      padding-bottom: 0px;
    }

    .sidebar-collapsed ~ .content-container {
      margin-left: 80px;
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0px;
    }

    .card {
      background: var(--panel-bg);
      border-radius: 12px; /* Professional size */
      box-shadow: var(--panel-shadow);
      border: 1px solid var(--panel-border);
    }

    .section { padding: 20px 24px; } /* Increased padding */
    .muted { color: var(--text-light); }
    .text-xs { font-size: 11px; }
    .text-sm { font-size: 13px; } /* Slightly larger base text */

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px; /* Increased gap */
      align-items: flex-start;
    }

    /* --- Tab Navigation --- */
    #tab-navigation {
        display: flex;
        gap: 0; /* Tabs should touch */
        border-bottom: 2px solid var(--panel-border);
        margin-bottom: 16px;
        margin-top: 16px;
        padding-left: 8px; /* Slight left padding to match wrapper spacing */
    }

    .tab {
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-light);
        cursor: pointer;
        transition: color 0.2s, border-bottom 0.2s;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px; /* Pulls the border up to overlap the container border */
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .tab:hover {
        color: var(--primary-color);
    }

    .tab.active {
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        font-weight: 600;
    }

    .chip {
        background: #e0e5f0;
        color: var(--text-color);
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
    }

    .tab.active .chip {
        background: var(--primary-color);
        color: white;
    }

    /* --- Tab Content Containers --- */
    .tab-content {
        display: none;
    }
    /* Only the active content should be block/visible, this is handled in JS */
    .tab-content.active {
        display: block;
    }

    /* FIX: The card margin in the tab-content should be 0 or small */
    #tab-content-container .card {
        margin-top: 0 !important;
    }

    /* --- Execute Card Styling (Simplified from Header) --- */
    .sql-editor-card .card-body {
        padding: 24px;
    }

    /* --- Form Elements (Base Styles) --- */

    input, select, textarea {
      background: #ffffff;
      border: 1px solid #d0d7e7;
      color: var(--text-color);
      border-radius: 8px; /* Sharper radius */
      padding: 8px 12px;
      font-size: 13px;
      width: 100%;
      transition: var(--transition);
      margin-top: 4px; /* Space below label */
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px var(--primary-light); /* Use primary-light for soft focus ring */
      border-color: var(--primary-color);
    }

    textarea { resize: vertical; min-height: 140px; } /* Slightly taller default */

    /* --- SuperTable Selector Custom Style FIX --- */
    #pairSel {
      /* FIX 1: Overrides global `width: auto` to ensure 100% of parent width */
      width: 100% !important;
      display: block;
      margin-top: 0;

      /* FIX 2: Apply user's desired sizing, overriding generic form styles */
      padding: 10px 12px !important;
      font-size: 16px !important;
      height: auto !important;

      /* FIX 3: Apply custom arrow styles */
      appearance: none;
      -webkit-appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Cpath%20d%3D%22M4%207L10%2013L16%207%22%20stroke%3D%22%23475569%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%0A%3C%2Fpath%3E%0A%3C%2Fsvg%3E');
      background-repeat: no-repeat;
      background-position: right 10px center;
      cursor: pointer; /* Ensure cursor is applied */
      background-color: #ffffff; /* Ensure background is applied */
    }

    /* --- Buttons (Standard) --- */
    .btn {
      padding: 8px 12px;
      border-radius: 8px;
      background: var(--dark-color);
      border: 1px solid var(--dark-color);
      color: #e2e8f0;
      font-weight: 500;
      cursor: pointer;
      font-size: 13px;
      transition: var(--transition);
    }

    .btn:hover {
        filter: brightness(1.1);
        box-shadow: 0 4px 10px rgba(26, 26, 46, 0.2);
    }

    /* --- CodeMirror styling (INCREASED HEIGHT to 500px) --- */
    .CodeMirror {
      border-radius: 8px; /* Match form elements */
      border: 1px solid #d0d7e7;
      background: #ffffff;
      color: #0b1220;
      font-size: 14px; /* Slightly larger code font */
      min-height: 500px; /* Taller editor */
    }

    .CodeMirror-focused {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    /* --- Eye-Catching Execute Button --- */
    .btn-exec {
      color: white;
      background: var(--primary-color);
      border: 1px solid var(--primary-color);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 6px 20px rgba(28, 150, 202, 0.25);
      transition: transform .1s ease, box-shadow .2s ease, background-color .2s ease;
      white-space: nowrap;
    }
    .btn-exec:hover {
        background: var(--secondary-color);
        border-color: var(--secondary-color);
        box-shadow: 0 8px 25px rgba(28, 150, 202, 0.4);
    }
    .btn-exec:active { transform: translateY(1px); }

    /* --- Status Bar --- */
    #status {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    #status i { color: #10b981; }
    #status.executing i { color: #f59e0b; animation: spin 1s linear infinite; }
    #status.error i { color: #ef4444; }

    @keyframes spin {
      0% { transform:rotate(0deg); }
      100% { transform:rotate(360deg); }
    }

    /* --- Error Block --- */
    #query-error-display {
        background-color: #fee2e2;
        color: #b91c1c;
        border: 1px solid #fca5a5;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
        display: none; /* Hidden by default, JS controls visibility */
        font-weight: 500;
        font-size: 14px;
    }
    #query-error-display strong {
        font-weight: 700;
        margin-right: 8px;
    }
    #query-error-message {
        font-family: monospace;
        background-color: #fecaca;
        padding: 8px;
        border-radius: 4px;
        display: block;
        margin-top: 8px;
        white-space: pre-wrap;
        word-break: break-all;
    }

    /* --- Visualization --- */
    #timings-visualization-card {
        /* Set a fixed height for the canvas to ensure Chart.js renders correctly */
        height: 350px;
        display: none; /* Hidden by default, JS controls visibility */
    }
    .chart-container {
        position: relative;
        height: 100%;
        width: 100%;
        padding: 20px;
    }
    /* Ensure canvas is block-level and max size of container for Chart.js responsiveness */
    .chart-container canvas {
        height: 100% !important;
        width: 100% !important;
    }


    /* --- Results Table --- */
    #result table {
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
      border: 1px solid var(--panel-border);
      border-radius: 8px;
      overflow: hidden;
    }

    #result th, #result td {
      padding: 10px 15px;
      border:none;
      border-right: 1px solid #e2e8f0;
    }

    #result td:last-child {
        border-right: none;
    }

    #result thead th {
      position: sticky;
      top: 0;
      background: #f1f5f9;
      z-index: 1;
      font-weight: 600;
      color: #4b5563;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.05em;
      border-bottom: 2px solid #e2e8f0;
    }

    #result tbody tr td {
        border-bottom: 1px solid #f1f5f9;
    }

    #result tbody tr:last-child td {
        border-bottom: none;
    }

    #result tr:nth-child(even) td {
      background: #f9fafb;
    }

    #result tr:hover td {
      background: #e6f4fa;
    }

    #result .row-index {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: #64748b;
      font-weight: 500;
    }

    /* --- Download/Copy Row --- */
    .download-row {
      margin-top: 16px;
      text-align: right;
      display: flex;
      justify-content: flex-end;
      gap: 8px; /* Space between buttons */
    }

    .btn-clipboard {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--dark-color);
      background: var(--dark-color);
      color: #e2e8f0;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: var(--transition);
    }
    .btn-clipboard:hover {
        filter: brightness(1.1);
        box-shadow: 0 4px 10px rgba(26, 26, 46, 0.2);
    }
    .btn-download {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--dark-color);
      background: var(--dark-color);
      color: #e2e8f0;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: var(--transition);
    }
    .btn-download:hover {
        filter: brightness(1.1);
        box-shadow: 0 4px 10px rgba(26, 26, 46, 0.2);
    }


    /* --- Shared metric / summary styles --- */
    .metric-card {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 10px;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      min-height: 70px;
      transition: box-shadow 0.2s;
    }

    .metric-card:hover {
        box-shadow: 0 4px 15px rgba(28, 150, 202, 0.08);
    }

    .metric-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      background: var(--primary-light);
      color: var(--primary-color);
      flex-shrink: 0;
      font-size: 16px;
    }

    .metric-content {
      display: flex;
      flex-direction: column;
    }

    .metric-label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-weight: 600;
    }

    .metric-value {
      font-size: 16px;
      font-weight: 700;
      margin-top: 4px;
      color: #111827;
    }

    .tenant-summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .tenant-updated {
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
      text-align: right;
    }

    /* Optional: style hints dropdown a bit */
    .CodeMirror-hints {
      z-index: 9999;
      font-family: 'Fira Code', 'Consolas', monospace;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: none;
      background: #ffffff;
    }
    .CodeMirror-hint {
      padding: 6px 12px;
      color: #111827;
      transition: all 0.2s ease;
    }
    .CodeMirror-hint-active {
      background: var(--primary-color);
      color: white;
    }
  </style>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js">
  </script>

  <script>
    // --- Utility to parse URL parameters ---
    function getURLParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      const results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    // --- Shared admin API helper ---
    function api(path, opts) {
      opts = opts || {};
      opts.headers = opts.headers || {};
      if (window.__admintoken) opts.headers['X-Admin-Token'] = window.__admintoken;
      return fetch(path, opts).then(async res => {
        const ct = res.headers.get('content-type') || '';
        const payload = ct.includes('application/json')
          ? await res.json()
          : await res.text();
        if (!res.ok) {
          const msg = typeof payload === 'string' ? payload : JSON.stringify(payload);
          throw new Error(msg);
        }
        return payload;
      });
    }

    // --- SuperTable metadata (same pattern as tables.html) ---
    const META_BASE = 'http://0.0.0.0:8080';
    const ORGANIZATION = 'kladna-soft';
    const USER_HASH = '0b85b786b16d195439c0da18fd4478df';

    let currentSuper = null;
    let timingsChart = null; // NEW: Global variable for Chart.js instance
    window.__curRows = []; // Keep track of current rows
    window.__curHeaders = []; // Keep track of current headers
    window.__hintTables = {}; // Global schema map for IntelliSense

    function updateTenantSummary(superMeta) {
      const filesEl = document.getElementById('tenantFilesValue');
      const rowsEl = document.getElementById('tenantRowsValue');
      const sizeEl = document.getElementById('tenantSizeValue');
      const updEl = document.getElementById('tenantUpdatedValue');

      function humanizeCount(n) {
        if (n == null) return '0';
        const abs = Math.abs(n);
        if (abs < 1000) return String(n);
        const units = ['K', 'M', 'B', 'T', 'P'];
        let value = n;
        let unitIndex = -1;
        while (Math.abs(value) >= 1000 && unitIndex < units.length - 1) {
          value = value / 1000;
          unitIndex++;
        }
        return Math.round(value) + units[unitIndex];
      }

      function humanizeBytes(bytes) {
        if (bytes == null) return '0 B';
        const abs = Math.abs(bytes);
        if (abs < 1024) return bytes + ' B';
        const units = ['KB', 'MB', 'GB', 'TB', 'PB'];
        let value = bytes;
        let unitIndex = -1;
        while (Math.abs(value) >= 1024 && unitIndex < units.length - 1) {
          value = value / 1024;
          unitIndex++;
        }
        const rounded = (Math.abs(value) < 10) ? value.toFixed(1) : Math.round(value);
        return rounded + ' ' + units[unitIndex];
      }

      function formatDateMsLocal(ms) {
        if (!ms && ms !== 0) return 'n/a';
        try {
          const d = new Date(ms);
          if (isNaN(d.getTime())) return String(ms);
          return d.toLocaleString();
        } catch (e) {
          return String(ms);
        }
      }

      if (!superMeta) {
        if (filesEl) filesEl.textContent = 'n/a';
        if (rowsEl) rowsEl.textContent = 'n/a';
        if (sizeEl) sizeEl.textContent = 'n/a';
        if (updEl) updEl.textContent = 'n/a';
        return;
      }

      if (filesEl) filesEl.textContent = superMeta.files != null ? humanizeCount(superMeta.files) : '0';
      if (rowsEl) rowsEl.textContent = superMeta.rows != null ? humanizeCount(superMeta.rows) : '0';
      if (sizeEl) sizeEl.textContent = superMeta.size != null ? humanizeBytes(superMeta.size) : '0 B';
      if (updEl) updEl.textContent = superMeta.updated_utc != null ? formatDateMsLocal(superMeta.updated_utc) : 'n/a';
    }

    function loadTenantSuper(superName) {
      if (!superName) {
        updateTenantSummary(null);
        return;
      }

      api(
        META_BASE + '/reflection/super?organization=' +
        encodeURIComponent(ORGANIZATION) +
        '&super_name=' + encodeURIComponent(superName) +
        '&user_hash=' + encodeURIComponent(USER_HASH)
      )
        .then(data => {
          const s = data && data.meta && data.meta.super ? data.meta.super : null;
          if (!s) {
            updateTenantSummary(null);
            return;
          }
          updateTenantSummary(s);
        })
        .catch(err => {
          console.error('Failed to load super', err);
          updateTenantSummary(null);
        });
    }

    function loadTenants() {
      const selEl = document.getElementById('pairSel');
      if (!selEl) return;

      api(META_BASE + '/reflection/supers?organization=' + encodeURIComponent(ORGANIZATION))
        .then(data => {
          const supers = (data && Array.isArray(data.supers)) ? data.supers : [];
          selEl.innerHTML = '';

          if (!supers.length) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'No SuperTables found';
            selEl.appendChild(opt);
            updateTenantSummary(null);
            return;
          }

          supers.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.textContent = s;
            selEl.appendChild(opt);
          });

          currentSuper = supers[0];
          selEl.value = currentSuper;
          loadTenantSuper(currentSuper);
          // initial schema hints once we have a tenant
          loadSchema();
        })
        .catch(err => {
          console.error('Failed to load supers', err);
          updateTenantSummary(null);
        });
    }

    function onPairChange() {
      const sel = document.getElementById('pairSel');
      if (!sel) return;
      const sup = sel.value;
      if (!sup) return;
      currentSuper = sup;
      loadTenantSuper(sup);
      loadSchema();

      // Update the CodeMirror content when the SuperTable changes
      if (window.editor) {
          const leaf = getURLParameter('leaf');
          const defaultQuery = leaf
            ? `SELECT * FROM ${sup}.${leaf} LIMIT 1000`
            : `SELECT * FROM ${sup} LIMIT 100`;

          window.editor.setValue(defaultQuery);
      }
    }

    function goBackAdmin() {
      const sel = document.getElementById('pairSel');
      const sup = sel ? sel.value : '';
      const url = new URL('/reflection', window.location.origin);
      if (sup) url.searchParams.set('sup', sup);
      url.searchParams.set('org', ORGANIZATION);
      window.location.href = url.toString();
    }

    function getTenant() {
      return { organization: ORGANIZATION, superName: currentSuper };
    }

    function setStatus(text, cls) {
      const el = document.getElementById('status');
      el.className = 'text-sm muted ' + (cls || '');
      el.innerHTML = `<i class="fas fa-circle" style="font-size:8px;"></i>&nbsp;${text}`;
    }

    // NEW: Function to switch tabs
    function switchTab(tabName) {
        // 1. Deactivate all tabs and content
        document.querySelectorAll('#tab-navigation .tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            content.style.display = 'none';
        });

        // 2. Activate the selected tab and content
        const selectedTab = document.getElementById(`tab-${tabName}`);
        const selectedContent = document.getElementById(`tab-content-${tabName}`);

        if (selectedTab) selectedTab.classList.add('active');
        if (selectedContent) selectedContent.classList.add('active');
        if (selectedContent) selectedContent.style.display = 'block';

        // 3. Special handling for CodeMirror/Chart.js when switching
        if (tabName === 'execute' && window.editor) {
            // Refresh CodeMirror layout to fix rendering issues
            // Use setTimeout to ensure the container is fully expanded before refresh
            setTimeout(() => {
                window.editor.refresh();
            }, 0);
        }
    }


    // NEW: Centralized error display function
    function displayError(title, message) {
        const statusEl = document.getElementById('status');
        const errorDisplay = document.getElementById('query-error-display');
        const resultDiv = document.getElementById('result');
        const timingCard = document.getElementById('timings-visualization-card');

        statusEl.className = 'text-sm muted error';
        statusEl.innerHTML = '<i class="fas fa-times-circle"></i>&nbsp;Failed';

        // Show the error on the Result tab
        errorDisplay.style.display = 'block';
        document.getElementById('query-error-display').querySelector('strong').textContent = title + ':';
        document.getElementById('query-error-message').textContent = message;

        // Clear rows, headers, results area and timing chart
        window.__curRows = [];
        window.__curHeaders = [];
        resultDiv.innerHTML = '<div class="muted text-sm" style="padding: 15px;">Query failed. See error details above.</div>';
        timingCard.style.display = 'none';

        if (timingsChart) {
            timingsChart.destroy();
            timingsChart = null;
        }

        // Switch to the Result tab to show the error
        switchTab('result');
    }

    // OLD function replaced/redirected to new one
    function renderError(msg) {
        // Intercept old calls to renderError and use the new displayError structure
        displayError('Query Error', msg);
    }

    function renderTable(rows, total, page, pageSize, onPage) {
      if (!rows || !rows.length) {
        document.getElementById('result').innerHTML =
          '<div class="muted text-sm" style="padding: 15px;">No results</div>';
        window.__curRows = []; window.__curHeaders = [];
        return;
      }
      const headers = Object.keys(rows[0]);
      let html =
        '<div style="overflow:auto; max-height:60vh;">' +
        '<table><thead><tr><th>#</th>';
      headers.forEach(h => { html += `<th>${h}</th>`; });
      html += '</tr></thead><tbody>';

      rows.forEach((r, i) => {
        const absIdx = i + 1;
        html += '<tr>';
        html += `<td class="row-index">${absIdx}</td>`;
        headers.forEach(h => {
          let v = r[h];
          if (v === null || v === undefined) v = '';
          if (typeof v === 'object') v = JSON.stringify(v);
          html += `<td>${v}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table></div>';

      document.getElementById('result').innerHTML = html;
      window.__curRows = rows;
      window.__curHeaders = headers;
    }

    // Function to render the Chart.js timeline
    function renderTimingsChart(timings) {
        const chartContainer = document.getElementById('timings-visualization-card');
        const canvas = document.getElementById('timingsChart');
        const ctx = canvas.getContext('2d');

        if (!timings || timings.length === 0) {
            chartContainer.style.display = 'none';
            return;
        }

        chartContainer.style.display = 'block';

        const rawData = [];
        const labels = [];

        const pastelColors = [
            "#6BAED6", // clean blue
            "#9ECAE1", // light blue
            "#74C476", // green
            "#A1D99B", // light green
            "#FDAE6B", // orange-peach
            "#FDD0A2", // light peach
            "#C6DBEF", // blue-gray
            "#E7CB94"  // sand-gold
        ];

        timings.forEach(timing => {
            const key = Object.keys(timing)[0];

            // Filter out total/duration style keys
            if (key.toLowerCase().includes('total') || key.toLowerCase().includes('duration')) {
                return;
            }

            const value = timing[key];
            rawData.push(value * 1000); // store as ms
            labels.push(key.replace(/_/g, ' ').toUpperCase());
        });

        if (rawData.length === 0) {
            chartContainer.style.display = 'none';
            return;
        }

        const totalTimeMs = rawData.reduce((sum, val) => sum + val, 0);
        const totalTimeSeconds = (totalTimeMs / 1000).toFixed(4);

        if (timingsChart) {
            timingsChart.destroy();
            timingsChart = null;
        }

        timingsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['QUERY TIMELINE'],
                datasets: rawData.map((dataPoint, index) => ({
                    label: labels[index] + ' (' + (dataPoint / 1000).toFixed(4) + ' s)',
                    data: [dataPoint],
                    backgroundColor: pastelColors[index % pastelColors.length],
                    stack: 'timeline',
                    barPercentage: 0.9,
                    categoryPercentage: 0.9,
                    borderRadius: 0,
                    borderSkipped: false,
                    borderWidth: 1,
                    borderColor: 'rgba(15, 23, 42, 0.1)'
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // horizontal
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            boxHeight: 12,
                            padding: 14,
                            font: {
                                size: 11,
                                weight: '500'
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: `Execution Timeline (Total: ${totalTimeSeconds} s)`,
                        font: {
                            size: 16,
                            weight: '600'
                        },
                        padding: {
                            top: 8,
                            bottom: 16
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(15,23,42,0.92)',
                        titleFont: {
                            size: 13,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 12
                        },
                        padding: 10,
                        callbacks: {
                            label: function (context) {
                                const durationSeconds = (context.raw / 1000).toFixed(4) + ' s';
                                const name = context.dataset.label.split(' (')[0];
                                return `${name}: ${durationSeconds}`;
                            },
                            title: function () {
                                return 'Internal Step Duration';
                            }
                        }
                    }
                },
                animation: {
                    easing: 'linear',
                },
                animations: {
                    x: {
                        type: 'number',
                        from: 0,
                        easing: 'easeOutQuad',
                        duration: function (ctx) {
                            return 600;
                        },
                        delay: function (ctx) {
                            if (ctx.type === 'data' && ctx.dataIndex === 0) {
                                return ctx.datasetIndex * 300;
                            }
                            return 0;
                        }
                    },
                    y: {
                        duration: 0
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Time (milliseconds)',
                            font: { size: 13, weight: '500' }
                        },
                        beginAtZero: true,
                        max: totalTimeMs * 1.05,
                        grid: {
                            display: true,
                            drawBorder: false,
                            lineWidth: 0.5,
                            color: 'rgba(148, 163, 184, 0.25)'
                        },
                        ticks: {
                            font: { size: 11 }
                        }
                    },
                    y: {
                        stacked: true,
                        grid: { display: false },
                        ticks: { display: false }
                    }
                },
                layout: {
                    padding: {
                        top: 8,
                        right: 16,
                        bottom: 8,
                        left: 8
                    }
                }
            }
        });
    }

    // NEW loadSchema: uses FastAPI meta endpoints to build schema for IntelliSense
    async function loadSchema() {
      const userHash = USER_HASH;
      const { organization, superName } = getTenant();
      if (!organization || !superName || !userHash) return;

      try {
        // 1) list tables in the selected SuperTable (use /reflection/super meta; do NOT use /meta/tables)
        const superResp = await api(
          META_BASE +
          '/reflection/super?organization=' + encodeURIComponent(organization) +
          '&super_name=' + encodeURIComponent(superName) +
          '&user_hash=' + encodeURIComponent(userHash)
        );
        const superMeta = superResp && superResp.meta && superResp.meta.super ? superResp.meta.super : null;
        const tables = (superMeta && Array.isArray(superMeta.tables))
          ? superMeta.tables.map(t => (t && t.name) ? String(t.name) : '').filter(Boolean)
          : [];

        const hint = {};

        // 2) for each table, get its schema and derive column names
        for (const tableName of tables) {
          try {
            const schemaResp = await api(
              META_BASE +
              '/reflection/schema?organization=' + encodeURIComponent(organization) +
              '&super_name=' + encodeURIComponent(superName) +
              '&table=' + encodeURIComponent(tableName) +
              '&user_hash=' + encodeURIComponent(userHash)
            );

            if (schemaResp && schemaResp.ok && Array.isArray(schemaResp.schema) && schemaResp.schema.length > 0) {
              const firstRow = schemaResp.schema[0];
              const cols = Object.keys(firstRow || {});
              hint[tableName] = { columns: cols };
            }
          } catch (e) {
            console.error('Failed to load schema for table', tableName, e);
          }
        }

        window.__hintTables = hint;

        if (window.editor) {
          window.editor.setOption('hintOptions', buildSqlHintOptions());
        }
      } catch (e) {
        console.error('Schema load failed:', e);
      }
    }

    // --- execution timing state ---
    let execStartTime = null;
    let execTimerId = null;

    async function executeSQL(page) {
      const userHash = USER_HASH;
      const pageSize = 1000;
      const query = window.editor.getValue().trim();
      const { organization, superName } = getTenant();

      const errorDisplay = document.getElementById('query-error-display');
      const timingCard = document.getElementById('timings-visualization-card');
      const resultDiv = document.getElementById('result');

      // Reset error and timing display
      errorDisplay.style.display = 'none';
      timingCard.style.display = 'none';
      resultDiv.innerHTML = '<div class="muted text-sm" style="padding: 15px;">Loading results...</div>';
      if (window.timingsChartInstance) {
            window.timingsChartInstance.destroy();
            window.timingsChartInstance = null;
        }

      switchTab('result');

      if (!organization || !superName || !userHash) {
        displayError('Input Error', 'Please select a SuperTable.');
        return;
      }
      if (!/^\s*(select|with)\b/i.test(query)) {
        displayError('Input Error', 'Only SELECT/WITH queries are allowed.');
        return;
      }

      const startedAt = Date.now();
      execStartTime = startedAt;

      if (execTimerId) {
        clearInterval(execTimerId);
        execTimerId = null;
      }

      execTimerId = setInterval(() => {
        if (execStartTime === null) return;
        const elapsedSec = (Date.now() - execStartTime) / 1000;
        const text = `Executing… ${elapsedSec.toFixed(1)}s`;
        setStatus(text, 'executing');
      }, 150);

      setStatus('Executing…', 'executing');

      try {
        const data = await api('/reflection/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            organization,
            super_name: superName,
            user_hash: userHash,
            query,
            page: 1,
            page_size: pageSize
          })
        });

        const finishedAt = Date.now();
        const elapsedMsClient = finishedAt - startedAt;

        execStartTime = null;
        if (execTimerId) {
          clearInterval(execTimerId);
          execTimerId = null;
        }

        if (data.status === 'ok') {
          renderTable(
            data.result || [],
            data.total_count || 0,
            1,
            pageSize,
            (p) => executeSQL(p)
          );

          if (data.meta && data.meta.timings) {
              renderTimingsChart(data.meta.timings);
          }

          let durationMs = null;
          if (typeof data.duration_ms === 'number') {
            durationMs = data.duration_ms;
          } else if (typeof data.duration === 'number') {
            durationMs = data.duration;
          } else {
            durationMs = elapsedMsClient;
          }

          const durationStr = (durationMs / 1000).toFixed(3) + 's';
          const rowsLen = (data.result || []).length;
          const total = data.total_count || 0;

          const statusText =
            `Success — ${rowsLen} rows (total ${total}) in ${durationStr}`;

          setStatus(statusText);
        } else {
          const finishedAtError = Date.now();
          const elapsedErrorSec = ((finishedAtError - startedAt) / 1000).toFixed(3);

          setStatus(`Error executing query after ${elapsedErrorSec}s`, 'error');
          displayError('Query Error', data.message || 'Unknown error');
        }
      } catch (e) {
        const finishedAt = Date.now();
        const elapsedSec = ((finishedAt - startedAt) / 1000).toFixed(3);

        execStartTime = null;
        if (execTimerId) {
          clearInterval(execTimerId);
          execTimerId = null;
        }

        setStatus(`Error executing query after ${elapsedSec}s`, 'error');
        displayError('Network Error', e.message || String(e));
      }
    }

    function copyToClipboard() {
      if (!window.__curRows || window.__curRows.length === 0) {
        alert("No results to copy.");
        return;
      }

      const headers = window.__curHeaders || [];
      const rows = window.__curRows;

      if (!headers.length) {
        alert("No headers available to copy.");
        console.error("Clipboard failed: __curHeaders is empty.", { headers, rows });
        return;
      }

      let tsv = headers.join('\t') + '\n';

      rows.forEach(row => {
        const values = headers.map(header => {
          let value = row[header];
          if (value === null || value === undefined) value = '';
          if (typeof value === 'object') value = JSON.stringify(value);

          value = String(value).replace(/(\r\n|\n|\r)/g, ' ');

          if (value.includes('\t') || value.includes('"')) {
            value = '"' + value.replace(/"/g, '""') + '"';
          }
          return value;
        });
        tsv += values.join('\t') + '\n';
      });

      if (tsv.trim().length <= 1) {
        alert('Error: Data for clipboard is empty. Check if headers are available.');
        console.error('Clipboard failed: TSV string is empty or nearly empty. TSV content:', tsv);
        return;
      }

      const textToCopy = tsv;

      const btn = document.querySelector('.btn-clipboard');
      const originalText = btn ? btn.innerHTML : null;

      const showSuccess = () => {
        if (!btn) return;
        btn.innerHTML = '<i class="fas fa-check"></i>&nbsp;Copied!';
        setTimeout(() => { btn.innerHTML = originalText; }, 1500);
      };

      const fallbackCopy = () => {
        try {
          const textarea = document.createElement('textarea');
          textarea.value = textToCopy;
          textarea.style.position = 'fixed';
          textarea.style.left = '-9999px';
          textarea.style.top = '0';
          textarea.setAttribute('readonly', '');
          document.body.appendChild(textarea);
          textarea.select();
          const successful = document.execCommand('copy');
          document.body.removeChild(textarea);

          if (!successful) {
            throw new Error('document.execCommand("copy") returned false');
          }

          console.log('Successfully copied (fallback) ' + rows.length + ' rows to clipboard.');
          showSuccess();
        } catch (err) {
          console.error('Fallback copy failed:', err);
          alert('Failed to copy to clipboard. Your browser or environment may block clipboard access.');
        }
      };

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textToCopy)
          .then(() => {
            console.log('Successfully copied ' + rows.length + ' rows to clipboard (TSV format).');
            showSuccess();
          })
          .catch(err => {
            console.warn('navigator.clipboard.writeText failed, trying fallback. Error:', err);
            fallbackCopy();
          });
      } else {
        fallbackCopy();
      }
    }

    function downloadCSV() {
        if (!window.__curRows || window.__curRows.length === 0) {
            alert("No results to download.");
            return;
        }

        const headers = window.__curHeaders;
        const rows = window.__curRows;

        let csv = headers.join(',') + '\n';

        rows.forEach(row => {
            const values = headers.map(header => {
                let value = row[header];
                if (value === null || value === undefined) value = '';
                if (typeof value === 'object') value = JSON.stringify(value);

                value = String(value).replace(/"/g, '""');
                if (value.includes(',') || value.includes('\n') || value.includes('\r')) {
                    value = '"' + value + '"';
                }
                return value;
            });
            csv += values.join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');

        const superName = currentSuper ? currentSuper.replace(/\s/g, '_') : 'query_result';
        link.download = `${superName}_${new Date().toISOString().slice(0, 10)}.csv`;
        link.href = URL.createObjectURL(blob);
        link.click();
        URL.revokeObjectURL(link.href);
    }

    $(document).ready(function(){
      window.__admintoken = "{{ token|e }}";

      $("#toggleSidebar").on("click", function() {
        $("#sidebar").toggleClass("sidebar-collapsed");
        localStorage.setItem('st_sidebar_collapsed',
          $("#sidebar").hasClass("sidebar-collapsed"));
      });

      if (localStorage.getItem('st_sidebar_collapsed') === 'true') {
        $("#sidebar").addClass("sidebar-collapsed");
      }

      $("#link-execute").addClass("active");

      loadTenants();

      switchTab('execute');
    });
  </script>
</head>
<body>
  {% include "sidebar.html" %}

  <div class="content-container">
    <div class="wrap">

      {% include "selection.html" %}

      {% if has_tenant %}

      <div id="tab-navigation">
          <div id="tab-execute" class="tab active" onclick="switchTab('execute')">
              <i class="fas fa-terminal"></i>&nbsp;Execute
          </div>
          <div id="tab-result" class="tab" onclick="switchTab('result')">
              <i class="fas fa-table"></i>&nbsp;Result
          </div>
          <div id="tab-timings" class="tab" onclick="switchTab('timings')">
              <i class="fas fa-chart-bar"></i>&nbsp;Timings
          </div>
      </div>

      <div id="tab-content-container">

          <div id="tab-content-execute" class="tab-content active">
              <div class="card sql-editor-card">
                  <div class="card-body">
                      <div style="margin-top:0;">
                        <label class="text-sm muted">SQL Query</label>
                        <textarea id="sql" rows="8"></textarea>
                      </div>

                      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px;">
                        <div id="status" class="text-sm muted">
                          <i class="fas fa-circle" style="font-size:8px;"></i>&nbsp;Ready
                        </div>
                        <div style="display:flex; gap:8px;">
                          <button id="btnExec" class="btn-exec">
                            <i class="fas fa-play"></i>&nbsp;Execute
                          </button>
                        </div>
                      </div>
                  </div>
              </div>
          </div>

          <div id="tab-content-result" class="tab-content">
              <div id="query-error-display" class="mb-4">
                  <strong>Query Error:</strong>
                  <span id="query-error-message"></span>
              </div>

              <div class="card" id="result-card">
                <div class="section">
                  <div id="result"></div>
                  <div class="download-row">
                    <button class="btn-clipboard" onclick="copyToClipboard()">
                      <i class="fas fa-clipboard"></i>&nbsp;Copy to Clipboard
                    </button>
                    <button class="btn-download" onclick="downloadCSV()">
                      <i class="fas fa-file-csv"></i>&nbsp;Download CSV
                    </button>
                  </div>
                </div>
              </div>
          </div>

          <div id="tab-content-timings" class="tab-content">
              <div id="timings-visualization-card" class="card">
                  <div class="section" style="padding-bottom: 0; border-bottom: 1px solid var(--panel-border);">
                      <h4>Query Execution Timings</h4>
                      <div class="text-xs muted" style="margin-bottom: 16px;">
                          Internal execution steps excluding total query time.
                      </div>
                  </div>
                  <div class="chart-container">
                      <canvas id="timingsChart"></canvas>
                  </div>
              </div>
          </div>

      </div> {% endif %}
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/sql/sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/sql-hint.min.js"></script>

  <script>
    // Initialize CodeMirror + IntelliSense hooks
    window.__admintoken = "{{ token|e }}";

    // Helper to build consistent hintOptions from the current schema
    function buildSqlHintOptions() {
      return {
        completeSingle: false,
        tables: window.__hintTables || {},
        keywords: {
          "WITH": { className: "cm-cte" },
          "RECURSIVE": { className: "cm-cte" }
        }
      };
    }

    // Custom SQL IntelliSense helper: table/column aware
    CodeMirror.registerHelper("hint", "sqlEnhanced", function(cm, options) {
      const cursor = cm.getCursor();
      const token = cm.getTokenAt(cursor);
      const line = cm.getLine(cursor.line);
      const start = token.start;
      const end = token.end;
      const currentWord = token.string.toLowerCase();
      const lineText = line.substring(0, cursor.ch);

      const isAfterSelect = /SELECT\s+([^,]*)$/i.test(lineText);
      const isAfterFrom   = /FROM\s+([^,]*)$/i.test(lineText);
      const isAfterDot    = /(\w+)\.([^,]*)$/i.test(lineText);

      const tables = (options && options.tables) || window.__hintTables || {};
      const completions = [];

      if (isAfterSelect && !isAfterFrom) {
        // After SELECT: show columns + functions
        for (const tableName in tables) {
          const columns = tables[tableName].columns || [];
          columns.forEach(column => {
            completions.push({ text: column, displayText: column, className: "cm-column" });
            completions.push({
              text: `${tableName}.${column}`,
              displayText: `${tableName}.${column}`,
              className: "cm-column"
            });
          });
        }

        const sqlFunctions = [
          "COUNT", "SUM", "AVG", "MIN", "MAX",
          "CONCAT", "SUBSTRING", "UPPER", "LOWER"
        ];
        sqlFunctions.forEach(func => {
          completions.push({
            text: `${func}()`,
            displayText: `${func}()`,
            className: "cm-function"
          });
        });
      } else if (isAfterFrom) {
        // After FROM: show tables
        for (const tableName in tables) {
          completions.push({
            text: tableName,
            displayText: tableName + " (table)",
            className: "cm-table"
          });
        }
      } else if (isAfterDot) {
        // After table.: show columns of that table
        const matches = lineText.match(/(\w+)\.([^,]*)$/i);
        const tableName = matches ? matches[1] : null;
        const table = tableName ? tables[tableName] : null;

        if (table) {
          const columns = table.columns || [];
          columns.forEach(column => {
            completions.push({
              text: column,
              displayText: column,
              className: "cm-column"
            });
          });
        }
      } else {
        // Default: tables + columns + keywords
        for (const tableName in tables) {
          completions.push({
            text: tableName,
            displayText: tableName + " (table)",
            className: "cm-table"
          });

          const columns = tables[tableName].columns || [];
          columns.forEach(column => {
            completions.push({
              text: column,
              displayText: column + " (" + tableName + ")",
              className: "cm-column"
            });
            completions.push({
              text: `${tableName}.${column}`,
              displayText: `${tableName}.${column}`,
              className: "cm-column"
            });
          });
        }

        const keywords = [
          "SELECT", "FROM", "WHERE", "GROUP BY", "ORDER BY",
          "LIMIT", "JOIN", "LEFT", "RIGHT", "INNER", "OUTER", "WITH"
        ];
        keywords.forEach(keyword => {
          completions.push({
            text: keyword,
            displayText: keyword,
            className: "cm-keyword"
          });
        });
      }

      const filtered = completions
        .filter(item => item.text.toLowerCase().includes(currentWord))
        .sort((a, b) => a.text.localeCompare(b.text));

      return {
        list: filtered,
        from: CodeMirror.Pos(cursor.line, start),
        to: CodeMirror.Pos(cursor.line, end)
      };
    });

    // --- Dynamic Query Setup ---
    const leaf = getURLParameter('leaf');
    const defaultSuperName = '{{ sel_sup }}';

    let initialQuery;
    if (leaf) {
        initialQuery = `SELECT * FROM ${defaultSuperName}.${leaf} LIMIT 1000`;
    } else {
        initialQuery = `SELECT * FROM ${defaultSuperName} LIMIT 100`;
    }

    document.getElementById('sql').value = initialQuery;

    window.editor = CodeMirror.fromTextArea(document.getElementById('sql'), {
      mode: "text/x-sql",
      theme: 'default',
      lineNumbers: true,
      matchBrackets: true,
      lineWrapping: true,
      extraKeys: {
        "Ctrl-Enter": function(cm){ executeSQL(1); return false; },
        "Cmd-Enter": function(cm){ executeSQL(1); return false; },
        "Ctrl-Space": function(cm){
          cm.showHint({
            completeSingle:false,
            hint: CodeMirror.hint.sqlEnhanced,
            tables: window.__hintTables || {}
          });
        },
        "Tab": function(cm){
          cm.showHint({
            completeSingle:false,
            hint: CodeMirror.hint.sqlEnhanced,
            tables: window.__hintTables || {}
          });
          return false;
        }
      },
      hintOptions: buildSqlHintOptions()
    });

    // Auto-trigger IntelliSense on common trigger characters
    window.editor.on('inputRead', function(cm, input) {
      const triggerChars = ['.', ' ', ',', '(', ')'];
      if (input.text && triggerChars.includes(input.text[0])) {
        setTimeout(function() {
          cm.showHint({
            completeSingle: false,
            hint: CodeMirror.hint.sqlEnhanced,
            tables: window.__hintTables || {}
          });
        }, 120);
      }
    });

    window.editor.refresh();

    const execBtn = document.getElementById('btnExec');
    if (execBtn) {
      execBtn.addEventListener('click', () => executeSQL(1));
    }
  </script>
</body>
</html>
