<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SuperTable â€“ Execute SQL</title>

  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /*
     * Professional Styling Refinements for Execute SQL page
     * Focus: Cleanliness, Readability, Hierarchy, and Eye-Catching Execute Button.
     * Colors maintained from existing palette.
     */
    :root {
      --primary-color: #1c96ca;
      --primary-light: #e6f4fa;
      --secondary-color: #147ba3;
      --dark-color: #1a1a2e;
      --light-color: #f8f9fa;
      --text-color: #2b2d42;
      --text-light: #8d99ae;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      --panel-bg: #ffffff;
      --panel-border: #e0e5f0;
      --panel-shadow: 0 8px 20px rgba(15, 23, 42, 0.05); /* Softer shadow */
      --header-bg: #f8fafc;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f3f6fb;
      color: var(--text-color);
      line-height: 1.5; /* Improved readability */
    }

    a {
      color: var(--primary-color);
      text-decoration: none;
    }
    a:hover { text-decoration: underline; }

    /* ------------ MAIN CONTENT ------------ */

    .content-container {
      margin-left: 280px;
      min-height: 100vh;
      background-color: #f3f6fb;
      transition: var(--transition);
      padding-bottom: 0px;
    }

    .sidebar-collapsed ~ .content-container {
      margin-left: 80px;
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0px;
    }

    .card {
      background: var(--panel-bg);
      border-radius: 12px; /* Professional size */
      box-shadow: var(--panel-shadow);
      border: 1px solid var(--panel-border);
    }

    .section { padding: 20px 24px; } /* Increased padding */
    .muted { color: var(--text-light); }
    .text-xs { font-size: 11px; }
    .text-sm { font-size: 13px; } /* Slightly larger base text */

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px; /* Increased gap */
      align-items: flex-start;
    }

    /* --- Tab Navigation --- */
    #tab-navigation {
        display: flex;
        gap: 0; /* Tabs should touch */
        border-bottom: 2px solid var(--panel-border);
        margin-bottom: 16px;
        margin-top: 16px;
        padding-left: 8px; /* Slight left padding to match wrapper spacing */
    }

    .tab {
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-light);
        cursor: pointer;
        transition: color 0.2s, border-bottom 0.2s;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px; /* Pulls the border up to overlap the container border */
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .tab:hover {
        color: var(--primary-color);
    }

    .tab.active {
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        font-weight: 600;
    }

    .chip {
        background: #e0e5f0;
        color: var(--text-color);
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
    }

    .tab.active .chip {
        background: var(--primary-color);
        color: white;
    }

    /* --- Tab Content Containers --- */
    .tab-content {
        display: none;
    }
    /* Only the active content should be block/visible, this is handled in JS */
    .tab-content.active {
        display: block;
    }

    /* FIX: The card margin in the tab-content should be 0 or small */
    #tab-content-container .card {
        margin-top: 0 !important;
    }

    /* --- Execute Card Styling (Simplified from Header) --- */
    .sql-editor-card .card-body {
        padding: 24px;
    }

    /* --- Form Elements (Base Styles) --- */

    input, select, textarea {
      background: #ffffff;
      border: 1px solid #d0d7e7;
      color: var(--text-color);
      border-radius: 8px; /* Sharper radius */
      padding: 8px 12px;
      font-size: 13px;
      width: 100%;
      transition: var(--transition);
      margin-top: 4px; /* Space below label */
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px var(--primary-light); /* Use primary-light for soft focus ring */
      border-color: var(--primary-color);
    }

    textarea { resize: vertical; min-height: 140px; } /* Slightly taller default */

    /* --- SuperTable Selector Custom Style FIX --- */
    #pairSel {
      /* FIX 1: Overrides global `width: auto` to ensure 100% of parent width */
      width: 100% !important;
      display: block;
      margin-top: 0;

      /* FIX 2: Apply user's desired sizing, overriding generic form styles */
      padding: 10px 12px !important;
      font-size: 16px !important;
      height: auto !important;

      /* FIX 3: Apply custom arrow styles */
      appearance: none;
      -webkit-appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Cpath%20d%3D%22M4%207L10%2013L16%207%22%20stroke%3D%22%23475569%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%0A%3C%2Fpath%3E%0A%3C%2Fsvg%3E');
      background-repeat: no-repeat;
      background-position: right 10px center;
      cursor: pointer; /* Ensure cursor is applied */
      background-color: #ffffff; /* Ensure background is applied */
    }

    /* --- Buttons (Standard) --- */
    .btn {
      padding: 8px 12px;
      border-radius: 8px;
      background: var(--dark-color);
      border: 1px solid var(--dark-color);
      color: #e2e8f0;
      font-weight: 500;
      cursor: pointer;
      font-size: 13px;
      transition: var(--transition);
    }

    .btn:hover {
        filter: brightness(1.1);
        box-shadow: 0 4px 10px rgba(26, 26, 46, 0.2);
    }


    /* --- Execution sessions (+) tabs --- */
#exec-navigation {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    border-bottom: 2px solid var(--panel-border);
    margin-top: 16px;
    margin-bottom: 14px;
    padding-left: 8px;
    flex-wrap: wrap;
}

#openExecTabs {
    display: flex !important;
    align-items: flex-end !important;
    gap: 8px !important;
    flex-wrap: wrap;
}

/* + button aligned with tabs */
.tab-add {
    border: 1px dashed var(--panel-border);
    background: rgba(28, 150, 202, 0.08);
    color: var(--primary-color);
    padding: 9px 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 700;
    line-height: 1;
    margin-bottom: -2px; /* visually sits on the same baseline as the tabs */
}

.tab-add:hover {
    border-color: var(--primary-color);
    background: rgba(28, 150, 202, 0.14);
}

.exec-tab-wrap {
    position: relative;
    display: inline-flex;
    align-items: flex-end;
}

/* Dedicated styling so exec tabs don't reuse inner .tab styles */
.exec-tab-btn {
    appearance: none;
    border: 1px solid var(--panel-border);
    border-bottom: none;
    background: #f8fafc;
    color: var(--text-light);
    padding: 10px 38px 10px 16px; /* extra right padding for the close button */
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    cursor: pointer;
    transition: var(--transition);
    font-size: 14px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-bottom: -2px; /* overlap container border-bottom */
}

.exec-tab-btn:hover {
    color: var(--primary-color);
}

.exec-tab-btn.active {
    background: #ffffff;
    color: var(--primary-color);
}

.exec-tab-close {
    position: absolute;
    right: 6px;
    top: 6px;
    border: none;
    background: transparent;
    color: #94a3b8;
    cursor: pointer;
    padding: 6px 8px;
    border-radius: 8px;
    transition: var(--transition);
}

.exec-tab-close:hover {
    background: rgba(15, 23, 42, 0.06);
    color: #334155;
}

#inner-tab-mount {
    margin: 0 0 14px 0;
}
/* --- CodeMirror styling (INCREASED HEIGHT to 500px) --- */
    .CodeMirror {
      border-radius: 8px; /* Match form elements */
      border: 1px solid #d0d7e7;
      background: #ffffff;
      color: #0b1220;
      font-size: 14px; /* Slightly larger code font */
      min-height: 500px; /* Taller editor */
    }

    .CodeMirror-focused {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    /* --- Eye-Catching Execute Button --- */
    .btn-exec {
      color: white;
      background: var(--primary-color);
      border: 1px solid var(--primary-color);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 6px 20px rgba(28, 150, 202, 0.25);
      transition: transform .1s ease, box-shadow .2s ease, background-color .2s ease;
      white-space: nowrap;
    }
    .btn-exec:hover {
        background: var(--secondary-color);
        border-color: var(--secondary-color);
        box-shadow: 0 8px 25px rgba(28, 150, 202, 0.4);
    }
    .btn-exec:active { transform: translateY(1px); }

    /* --- Status Bar --- */
    #status {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    #status i { color: #10b981; }
    #status.executing i { color: #f59e0b; animation: spin 1s linear infinite; }
    #status.error i { color: #ef4444; }

    @keyframes spin {
      0% { transform:rotate(0deg); }
      100% { transform:rotate(360deg); }
    }

    /* --- Error Block --- */
    #query-error-display {
        background-color: #fee2e2;
        color: #b91c1c;
        border: 1px solid #fca5a5;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
        display: none; /* Hidden by default, JS controls visibility */
        font-weight: 500;
        font-size: 14px;
    }
    #query-error-display strong {
        font-weight: 700;
        margin-right: 8px;
    }
    #query-error-message {
        font-family: monospace;
        background-color: #fecaca;
        padding: 8px;
        border-radius: 4px;
        display: block;
        margin-top: 8px;
        white-space: pre-wrap;
        word-break: break-all;
    }

    /* --- Visualization --- */
    #timings-visualization-card {
        /* Set a fixed height for the canvas to ensure Chart.js renders correctly */
        height: 350px;
        display: none; /* Hidden by default, JS controls visibility */
    }
    .chart-container {
        position: relative;
        height: 100%;
        width: 100%;
        padding: 20px;
    }
    /* Ensure canvas is block-level and max size of container for Chart.js responsiveness */
    .chart-container canvas {
        height: 100% !important;
        width: 100% !important;
    }


    /* --- Results Table --- */
    #result table {
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
      border: 1px solid var(--panel-border);
      border-radius: 8px;
      overflow: hidden;
    }

    #result th, #result td {
      padding: 10px 15px;
      border:none;
      border-right: 1px solid #e2e8f0;
    }

    #result td:last-child {
        border-right: none;
    }

    #result thead th {
      position: sticky;
      top: 0;
      background: #f1f5f9;
      z-index: 1;
      font-weight: 600;
      color: #4b5563;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.05em;
      border-bottom: 2px solid #e2e8f0;
    }

    #result tbody tr td {
        border-bottom: 1px solid #f1f5f9;
    }

    #result tbody tr:last-child td {
        border-bottom: none;
    }

    #result tr:nth-child(even) td {
      background: #f9fafb;
    }

    #result tr:hover td {
      background: #e6f4fa;
    }

    #result .row-index {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: #64748b;
      font-weight: 500;
    }

    /* --- Download/Copy Row --- */
    .download-row {
      margin-top: 16px;
      text-align: right;
      display: flex;
      justify-content: flex-end;
      gap: 8px; /* Space between buttons */
    }

    .btn-clipboard {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--dark-color);
      background: var(--dark-color);
      color: #e2e8f0;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: var(--transition);
    }
    .btn-clipboard:hover {
        filter: brightness(1.1);
        box-shadow: 0 4px 10px rgba(26, 26, 46, 0.2);
    }
    .btn-download {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--dark-color);
      background: var(--dark-color);
      color: #e2e8f0;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: var(--transition);
    }
    .btn-download:hover {
        filter: brightness(1.1);
        box-shadow: 0 4px 10px rgba(26, 26, 46, 0.2);
    }


    /* --- Shared metric / summary styles --- */
    .metric-card {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 10px;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      min-height: 70px;
      transition: box-shadow 0.2s;
    }

    .metric-card:hover {
        box-shadow: 0 4px 15px rgba(28, 150, 202, 0.08);
    }

    .metric-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      background: var(--primary-light);
      color: var(--primary-color);
      flex-shrink: 0;
      font-size: 16px;
    }

    .metric-content {
      display: flex;
      flex-direction: column;
    }

    .metric-label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-weight: 600;
    }

    .metric-value {
      font-size: 16px;
      font-weight: 700;
      margin-top: 4px;
      color: #111827;
    }

    .tenant-summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .tenant-updated {
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
      text-align: right;
    }

    /* Optional: style hints dropdown a bit */
    .CodeMirror-hints {
      z-index: 9999;
      font-family: 'Fira Code', 'Consolas', monospace;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: none;
      background: #ffffff;
    }
    .CodeMirror-hint {
      padding: 6px 12px;
      color: #111827;
      transition: all 0.2s ease;
    }
    .CodeMirror-hint-active {
      background: var(--primary-color);
      color: white;
    }
  </style>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js">
  </script>

  <script>
    // --- Utility to parse URL parameters ---
    function getURLParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      const results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    // --- Shared admin API helper ---
    function api(path, opts) {
      opts = opts || {};
      opts.headers = opts.headers || {};
      if (window.__admintoken) opts.headers['X-Admin-Token'] = window.__admintoken;
      return fetch(path, opts).then(async res => {
        const ct = res.headers.get('content-type') || '';
        const payload = ct.includes('application/json')
          ? await res.json()
          : await res.text();
        if (!res.ok) {
          const msg = typeof payload === 'string' ? payload : JSON.stringify(payload);
          throw new Error(msg);
        }
        return payload;
      });
    }

    // --- SuperTable metadata (same pattern as tables.html) ---
    const META_BASE = ''; // same-origin (avoids CSP connect-src violations)
    const ORGANIZATION = {{ session_org|default(sel_org|default('', true), true)|tojson }};
    const USER_HASH = {{ session_user_hash|default(default_user_hash|default('', true), true)|tojson }};

    let currentSuper = null;
    // Selection component will call this after /reflection/super is loaded.
    // We cache the meta to avoid duplicate /reflection/super calls from this page (e.g. loadSchema()).
    window.onSuperMetaLoaded = function (org, superName, superMeta) {
      try {
        if (superName) currentSuper = superName;
        window.__st_lastSuperMeta = superMeta || null;

        // Update the CodeMirror content when the SuperTable changes (initial load included)
        if (window.editor) {
          const leaf = getURLParameter('leaf');
          const defaultQuery = leaf
            ? `SELECT * FROM ${superName}.${leaf} LIMIT 1000`
            : `SELECT * FROM ${superName} LIMIT 100`;

          window.editor.setValue(defaultQuery);
        }
      } catch (e) {
        console.error('onSuperMetaLoaded failed', e);
      }

      // Load schema hints once we have the latest meta.
      try {
        loadSchema();
      } catch (e) {
        console.error('loadSchema failed', e);
      }
    };

    let timingsChart = null; // NEW: Global variable for Chart.js instance
    window.__curRows = []; // Keep track of current rows
    window.__curHeaders = []; // Keep track of current headers
    window.__hintTables = {}; // Global schema map for IntelliSense


    // --- Multi-execution sessions (tabs with +) ---
    const __execSessions = [];
    let __activeExecSessionId = null;
    let __execSessionSeq = 0;
    window.__activeInnerTabName = 'execute';

    function __getActiveExecSession() {
      if (!__activeExecSessionId) return null;
      return __execSessions.find(s => s.id === __activeExecSessionId) || null;
    }

    function __buildDefaultExecutionQuery() {
      const leaf = getURLParameter('leaf');
      // defaultSuperName is defined later in this script; safe because we call this after page init
      const sup = (typeof defaultSuperName !== 'undefined' && defaultSuperName) ? defaultSuperName : '';
      if (!sup) {
        return window.editor ? window.editor.getValue() : '';
      }
      return leaf ? `SELECT * FROM ${sup}.${leaf} LIMIT 1000` : `SELECT * FROM ${sup} LIMIT 100`;
    }

    function __createExecSession(opts) {
      __execSessionSeq += 1;
      const name = (opts && opts.name) ? opts.name : `Execution ${__execSessionSeq}`;
      const query = (opts && typeof opts.query === 'string') ? opts.query : __buildDefaultExecutionQuery();
      return {
        id: 'exec-' + __execSessionSeq,
        name,
        query,
        innerTab: 'execute',
        statusText: 'Ready',
        statusCls: '',
        rows: [],
        timings: null,
        errorVisible: false,
        errorTitle: '',
        errorMessage: '',
        abortController: null,
        isExecuting: false
      };
    }

    function __renderExecTabs() {
      const host = document.getElementById('openExecTabs');
      if (!host) return;

      host.innerHTML = '';

      __execSessions.forEach(s => {
        const wrap = document.createElement('div');
        wrap.className = 'exec-tab-wrap';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'exec-tab-btn' + (s.id === __activeExecSessionId ? ' active' : '');
        btn.setAttribute('aria-selected', s.id === __activeExecSessionId ? 'true' : 'false');

        const icon = document.createElement('i');
        icon.className = 'fas fa-bolt';
        const label = document.createElement('span');
        label.textContent = s.name;

        btn.appendChild(icon);
        btn.appendChild(label);
        btn.addEventListener('click', () => __activateExecSession(s.id));

        wrap.appendChild(btn);

        if (__execSessions.length > 1) {
          const closeBtn = document.createElement('button');
          closeBtn.type = 'button';
          closeBtn.className = 'exec-tab-close';
          closeBtn.title = 'Close';
          closeBtn.innerHTML = '<i class="fas fa-times"></i>';
          closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            __closeExecSession(s.id);
          });
          wrap.appendChild(closeBtn);
        }

        host.appendChild(wrap);
      });
    }

    function __mountInnerTabs() {
      const mount = document.getElementById('inner-tab-mount');
      const nav = document.getElementById('tab-navigation');
      if (!mount || !nav) return;
      if (nav.parentElement !== mount) {
        mount.appendChild(nav);
      }
    }

    function __cancelSessionExecution(session) {
      if (!session) return;

      session.isExecuting = false;

      if (session.abortController) {
        try { session.abortController.abort(); } catch (e) {}
      }
      session.abortController = null;

      if (execTimerId) {
        clearInterval(execTimerId);
        execTimerId = null;
      }
      execStartTime = null;
    }

    function __saveActiveExecSessionState() {
      const s = __getActiveExecSession();
      if (!s) return;
      if (window.editor) s.query = window.editor.getValue();
      s.innerTab = window.__activeInnerTabName || s.innerTab || 'execute';
    }

    function __resetUIForNewSession(session) {
      const errorDisplay = document.getElementById('query-error-display');
      const timingCard = document.getElementById('timings-visualization-card');
      const resultDiv = document.getElementById('result');

      if (errorDisplay) errorDisplay.style.display = 'none';
      if (timingCard) timingCard.style.display = 'none';
      if (resultDiv) {
        resultDiv.innerHTML = '<div class="muted text-sm" style="padding: 15px;">No results</div>';
      }

      if (window.timingsChartInstance) {
        try { window.timingsChartInstance.destroy(); } catch (e) {}
        window.timingsChartInstance = null;
      }

      window.__curRows = [];
      window.__curHeaders = [];

      session.rows = [];
      session.timings = null;
      session.errorVisible = false;
      session.errorTitle = '';
      session.errorMessage = '';
      session.statusText = 'Ready';
      session.statusCls = '';
      session.innerTab = 'execute';

      if (window.editor) window.editor.setValue(session.query || __buildDefaultExecutionQuery());
      setStatus('Ready');
      switchTab('execute');
    }

    function __applyExecSessionState(session) {
      if (!session) return;

      if (window.editor && typeof session.query === 'string') {
        window.editor.setValue(session.query);
      }

      const errorDisplay = document.getElementById('query-error-display');
      const timingCard = document.getElementById('timings-visualization-card');
      const resultDiv = document.getElementById('result');

      if (errorDisplay) errorDisplay.style.display = 'none';
      if (timingCard) timingCard.style.display = 'none';

      if (window.timingsChartInstance) {
        try { window.timingsChartInstance.destroy(); } catch (e) {}
        window.timingsChartInstance = null;
      }

      if (session.errorVisible) {
        displayError(session.errorTitle || 'Query Error', session.errorMessage || 'Unknown error');
      } else {
        setStatus(session.statusText || 'Ready', session.statusCls || '');

        if (Array.isArray(session.rows) && session.rows.length) {
          renderTable(session.rows, session.rows.length, 1, 1000, (p) => executeSQL(p), session.statusText);
        } else if (resultDiv) {
          resultDiv.innerHTML = '<div class="muted text-sm" style="padding: 15px;">No results</div>';
          window.__curRows = [];
          window.__curHeaders = [];
        }

        if (Array.isArray(session.timings) && session.timings.length) {
          renderTimingsChart(session.timings);
        }
      }

      switchTab(session.innerTab || 'execute');

      if (window.editor) {
        setTimeout(() => { try { window.editor.refresh(); } catch (e) {} }, 0);
      }
    }

    function __activateExecSession(id) {
      if (id === __activeExecSessionId) return;

      const cur = __getActiveExecSession();
      if (cur && cur.isExecuting) {
        __cancelSessionExecution(cur);
        cur.statusText = 'Cancelled';
        cur.statusCls = '';
      }

      __saveActiveExecSessionState();

      __activeExecSessionId = id;
      __renderExecTabs();
      __applyExecSessionState(__getActiveExecSession());
    }

    function __addExecSession() {
      __saveActiveExecSessionState();

      const s = __createExecSession();
      __execSessions.push(s);
      __activeExecSessionId = s.id;

      __renderExecTabs();
      __resetUIForNewSession(s);
    }

    function __closeExecSession(id) {
      const idx = __execSessions.findIndex(s => s.id === id);
      if (idx < 0) return;

      const s = __execSessions[idx];
      if (s && s.isExecuting) __cancelSessionExecution(s);

      __execSessions.splice(idx, 1);

      if (!__execSessions.length) {
        const fresh = __createExecSession({ name: 'Execution 1' });
        __execSessions.push(fresh);
      }

      if (__activeExecSessionId === id) {
        const next = __execSessions[Math.max(0, idx - 1)] || __execSessions[0];
        __activeExecSessionId = next.id;
      }

      __renderExecTabs();
      __applyExecSessionState(__getActiveExecSession());
    }

    function __initExecSessions() {
      const addBtn = document.getElementById('btnNewExecution');
      const host = document.getElementById('openExecTabs');
      if (!addBtn || !host) return;

      if (__execSessions.length) return;

      addBtn.addEventListener('click', () => __addExecSession());

      const first = __createExecSession({
        name: 'Execution 1',
        query: window.editor ? window.editor.getValue() : __buildDefaultExecutionQuery()
      });

      __execSessions.push(first);
      __activeExecSessionId = first.id;

      __renderExecTabs();
    }

    function updateTenantSummary(superMeta) {
      const filesEl = document.getElementById('tenantFilesValue');
      const rowsEl = document.getElementById('tenantRowsValue');
      const sizeEl = document.getElementById('tenantSizeValue');
      const updEl = document.getElementById('tenantUpdatedValue');

      function humanizeCount(n) {
        if (n == null) return '0';
        const abs = Math.abs(n);
        if (abs < 1000) return String(n);
        const units = ['K', 'M', 'B', 'T', 'P'];
        let value = n;
        let unitIndex = -1;
        while (Math.abs(value) >= 1000 && unitIndex < units.length - 1) {
          value = value / 1000;
          unitIndex++;
        }
        return Math.round(value) + units[unitIndex];
      }

      function humanizeBytes(bytes) {
        if (bytes == null) return '0 B';
        const abs = Math.abs(bytes);
        if (abs < 1024) return bytes + ' B';
        const units = ['KB', 'MB', 'GB', 'TB', 'PB'];
        let value = bytes;
        let unitIndex = -1;
        while (Math.abs(value) >= 1024 && unitIndex < units.length - 1) {
          value = value / 1024;
          unitIndex++;
        }
        const rounded = (Math.abs(value) < 10) ? value.toFixed(1) : Math.round(value);
        return rounded + ' ' + units[unitIndex];
      }

      function formatDateMsLocal(ms) {
        if (!ms && ms !== 0) return 'n/a';
        try {
          const d = new Date(ms);
          if (isNaN(d.getTime())) return String(ms);
          return d.toLocaleString();
        } catch (e) {
          return String(ms);
        }
      }

      if (!superMeta) {
        if (filesEl) filesEl.textContent = 'n/a';
        if (rowsEl) rowsEl.textContent = 'n/a';
        if (sizeEl) sizeEl.textContent = 'n/a';
        if (updEl) updEl.textContent = 'n/a';
        return;
      }

      if (filesEl) filesEl.textContent = superMeta.files != null ? humanizeCount(superMeta.files) : '0';
      if (rowsEl) rowsEl.textContent = superMeta.rows != null ? humanizeCount(superMeta.rows) : '0';
      if (sizeEl) sizeEl.textContent = superMeta.size != null ? humanizeBytes(superMeta.size) : '0 B';
      if (updEl) updEl.textContent = superMeta.updated_utc != null ? formatDateMsLocal(superMeta.updated_utc) : 'n/a';
    }

    function loadTenantSuper(superName) {
      if (!superName) {
        updateTenantSummary(null);
        return;
      }

      api(
        META_BASE + '/reflection/super?organization=' +
        encodeURIComponent(ORGANIZATION) +
        '&super_name=' + encodeURIComponent(superName) +
        '&user_hash=' + encodeURIComponent(USER_HASH)
      )
        .then(data => {
          const s = data && data.meta && data.meta.super ? data.meta.super : null;
          if (!s) {
            updateTenantSummary(null);
            return;
          }
          updateTenantSummary(s);
        })
        .catch(err => {
          console.error('Failed to load super', err);
          updateTenantSummary(null);
        });
    }

    function loadTenants() {
      const selEl = document.getElementById('pairSel');
      if (!selEl) return;

      api(META_BASE + '/reflection/supers?organization=' + encodeURIComponent(ORGANIZATION))
        .then(data => {
          const supers = (data && Array.isArray(data.supers)) ? data.supers : [];
          selEl.innerHTML = '';

          if (!supers.length) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'No SuperTables found';
            selEl.appendChild(opt);
            updateTenantSummary(null);
            return;
          }

          supers.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.textContent = s;
            selEl.appendChild(opt);
          });

          currentSuper = supers[0];
          selEl.value = currentSuper;
          loadTenantSuper(currentSuper);
          // initial schema hints once we have a tenant
          loadSchema();
        })
        .catch(err => {
          console.error('Failed to load supers', err);
          updateTenantSummary(null);
        });
    }

    function onPairChange() {
      const sel = document.getElementById('pairSel');
      if (!sel) return;
      const sup = sel.value;
      if (!sup) return;
      currentSuper = sup;
      // Selection.html already fetches /reflection/super; avoid duplicate calls here.

      // Update the CodeMirror content when the SuperTable changes
      if (window.editor) {
          const leaf = getURLParameter('leaf');
          const defaultQuery = leaf
            ? `SELECT * FROM ${sup}.${leaf} LIMIT 1000`
            : `SELECT * FROM ${sup} LIMIT 100`;

          window.editor.setValue(defaultQuery);
      }
    }

    function goBackAdmin() {
      const sel = document.getElementById('pairSel');
      const sup = sel ? sel.value : '';
      const url = new URL('/reflection', window.location.origin);
      if (sup) url.searchParams.set('sup', sup);
      url.searchParams.set('org', ORGANIZATION);
      window.location.href = url.toString();
    }

    function getTenant() {
      return { organization: ORGANIZATION, superName: currentSuper };
    }

    function extractExecuteError(payload) {
      if (!payload || typeof payload !== 'object') return null;
      const meta = payload.meta || {};
      const result1 = typeof meta.result_1 === 'string' ? meta.result_1 : '';
      if (result1 && result1.toUpperCase() === 'ERROR') {
        const msg = (typeof meta.result_2 === 'string' && meta.result_2) ? meta.result_2 : (payload.message || 'Unknown error');
        let summary = 'Error';
        const m = /:\s*(\d{3})\s*\(([^)]+)\)/.exec(msg);
        if (m) summary = `HTTP ${m[1]} (${m[2]})`;
        return { title: 'Query Error', message: msg, summary };
      }
      return null;
    }


    function setStatus(text, cls) {
      const el = document.getElementById('status');
      el.className = 'text-sm muted ' + (cls || '');
      el.innerHTML = `<i class="fas fa-circle" style="font-size:8px;"></i>&nbsp;${text}`;

      const s = __getActiveExecSession ? __getActiveExecSession() : null;
      if (s) {
        s.statusText = text;
        s.statusCls = cls || '';
      }
    }

    // NEW: Function to switch tabs
    function switchTab(tabName) {
        // 1. Deactivate all tabs and content
        document.querySelectorAll('#tab-navigation .tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            content.style.display = 'none';
        });

        // 2. Activate the selected tab and content
        const selectedTab = document.getElementById(`tab-${tabName}`);
        const selectedContent = document.getElementById(`tab-content-${tabName}`);

        if (selectedTab) selectedTab.classList.add('active');
        if (selectedContent) selectedContent.classList.add('active');
        if (selectedContent) selectedContent.style.display = 'block';

        // 3. Special handling for CodeMirror/Chart.js when switching
        if (tabName === 'execute' && window.editor) {
            // Refresh CodeMirror layout to fix rendering issues
            // Use setTimeout to ensure the container is fully expanded before refresh
            setTimeout(() => {
                window.editor.refresh();
            }, 0);
        }
    

        window.__activeInnerTabName = tabName;
        const __s = __getActiveExecSession ? __getActiveExecSession() : null;
        if (__s) __s.innerTab = tabName;
}


    // NEW: Centralized error display function
    function displayError(title, message, statusTextOverride) {
        const __s = __getActiveExecSession ? __getActiveExecSession() : null;
        if (__s) {
            __s.errorVisible = true;
            __s.errorTitle = title;
            __s.errorMessage = message;
            __s.rows = [];
            __s.timings = null;
            __s.statusText = statusTextOverride || 'Failed';
            __s.statusCls = 'error';
            __s.innerTab = 'result';
        }

        const statusEl = document.getElementById('status');
        const statusText = statusTextOverride || 'Failed';
        const errorDisplay = document.getElementById('query-error-display');
        const resultDiv = document.getElementById('result');
        const timingCard = document.getElementById('timings-visualization-card');

        statusEl.className = 'text-sm muted error';
        statusEl.innerHTML = `<i class="fas fa-times-circle"></i>&nbsp;${statusText}`;

        // Show the error on the Result tab
        errorDisplay.style.display = 'block';
        document.getElementById('query-error-display').querySelector('strong').textContent = title + ':';
        document.getElementById('query-error-message').textContent = message;

        // Clear rows, headers, results area and timing chart
        window.__curRows = [];
        window.__curHeaders = [];
        resultDiv.innerHTML = '<div class="muted text-sm" style="padding: 15px;">Query failed. See error details above.</div>';
        timingCard.style.display = 'none';

        if (timingsChart) {
            timingsChart.destroy();
            timingsChart = null;
        }

        // Switch to the Result tab to show the error
        switchTab('result');
    }

    // OLD function replaced/redirected to new one
    function renderError(msg) {
        // Intercept old calls to renderError and use the new displayError structure
        displayError('Query Error', msg, `Error executing query after ${elapsedErrorSec}s`);
    }

    function renderTable(rows, total, page, pageSize, onPage, statusText) {
      // Optional status summary shown above the result table (matches Execute header)
      const __esc = (v) => String(v === undefined || v === null ? '' : v)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

      const statusLine = statusText || (__getActiveExecSession && __getActiveExecSession() ? __getActiveExecSession().statusText : '') || '';

      if (!rows || !rows.length) {
        let html = '';
        if (statusLine) {
          html += `<div class="text-sm muted" style="padding: 10px 0 8px 2px;">${__esc(statusLine)}</div>`;
        }
        html += '<div class="muted text-sm" style="padding: 15px;">No results</div>';
        document.getElementById('result').innerHTML = html;
        window.__curRows = []; window.__curHeaders = [];
        return;
      }
      const headers = Object.keys(rows[0]);
let html = '';
      if (statusLine) {
        html += `<div class="text-sm muted" style="padding: 10px 0 8px 2px;">${__esc(statusLine)}</div>`;
      }
      html +=
        '<div style="overflow:auto; max-height:60vh;">' +
        '<table><thead><tr><th>#</th>';
      headers.forEach(h => { html += `<th>${h}</th>`; });
      html += '</tr></thead><tbody>';

      rows.forEach((r, i) => {
        const absIdx = i + 1;
        html += '<tr>';
        html += `<td class="row-index">${absIdx}</td>`;
        headers.forEach(h => {
          let v = r[h];
          if (v === null || v === undefined) v = '';
          if (typeof v === 'object') v = JSON.stringify(v);
          html += `<td>${v}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table></div>';

      document.getElementById('result').innerHTML = html;
      window.__curRows = rows;
      window.__curHeaders = headers;
    }

    // Function to render the Chart.js timeline
    function renderTimingsChart(timings) {
        const chartContainer = document.getElementById('timings-visualization-card');
        const canvas = document.getElementById('timingsChart');
        const ctx = canvas.getContext('2d');

        if (!timings || timings.length === 0) {
            chartContainer.style.display = 'none';
            return;
        }

        chartContainer.style.display = 'block';

        const rawData = [];
        const labels = [];

        const pastelColors = [
            "#6BAED6", // clean blue
            "#9ECAE1", // light blue
            "#74C476", // green
            "#A1D99B", // light green
            "#FDAE6B", // orange-peach
            "#FDD0A2", // light peach
            "#C6DBEF", // blue-gray
            "#E7CB94"  // sand-gold
        ];

        timings.forEach(timing => {
            const key = Object.keys(timing)[0];

            // Filter out total/duration style keys
            if (key.toLowerCase().includes('total') || key.toLowerCase().includes('duration')) {
                return;
            }

            const value = timing[key];
            rawData.push(value * 1000); // store as ms
            labels.push(key.replace(/_/g, ' ').toUpperCase());
        });

        if (rawData.length === 0) {
            chartContainer.style.display = 'none';
            return;
        }

        const totalTimeMs = rawData.reduce((sum, val) => sum + val, 0);
        const totalTimeSeconds = (totalTimeMs / 1000).toFixed(4);

        if (timingsChart) {
            timingsChart.destroy();
            timingsChart = null;
        }

        timingsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['QUERY TIMELINE'],
                datasets: rawData.map((dataPoint, index) => ({
                    label: labels[index] + ' (' + (dataPoint / 1000).toFixed(4) + ' s)',
                    data: [dataPoint],
                    backgroundColor: pastelColors[index % pastelColors.length],
                    stack: 'timeline',
                    barPercentage: 0.9,
                    categoryPercentage: 0.9,
                    borderRadius: 0,
                    borderSkipped: false,
                    borderWidth: 1,
                    borderColor: 'rgba(15, 23, 42, 0.1)'
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // horizontal
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            boxHeight: 12,
                            padding: 14,
                            font: {
                                size: 11,
                                weight: '500'
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: `Execution Timeline (Total: ${totalTimeSeconds} s)`,
                        font: {
                            size: 16,
                            weight: '600'
                        },
                        padding: {
                            top: 8,
                            bottom: 16
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(15,23,42,0.92)',
                        titleFont: {
                            size: 13,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 12
                        },
                        padding: 10,
                        callbacks: {
                            label: function (context) {
                                const durationSeconds = (context.raw / 1000).toFixed(4) + ' s';
                                const name = context.dataset.label.split(' (')[0];
                                return `${name}: ${durationSeconds}`;
                            },
                            title: function () {
                                return 'Internal Step Duration';
                            }
                        }
                    }
                },
                animation: {
                    easing: 'linear',
                },
                animations: {
                    x: {
                        type: 'number',
                        from: 0,
                        easing: 'easeOutQuad',
                        duration: function (ctx) {
                            return 600;
                        },
                        delay: function (ctx) {
                            if (ctx.type === 'data' && ctx.dataIndex === 0) {
                                return ctx.datasetIndex * 300;
                            }
                            return 0;
                        }
                    },
                    y: {
                        duration: 0
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Time (milliseconds)',
                            font: { size: 13, weight: '500' }
                        },
                        beginAtZero: true,
                        max: totalTimeMs * 1.05,
                        grid: {
                            display: true,
                            drawBorder: false,
                            lineWidth: 0.5,
                            color: 'rgba(148, 163, 184, 0.25)'
                        },
                        ticks: {
                            font: { size: 11 }
                        }
                    },
                    y: {
                        stacked: true,
                        grid: { display: false },
                        ticks: { display: false }
                    }
                },
                layout: {
                    padding: {
                        top: 8,
                        right: 16,
                        bottom: 8,
                        left: 8
                    }
                }
            }
        });
    }

    // NEW loadSchema: uses FastAPI meta endpoints to build schema for IntelliSense
    async function loadSchema() {
      const userHash = USER_HASH;
      const { organization, superName } = getTenant();
      if (!organization || !superName || !userHash) return;

      try {        // 1) list tables in the selected SuperTable (use /reflection/super meta; do NOT use /meta/tables)
        let superMeta = null;
        try {
          const cached = window.__st_lastSuperMeta;
          if (cached && cached.name === superName && Array.isArray(cached.tables)) {
            superMeta = cached;
          }
        } catch (e) {
          // ignore
        }

        if (!superMeta) {
          const superResp = await api(
            META_BASE +
            '/reflection/super?organization=' + encodeURIComponent(organization) +
            '&super_name=' + encodeURIComponent(superName) +
            '&user_hash=' + encodeURIComponent(userHash)
          );
          superMeta = superResp && superResp.meta && superResp.meta.super ? superResp.meta.super : null;
        }

        const tables = (superMeta && Array.isArray(superMeta.tables))
          ? superMeta.tables.map(t => (t && t.name) ? String(t.name) : '').filter(Boolean)
          : [];

        // Disabled broken per-table schema fetch (incomplete block caused SyntaxError during parsing).
        // Original fragment kept here for context:
        // if (schemaResp && schemaResp.ok && Array.isArray(schemaResp.schema) && schemaResp.schema.length > 0) {
        //   const firstRow = schemaResp.schema[0];
        //   const cols = Object.keys(firstRow || {});
        //   hint[tableName] = { columns: cols };
        // }
        // } catch (e) {
        //   console.error('Failed to load schema for table', tableName, e);
        // }
        // }
        const hint = {};
        for (const tableName of tables) {
          hint[tableName] = { columns: [] };
        }

        window.__hintTables = hint;

        if (window.editor) {
          window.editor.setOption('hintOptions', buildSqlHintOptions());
        }
      } catch (e) {
        console.error('Schema load failed:', e);
      }
    }

    // --- execution timing state ---
    let execStartTime = null;
    let execTimerId = null;

        async function executeSQL(page) {
      const session = __getActiveExecSession ? __getActiveExecSession() : null;
      const userHash = USER_HASH;
      const pageSize = 1000;
      const query = window.editor.getValue().trim();
      const { organization, superName } = getTenant();

      const errorDisplay = document.getElementById('query-error-display');
      const timingCard = document.getElementById('timings-visualization-card');
      const resultDiv = document.getElementById('result');

      // Reset error and timing display (active session UI)
      errorDisplay.style.display = 'none';
      timingCard.style.display = 'none';
      resultDiv.innerHTML = '<div class="muted text-sm" style="padding: 15px;">Loading results...</div>';
      if (window.timingsChartInstance) {
            window.timingsChartInstance.destroy();
            window.timingsChartInstance = null;
        }

      if (session) {
        session.errorVisible = false;
        session.errorTitle = '';
        session.errorMessage = '';
        session.rows = [];
        session.timings = null;
        session.innerTab = 'result';
      }

      switchTab('result');

      if (!organization || !superName || !userHash) {
        if (session) {
          session.errorVisible = true;
          session.errorTitle = 'Input Error';
          session.errorMessage = 'Please select a SuperTable.';
          session.statusText = 'Failed';
          session.statusCls = 'error';
        }
        displayError('Input Error', 'Please select a SuperTable.');
        return;
      }
      if (!/^\s*(select|with)\b/i.test(query)) {
        if (session) {
          session.errorVisible = true;
          session.errorTitle = 'Input Error';
          session.errorMessage = 'Only SELECT/WITH queries are allowed.';
          session.statusText = 'Failed';
          session.statusCls = 'error';
        }
        displayError('Input Error', 'Only SELECT/WITH queries are allowed.');
        return;
      }

      const startedAt = Date.now();
      execStartTime = startedAt;

      if (execTimerId) {
        clearInterval(execTimerId);
        execTimerId = null;
      }

      execTimerId = setInterval(() => {
        if (execStartTime === null) return;
        const elapsedSec = (Date.now() - execStartTime) / 1000;
        const text = `Executingâ€¦ ${elapsedSec.toFixed(1)}s`;
        setStatus(text, 'executing');
      }, 150);

      setStatus('Executingâ€¦', 'executing');

      // Per-session cancellation
      let abortController = null;
      if (session) {
        if (session.abortController) {
          try { session.abortController.abort(); } catch (e) {}
        }
        abortController = new AbortController();
        session.abortController = abortController;
        session.isExecuting = true;
        session.query = query;
      } else {
        abortController = new AbortController();
      }

      try {
        const data = await api('/reflection/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          signal: abortController.signal,
          body: JSON.stringify({
            organization,
            super_name: superName,
            user_hash: userHash,
            query,
            page: 1,
            page_size: pageSize
          })
        });

        const finishedAt = Date.now();
        const elapsedMsClient = finishedAt - startedAt;

        execStartTime = null;
        if (execTimerId) {
          clearInterval(execTimerId);
          execTimerId = null;
        }

        const activeNow = __getActiveExecSession ? __getActiveExecSession() : null;
        const isActive = session && activeNow && session.id === activeNow.id;

        if (data.status === 'ok') {
          const timings = (data.meta && data.meta.timings) ? data.meta.timings : null;

          let durationMs = null;
          if (typeof data.duration_ms === 'number') {
            durationMs = data.duration_ms;
          } else if (typeof data.duration === 'number') {
            durationMs = data.duration;
          } else {
            durationMs = elapsedMsClient;
          }

          const durationStr = (durationMs / 1000).toFixed(3) + 's';

          const metaErr = extractExecuteError(data);
          if (metaErr) {
            const errStatusText = `${metaErr.summary} â€” in ${durationStr}`;

            if (session) {
              session.errorVisible = true;
              session.errorTitle = metaErr.title;
              session.errorMessage = metaErr.message;
              session.rows = [];
              session.timings = timings || null;
              session.statusText = errStatusText;
              session.statusCls = 'error';
              session.innerTab = 'result';
            }

            if (isActive) {
              setStatus(errStatusText, 'error');
              displayError(metaErr.title, metaErr.message, errStatusText);
              if (timings) {
                renderTimingsChart(timings);
              }
            }
            return;
          }

          const rows = data.result || [];
          const rowsLen = rows.length;
          const total = data.total_count || 0;

          const statusText =
            `Success â€” ${rowsLen} rows (total ${total}) in ${durationStr}`;

          if (session) {
            session.rows = rows;
            session.timings = timings || null;
            session.errorVisible = false;
            session.errorTitle = '';
            session.errorMessage = '';
            session.statusText = statusText;
            session.statusCls = '';
            session.innerTab = window.__activeInnerTabName || session.innerTab || 'result';
          }

          if (isActive) {
            renderTable(
              rows,
              total,
              1,
              pageSize,
              (p) => executeSQL(p),
              statusText
            );

            if (timings) {
              renderTimingsChart(timings);
            }

            setStatus(statusText);
          }
        } else {
          const finishedAtError = Date.now();
          const elapsedErrorSec = ((finishedAtError - startedAt) / 1000).toFixed(3);

          const msg = data.message || 'Unknown error';

          if (session) {
            session.errorVisible = true;
            session.errorTitle = 'Query Error';
            session.errorMessage = msg;
            session.rows = [];
            session.timings = null;
            session.statusText = `Error executing query after ${elapsedErrorSec}s`;
            session.statusCls = 'error';
            session.innerTab = 'result';
          }

          if (isActive) {
            setStatus(`Error executing query after ${elapsedErrorSec}s`, 'error');
            displayError('Query Error', msg);
          }
        }
      } catch (e) {
        if (e && e.name === 'AbortError') {
          if (session) {
            session.statusText = 'Cancelled';
            session.statusCls = '';
            session.isExecuting = false;
            session.abortController = null;
          }
          const activeNow = __getActiveExecSession ? __getActiveExecSession() : null;
          const isActive = session && activeNow && session.id === activeNow.id;
          if (isActive) setStatus('Cancelled');
          return;
        }

        const finishedAt = Date.now();
        const elapsedSec = ((finishedAt - startedAt) / 1000).toFixed(3);

        execStartTime = null;
        if (execTimerId) {
          clearInterval(execTimerId);
          execTimerId = null;
        }

        if (session) {
          session.errorVisible = true;
          session.errorTitle = 'Network Error';
          session.errorMessage = e.message || String(e);
          session.rows = [];
          session.timings = null;
          session.statusText = `Error executing query after ${elapsedSec}s`;
          session.statusCls = 'error';
          session.innerTab = 'result';
        }

        const activeNow = __getActiveExecSession ? __getActiveExecSession() : null;
        const isActive = session && activeNow && session.id === activeNow.id;
        if (isActive) {
          setStatus(`Error executing query after ${elapsedSec}s`, 'error');
          displayError('Network Error', e.message || String(e), `Error executing query after ${elapsedSec}s`);
        }
      } finally {
        if (session && session.abortController === abortController) {
          session.abortController = null;
          session.isExecuting = false;
        }
      }
    }

    function copyToClipboard() {
      if (!window.__curRows || window.__curRows.length === 0) {
        alert("No results to copy.");
        return;
      }

      const headers = window.__curHeaders || [];
      const rows = window.__curRows;

      if (!headers.length) {
        alert("No headers available to copy.");
        console.error("Clipboard failed: __curHeaders is empty.", { headers, rows });
        return;
      }

      let tsv = headers.join('\t') + '\n';

      rows.forEach(row => {
        const values = headers.map(header => {
          let value = row[header];
          if (value === null || value === undefined) value = '';
          if (typeof value === 'object') value = JSON.stringify(value);

          value = String(value).replace(/(\r\n|\n|\r)/g, ' ');

          if (value.includes('\t') || value.includes('"')) {
            value = '"' + value.replace(/"/g, '""') + '"';
          }
          return value;
        });
        tsv += values.join('\t') + '\n';
      });

      if (tsv.trim().length <= 1) {
        alert('Error: Data for clipboard is empty. Check if headers are available.');
        console.error('Clipboard failed: TSV string is empty or nearly empty. TSV content:', tsv);
        return;
      }

      const textToCopy = tsv;

      const btn = document.querySelector('.btn-clipboard');
      const originalText = btn ? btn.innerHTML : null;

      const showSuccess = () => {
        if (!btn) return;
        btn.innerHTML = '<i class="fas fa-check"></i>&nbsp;Copied!';
        setTimeout(() => { btn.innerHTML = originalText; }, 1500);
      };

      const fallbackCopy = () => {
        try {
          const textarea = document.createElement('textarea');
          textarea.value = textToCopy;
          textarea.style.position = 'fixed';
          textarea.style.left = '-9999px';
          textarea.style.top = '0';
          textarea.setAttribute('readonly', '');
          document.body.appendChild(textarea);
          textarea.select();
          const successful = document.execCommand('copy');
          document.body.removeChild(textarea);

          if (!successful) {
            throw new Error('document.execCommand("copy") returned false');
          }

          console.log('Successfully copied (fallback) ' + rows.length + ' rows to clipboard.');
          showSuccess();
        } catch (err) {
          console.error('Fallback copy failed:', err);
          alert('Failed to copy to clipboard. Your browser or environment may block clipboard access.');
        }
      };

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textToCopy)
          .then(() => {
            console.log('Successfully copied ' + rows.length + ' rows to clipboard (TSV format).');
            showSuccess();
          })
          .catch(err => {
            console.warn('navigator.clipboard.writeText failed, trying fallback. Error:', err);
            fallbackCopy();
          });
      } else {
        fallbackCopy();
      }
    }

    function downloadCSV() {
        if (!window.__curRows || window.__curRows.length === 0) {
            alert("No results to download.");
            return;
        }

        const headers = window.__curHeaders;
        const rows = window.__curRows;

        let csv = headers.join(',') + '\n';

        rows.forEach(row => {
            const values = headers.map(header => {
                let value = row[header];
                if (value === null || value === undefined) value = '';
                if (typeof value === 'object') value = JSON.stringify(value);

                value = String(value).replace(/"/g, '""');
                if (value.includes(',') || value.includes('\n') || value.includes('\r')) {
                    value = '"' + value + '"';
                }
                return value;
            });
            csv += values.join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');

        const superName = currentSuper ? currentSuper.replace(/\s/g, '_') : 'query_result';
        link.download = `${superName}_${new Date().toISOString().slice(0, 10)}.csv`;
        link.href = URL.createObjectURL(blob);
        link.click();
        URL.revokeObjectURL(link.href);
    }

    

    // --- Save as RBAC View (stored in Redis; managed on /reflection/rbac) ---
    function __setSaveViewStatus(text, isError) {
      const el = document.getElementById('saveViewStatus');
      if (!el) return;
      el.style.display = 'block';
      el.style.color = isError ? '#b91c1c' : '#0f766e';
      el.textContent = text;
    }

    function openSaveViewModal() {
      const { organization, superName } = getTenant();
      const q = window.editor ? String(window.editor.getValue() || '').trim() : '';

      if (!organization || !superName) {
        alert('Please select a SuperTable first.');
        return;
      }
      if (!/^\s*(select|with)\b/i.test(q)) {
        alert('Only SELECT/WITH queries can be saved as a view.');
        return;
      }

      const orgEl = document.getElementById('saveViewOrg');
      const supEl = document.getElementById('saveViewSup');
      const nameEl = document.getElementById('saveViewName');
      const descEl = document.getElementById('saveViewDesc');
      const qEl = document.getElementById('saveViewQueryPreview');
      const stEl = document.getElementById('saveViewStatus');
      const manage = document.getElementById('saveViewManageLink');

      if (orgEl) orgEl.textContent = organization;
      if (supEl) supEl.textContent = superName;
      if (qEl) qEl.value = q;
      if (stEl) stEl.style.display = 'none';

      // Default name suggestion (non-destructive)
      if (nameEl && !nameEl.value) {
        const ts = new Date().toISOString().slice(0, 16).replace('T', ' ');
        nameEl.value = `View (${superName}) ${ts}`;
      }
      if (descEl && !descEl.value) descEl.value = '';

      if (manage) {
        const url = new URL('/reflection/rbac', window.location.origin);
        url.searchParams.set('org', organization);
        url.searchParams.set('sup', superName);
        manage.href = url.toString();
      }

      $('#saveViewModal').modal('show');
      try { if (nameEl) nameEl.focus(); } catch (e) {}
    }

    async function saveViewNow() {
      const { organization, superName } = getTenant();
      const q = window.editor ? String(window.editor.getValue() || '').trim() : '';

      const nameEl = document.getElementById('saveViewName');
      const descEl = document.getElementById('saveViewDesc');
      const btn = document.getElementById('btnSaveViewConfirm');

      const name = nameEl ? String(nameEl.value || '').trim() : '';
      const description = descEl ? String(descEl.value || '').trim() : '';

      if (!organization || !superName) {
        __setSaveViewStatus('Missing organization/super_name.', true);
        return;
      }
      if (!name) {
        __setSaveViewStatus('View name is required.', true);
        return;
      }
      if (!/^\s*(select|with)\b/i.test(q)) {
        __setSaveViewStatus('Only SELECT/WITH queries can be saved as a view.', true);
        return;
      }

      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>&nbsp;Savingâ€¦';
      }

      try {
        const resp = await api('/reflection/rbac/views', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            organization,
            super_name: superName,
            name,
            description,
            query: q
          })
        });

        __setSaveViewStatus('Saved successfully.', false);

        // Close after a short moment so the user sees success feedback.
        setTimeout(() => {
          try { $('#saveViewModal').modal('hide'); } catch (e) {}
        }, 350);

        console.log('Saved view:', resp);
      } catch (e) {
        __setSaveViewStatus(e && e.message ? e.message : String(e), true);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-check"></i>&nbsp;Save';
        }
      }
    }
$(document).ready(function(){
      window.__admintoken = "{{ token|e }}";

      $("#toggleSidebar").on("click", function() {
        $("#sidebar").toggleClass("sidebar-collapsed");
        localStorage.setItem('st_sidebar_collapsed',
          $("#sidebar").hasClass("sidebar-collapsed"));
      });

      if (localStorage.getItem('st_sidebar_collapsed') === 'true') {
        $("#sidebar").addClass("sidebar-collapsed");
      }

      $("#link-execute").addClass("active");

      if (!window.__st_selection_component) {
        loadTenants();
      }

      __mountInnerTabs();
      __initExecSessions();

      const __sv = document.getElementById('btnSaveView');
      if (__sv) __sv.addEventListener('click', () => openSaveViewModal());
      const __sv2 = document.getElementById('btnSaveViewConfirm');
      if (__sv2) __sv2.addEventListener('click', () => saveViewNow());

      switchTab('execute');
    });
  </script>
</head>
<body>
  {% include "sidebar.html" %}

  <div class="content-container">
    <div class="wrap">

      {% include "selection.html" %}

      {% if has_tenant %}

      <div id="exec-navigation" style="margin: 0 6px 14px 6px;">
        <button type="button" class="tab-add" id="btnNewExecution" title="New execution">+</button>
        <div id="openExecTabs" style="display:flex; gap:24px; align-items:center; flex-wrap:wrap;"></div>
      </div>

      <div id="tab-navigation">
          <div id="tab-execute" class="tab active" onclick="switchTab('execute')">
              <i class="fas fa-terminal"></i>&nbsp;Execute
          </div>
          <div id="tab-result" class="tab" onclick="switchTab('result')">
              <i class="fas fa-table"></i>&nbsp;Result
          </div>
          <div id="tab-timings" class="tab" onclick="switchTab('timings')">
              <i class="fas fa-chart-bar"></i>&nbsp;Timings
          </div>
      </div>

      <div id="tab-content-container">

          <div id="inner-tab-mount"></div>

          <div id="tab-content-execute" class="tab-content active">
              <div class="card sql-editor-card">
                  <div class="card-body">
                      <div style="margin-top:0;">
                        <label class="text-sm muted">SQL Query</label>
                        <textarea id="sql" rows="8"></textarea>
                      </div>

                      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px;">
                        <div id="status" class="text-sm muted">
                          <i class="fas fa-circle" style="font-size:8px;"></i>&nbsp;Ready
                        </div>
                        <div style="display:flex; gap:8px;">
                          <button id="btnSaveView" type="button" class="btn">
  <i class="fas fa-save"></i>&nbsp;Save View
</button>

                          <button id="btnExec" class="btn-exec">
                            <i class="fas fa-play"></i>&nbsp;Execute
                          </button>
                        </div>
                      </div>
                  </div>
              </div>
          </div>

          <div id="tab-content-result" class="tab-content">
              <div id="query-error-display" class="mb-4">
                  <strong>Query Error:</strong>
                  <span id="query-error-message"></span>
              </div>

              <div class="card" id="result-card">
                <div class="section">
                  <div id="result"></div>
                  <div class="download-row">
                    <button class="btn-clipboard" onclick="copyToClipboard()">
                      <i class="fas fa-clipboard"></i>&nbsp;Copy to Clipboard
                    </button>
                    <button class="btn-download" onclick="downloadCSV()">
                      <i class="fas fa-file-csv"></i>&nbsp;Download CSV
                    </button>
                  </div>
                </div>
              </div>
          </div>

          <div id="tab-content-timings" class="tab-content">
              <div id="timings-visualization-card" class="card">
                  <div class="section" style="padding-bottom: 0; border-bottom: 1px solid var(--panel-border);">
                      <h4>Query Execution Timings</h4>
                      <div class="text-xs muted" style="margin-bottom: 16px;">
                          Internal execution steps excluding total query time.
                      </div>
                  </div>
                  <div class="chart-container">
                      <canvas id="timingsChart"></canvas>
                  </div>
              </div>
          </div>

      

      <!-- Save as RBAC View Modal -->
      <div class="modal fade" id="saveViewModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content" style="border-radius: 12px;">
            <div class="modal-header" style="background: var(--header-bg); border-bottom: 1px solid var(--panel-border);">
              <h5 class="modal-title" style="margin:0; font-weight:700;">Save as RBAC View</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="text-sm muted" style="margin-bottom: 10px;">
                Organization: <strong id="saveViewOrg"></strong> &nbsp;â€¢&nbsp; SuperTable: <strong id="saveViewSup"></strong>
              </div>

              <div class="form-group">
                <label class="text-sm muted" for="saveViewName">View name</label>
                <input id="saveViewName" type="text" class="form-control" placeholder="e.g. Active customers (EU)" maxlength="120" />
              </div>

              <div class="form-group">
                <label class="text-sm muted" for="saveViewDesc">Description (optional)</label>
                <textarea id="saveViewDesc" class="form-control" rows="3" placeholder="Short description" maxlength="2000"></textarea>
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label class="text-sm muted" for="saveViewQueryPreview">Query</label>
                <textarea id="saveViewQueryPreview" class="form-control" rows="6" readonly></textarea>
              </div>

              <div id="saveViewStatus" class="text-sm" style="margin-top: 10px; display:none;"></div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--panel-border);">
              <a id="saveViewManageLink" class="text-sm" href="#" style="margin-right:auto;">Manage saved views</a>
              <button type="button" class="btn" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn-exec" id="btnSaveViewConfirm">
                <i class="fas fa-check"></i>&nbsp;Save
              </button>
            </div>
          </div>
        </div>
      </div>

</div> {% endif %}
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/sql/sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/sql-hint.min.js"></script>

  <script>
    // Initialize CodeMirror + IntelliSense hooks
    window.__admintoken = "{{ token|e }}";

    // Helper to build consistent hintOptions from the current schema
    function buildSqlHintOptions() {
      return {
        completeSingle: false,
        tables: window.__hintTables || {},
        keywords: {
          "WITH": { className: "cm-cte" },
          "RECURSIVE": { className: "cm-cte" }
        }
      };
    }

    // Custom SQL IntelliSense helper: table/column aware
    CodeMirror.registerHelper("hint", "sqlEnhanced", function(cm, options) {
      const cursor = cm.getCursor();
      const token = cm.getTokenAt(cursor);
      const line = cm.getLine(cursor.line);
      const start = token.start;
      const end = token.end;
      const currentWord = token.string.toLowerCase();
      const lineText = line.substring(0, cursor.ch);

      const isAfterSelect = /SELECT\s+([^,]*)$/i.test(lineText);
      const isAfterFrom   = /FROM\s+([^,]*)$/i.test(lineText);
      const isAfterDot    = /(\w+)\.([^,]*)$/i.test(lineText);

      const tables = (options && options.tables) || window.__hintTables || {};
      const completions = [];

      if (isAfterSelect && !isAfterFrom) {
        // After SELECT: show columns + functions
        for (const tableName in tables) {
          const columns = tables[tableName].columns || [];
          columns.forEach(column => {
            completions.push({ text: column, displayText: column, className: "cm-column" });
            completions.push({
              text: `${tableName}.${column}`,
              displayText: `${tableName}.${column}`,
              className: "cm-column"
            });
          });
        }

        const sqlFunctions = [
          "COUNT", "SUM", "AVG", "MIN", "MAX",
          "CONCAT", "SUBSTRING", "UPPER", "LOWER"
        ];
        sqlFunctions.forEach(func => {
          completions.push({
            text: `${func}()`,
            displayText: `${func}()`,
            className: "cm-function"
          });
        });
      } else if (isAfterFrom) {
        // After FROM: show tables
        for (const tableName in tables) {
          completions.push({
            text: tableName,
            displayText: tableName + " (table)",
            className: "cm-table"
          });
        }
      } else if (isAfterDot) {
        // After table.: show columns of that table
        const matches = lineText.match(/(\w+)\.([^,]*)$/i);
        const tableName = matches ? matches[1] : null;
        const table = tableName ? tables[tableName] : null;

        if (table) {
          const columns = table.columns || [];
          columns.forEach(column => {
            completions.push({
              text: column,
              displayText: column,
              className: "cm-column"
            });
          });
        }
      } else {
        // Default: tables + columns + keywords
        for (const tableName in tables) {
          completions.push({
            text: tableName,
            displayText: tableName + " (table)",
            className: "cm-table"
          });

          const columns = tables[tableName].columns || [];
          columns.forEach(column => {
            completions.push({
              text: column,
              displayText: column + " (" + tableName + ")",
              className: "cm-column"
            });
            completions.push({
              text: `${tableName}.${column}`,
              displayText: `${tableName}.${column}`,
              className: "cm-column"
            });
          });
        }

        const keywords = [
          "SELECT", "FROM", "WHERE", "GROUP BY", "ORDER BY",
          "LIMIT", "JOIN", "LEFT", "RIGHT", "INNER", "OUTER", "WITH"
        ];
        keywords.forEach(keyword => {
          completions.push({
            text: keyword,
            displayText: keyword,
            className: "cm-keyword"
          });
        });
      }

      const filtered = completions
        .filter(item => item.text.toLowerCase().includes(currentWord))
        .sort((a, b) => a.text.localeCompare(b.text));

      return {
        list: filtered,
        from: CodeMirror.Pos(cursor.line, start),
        to: CodeMirror.Pos(cursor.line, end)
      };
    });

    // --- Dynamic Query Setup ---
    const leaf = getURLParameter('leaf');
    const defaultSuperName = '{{ sel_sup }}';

    let initialQuery;
    if (leaf) {
        initialQuery = `SELECT * FROM ${defaultSuperName}.${leaf} LIMIT 1000`;
    } else {
        initialQuery = `SELECT * FROM ${defaultSuperName} LIMIT 100`;
    }

    document.getElementById('sql').value = initialQuery;

    window.editor = CodeMirror.fromTextArea(document.getElementById('sql'), {
      mode: "text/x-sql",
      theme: 'default',
      lineNumbers: true,
      matchBrackets: true,
      lineWrapping: true,
      extraKeys: {
        "Ctrl-Enter": function(cm){ executeSQL(1); return false; },
        "Cmd-Enter": function(cm){ executeSQL(1); return false; },
        "Ctrl-Space": function(cm){
          cm.showHint({
            completeSingle:false,
            hint: CodeMirror.hint.sqlEnhanced,
            tables: window.__hintTables || {}
          });
        },
        "Tab": function(cm){
          cm.showHint({
            completeSingle:false,
            hint: CodeMirror.hint.sqlEnhanced,
            tables: window.__hintTables || {}
          });
          return false;
        }
      },
      hintOptions: buildSqlHintOptions()
    });

    // Auto-trigger IntelliSense on common trigger characters
    window.editor.on('inputRead', function(cm, input) {
      const triggerChars = ['.', ' ', ',', '(', ')'];
      if (input.text && triggerChars.includes(input.text[0])) {
        setTimeout(function() {
          cm.showHint({
            completeSingle: false,
            hint: CodeMirror.hint.sqlEnhanced,
            tables: window.__hintTables || {}
          });
        }, 120);
      }
    });

    window.editor.refresh();

    const execBtn = document.getElementById('btnExec');
    if (execBtn) {
      execBtn.addEventListener('click', () => executeSQL(1));
    }
  </script>
</body>
</html>