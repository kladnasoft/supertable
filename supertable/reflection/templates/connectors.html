{% extends "base.html" %}

{% block title %}Connectors{% endblock %}

{% block head_extra %}
<style>
  .muted { color:#64748b; font-size: 12px; }
  .mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  .root {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    padding: 24px 28px;
    border: 1px solid rgba(0,0,0,0.05);
    border-left: 5px solid #1c96ca;
  }

  .title { font-size: 20px; font-weight: 900; color:#0f172a; margin-bottom: 4px; }

  .panel {
    border: 1px solid rgba(15,23,42,.10);
    border-radius: 16px;
    background: #fff;
    padding: 16px;
  }
  .panel + .panel { margin-top: 16px; }
  .panel-head {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }
  .panel-title {
    font-weight: 900;
    color:#0f172a;
    display:flex;
    align-items:center;
    gap: 8px;
    font-size: 14px;
  }

  .btn-azure-outline {
    border: 1px solid #1c96ca;
    background: transparent;
    color: #1c96ca;
    font-weight: 600;
    transition: all 0.2s ease;
  }
  .btn-azure-outline:hover { background: #1c96ca; color: #ffffff; }

  .btn-danger-outline {
    border: 1px solid rgba(239,68,68,0.75);
    background: transparent;
    color: rgba(239,68,68,0.9);
    font-weight: 700;
    transition: all 0.2s ease;
  }
  .btn-danger-outline:hover { background: rgba(239,68,68,0.9); color:#fff; }

  .grid2 { display:grid; grid-template-columns: 1fr 1.2fr; gap: 16px; margin-top: 10px; }
  @media (max-width: 980px) { .grid2 { grid-template-columns: 1fr; } }

  .card {
    border: 1px solid rgba(15,23,42,.10);
    border-radius: 12px;
    background:#fff;
    padding: 16px;
    height: 100%;
  }

  pre {
    margin: 10px 0 0 0;
    padding: 12px;
    border-radius: 8px;
    background: #f8fafc;
    border: 1px solid rgba(15,23,42,.08);
    font-size: 12px;
    white-space: pre-wrap;
    color: #334155;
  }

  .toast {
    position: fixed;
    right: 18px;
    top: 16px;
    z-index: 5000;
    background: #0f172a;
    color: #fff;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 13px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    display:none;
  }

  .list-item {
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid transparent;
    cursor: pointer;
    margin-bottom: 4px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    transition: background 0.2s;
  }
  .list-item:hover { background: #f1f5f9; }
  .list-item.active {
    background: rgba(28,150,202,0.08);
    border-color: #1c96ca;
    font-weight: 600;
  }

  .pill {
    display:inline-flex;
    align-items:center;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #e2e8f0;
    background: #fff;
    font-size: 11px;
    font-weight: 500;
    color: #64748b;
    transition: all 0.2s;
  }
  .pill-btn { cursor:pointer; }
  .pill-btn:hover { border-color: #1c96ca; color: #1c96ca; background: #f0f9ff; }

  textarea.mono {
    resize: vertical;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 10px;
    font-size: 12px;
  }
  textarea.mono:focus {
    border-color: #1c96ca;
    outline: none;
    box-shadow: 0 0 0 2px rgba(28,150,202,0.1);
  }
</style>
{% endblock %}

{% block content %}
{% include "selection.html" %}
<div style="height: 18px;"></div>

<div id="root" class="root" data-org="{{ sel_org }}" data-sup="{{ sel_sup }}" data-user-hash="{{ session_user_hash }}">
  <div class="panel-head" style="margin-bottom: 20px;">
    <div>
      <div class="title">Connector Hub</div>
      <div class="muted">
        Configure Airbyte instances or create portable PyAirbyte (notebook) snippets.
      </div>
    </div>
  </div>

  {% if not has_tenant %}
    <div class="card" style="text-align: center; padding: 40px;">
      <i class="fas fa-building-user fa-3x" style="color: #cbd5e1; margin-bottom: 16px;"></i>
      <div style="color:#64748b; font-weight: 500;">Select a tenant to manage connectors.</div>
    </div>
  {% else %}
    <div class="panel">
      <div class="panel-head">
        <div class="panel-title"><i class="fas fa-terminal" style="color:#1c96ca;"></i> PyAirbyte (Notebook Ready)</div>
        <div class="muted" id="pyairbyteStatus2">Checking status...</div>
      </div>

      <div class="grid2">
        <div>
          <div style="display:flex; gap:8px; margin-bottom:12px;">
            <select id="paKind" class="form-control form-control-sm" style="width:120px; border-radius: 8px;">
              <option value="source">Source</option>
              <option value="destination">Destination</option>
            </select>
            <input id="paSearch" class="form-control form-control-sm" placeholder="Search registry..." style="flex:1; border-radius: 8px;" />
            <button class="btn btn-sm btn-azure-outline" id="btnPaLoad" title="Refresh local list"><i class="fas fa-sync"></i></button>
          </div>

          <div id="paPopular" style="margin-bottom:12px;"></div>

          <div class="card" style="max-height: 500px; overflow: hidden; display: flex; flex-direction: column;">
            <div style="display:flex; justify-content:space-between; margin-bottom: 8px;">
              <span style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #94a3b8;">Registry</span>
              <span class="muted" id="paCount"></span>
            </div>
            <div id="paList" style="flex:1; overflow-y:auto; padding-right: 4px;"></div>
          </div>
        </div>

        <div class="card">
          <div id="paPlaceholder" style="text-align: center; padding: 60px 20px;">
            <i class="fas fa-mouse-pointer fa-2x" style="color: #e2e8f0; margin-bottom: 12px;"></i>
            <div class="muted">Select a connector to begin configuration</div>
          </div>

          <div id="paEditor" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px;">
              <div class="panel-title" id="paSelectedTitle">Connector Name</div>
              <button class="btn btn-sm btn-azure-outline" id="btnPaSpec"><i class="fas fa-book-open"></i> Show Schema</button>
            </div>

            <pre id="paSpec" class="mono" style="max-height:150px; overflow:auto; display:none; margin-bottom: 12px;"></pre>

            <div style="margin-bottom: 12px;">
              <label class="muted" style="display:block; margin-bottom:4px;">Configuration (JSON)</label>
              <textarea id="paConfig" class="form-control mono" style="height:160px;" placeholder='{ "host": "..." }'></textarea>
            </div>

            <div style="display:flex; gap:8px; align-items:center; margin-bottom: 16px;">
              <input id="paName" class="form-control form-control-sm" placeholder="Unique name (e.g. production_db)" style="flex:1;" />
              <button class="btn btn-sm btn-azure-outline" id="btnPaTest"><i class="fas fa-vial"></i> Test</button>
              <button class="btn btn-sm btn-azure-outline" id="btnPaSave"><i class="fas fa-save"></i> Save</button>
            </div>

            <pre id="paTestOut" class="mono" style="max-height:120px; overflow:auto; display:none; border-left: 4px solid #1c96ca;"></pre>

            <div style="margin-top: 16px; border-top: 1px solid #f1f5f9; padding-top: 16px;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                <span class="panel-title" style="font-size: 12px;"><i class="fas fa-code"></i> Python Snippet</span>
                <div style="display:flex; gap: 4px;">
                    <button class="btn btn-xs btn-azure-outline" id="btnPaGen" style="font-size: 10px; padding: 2px 8px;">Regenerate</button>
                    <button class="btn btn-xs btn-azure-outline" id="btnPaCopy" style="font-size: 10px; padding: 2px 8px;"><i class="fas fa-copy"></i> Copy</button>
                </div>
              </div>
              <pre id="paCodeOut" class="mono" style="max-height:180px; overflow:auto; background: #0f172a; color: #f8fafc; border:none;"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-head" style="cursor: pointer;" onclick="document.getElementById('abSection').style.display = document.getElementById('abSection').style.display === 'none' ? 'block' : 'none'">
        <div class="panel-title"><i class="fas fa-server" style="color:#1c96ca;"></i> Airbyte Instance Manager</div>
        <div class="muted">Create sources/destinations in a running Airbyte server <i class="fas fa-chevron-down" style="margin-left:5px;"></i></div>
      </div>

      <div id="abSection" style="display:none; margin-top: 12px;">
        <div class="grid2">
          <div>
            <label class="muted">Airbyte Base URL</label>
            <input class="form-control form-control-sm" id="abBaseUrl" placeholder="http://localhost:8000" />
          </div>
          <div>
            <label class="muted">Workspace</label>
            <div style="display:flex; gap:8px;">
              <select class="form-control form-control-sm" id="abWorkspace" style="flex:1;"></select>
              <button class="btn btn-sm btn-azure-outline" id="btnLoadWorkspaces"><i class="fas fa-sync"></i></button>
              <button class="btn btn-sm btn-azure-outline" id="btnLoadDefs">Load Connectors</button>
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top:16px;">
          <div class="card">
            <div class="panel-title" style="margin-bottom:12px;"><i class="fas fa-sign-in-alt"></i> New Source</div>
            <select class="form-control form-control-sm mb-2" id="srcDef"></select>
            <input class="form-control form-control-sm mb-2" id="srcName" placeholder="Source Name" />
            <textarea class="form-control form-control-sm mono" id="srcCfg" rows="6" placeholder="Config JSON"></textarea>
            <div style="display:flex; gap:8px; margin-top:10px;">
                <button class="btn btn-sm btn-azure-outline" id="btnCreateSource">Push to Airbyte</button>
                <button class="btn btn-sm btn-azure-outline" id="btnSaveSource">Save Draft</button>
            </div>
          </div>
          <div class="card">
            <div class="panel-title" style="margin-bottom:12px;"><i class="fas fa-sign-out-alt"></i> New Destination</div>
            <select class="form-control form-control-sm mb-2" id="dstDef"></select>
            <input class="form-control form-control-sm mb-2" id="dstName" placeholder="Destination Name" />
            <textarea class="form-control form-control-sm mono" id="dstCfg" rows="6" placeholder="Config JSON"></textarea>
            <div style="display:flex; gap:8px; margin-top:10px;">
                <button class="btn btn-sm btn-azure-outline" id="btnCreateDest">Push to Airbyte</button>
                <button class="btn btn-sm btn-azure-outline" id="btnSaveDest">Save Draft</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-head">
        <div class="panel-title"><i class="fas fa-archive"></i> Saved Connectors</div>
        <button class="btn btn-sm btn-azure-outline" id="btnLoadSaved"><i class="fas fa-sync"></i> Refresh</button>
      </div>
      <div id="savedList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:12px;"></div>
      <div id="savedEmpty" class="muted" style="display:none; text-align:center; padding: 20px;">No saved connectors found.</div>
    </div>
  {% endif %}
</div>

<div class="toast" id="toast"></div>

{% endblock %}

{% block body_scripts %}
<script>
(function () {
  const ln = document.getElementById("link-connectors");
  if (ln) ln.classList.add("active");

  function toast(msg) {
    const el = document.getElementById('toast');
    if (!el) return;
    el.textContent = String(msg || '');
    el.style.display = 'block';
    clearTimeout(toast._t);
    toast._t = setTimeout(() => { el.style.display = 'none'; }, 2500);
  }

  function root() { return document.getElementById('root'); }
  function ctx() {
    const r = root();
    return {
      org: r ? (r.dataset.org || '') : '',
      sup: r ? (r.dataset.sup || '') : '',
      userHash: r ? (r.dataset.userHash || '') : '',
    };
  }

  async function postJSON(url, obj) {
    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(obj || {}),
      credentials: "same-origin",
    });
    const text = await resp.text();
    let js = null;
    try { js = JSON.parse(text); } catch (e) {}
    if (!resp.ok) throw new Error((js && (js.detail || js.error)) || text || "Request failed");
    return js;
  }

  async function getJSON(url) {
    const resp = await fetch(url, { credentials: "same-origin" });
    const text = await resp.text();
    let js = null;
    try { js = JSON.parse(text); } catch (e) {}
    if (!resp.ok) throw new Error((js && (js.detail || js.error)) || text || "Request failed");
    return js;
  }

  const paState = { loaded:false, connectors:[], popular:{sources:[],destinations:[]}, selected:null, code:'' };

  function paRenderList() {
    const list = document.getElementById('paList');
    const cnt = document.getElementById('paCount');
    if (!list) return;

    const kind = document.getElementById('paKind').value;
    const term = document.getElementById('paSearch').value.toLowerCase();

    const pref = kind === 'destination' ? 'destination-' : 'source-';
    const filtered = paState.connectors
      .filter(n => n.startsWith(pref) && n.toLowerCase().includes(term));

    if (cnt) cnt.textContent = `${filtered.length} found`;

    list.innerHTML = '';
    filtered.forEach(name => {
      const div = document.createElement('div');
      div.className = 'list-item' + (paState.selected === name ? ' active' : '');
      div.innerHTML = `<span class="mono" style="font-size:12px;">${name.replace(pref, '')}</span>`;
      div.addEventListener('click', () => paSelect(name));
      list.appendChild(div);
    });
  }

  function paSelect(name) {
    paState.selected = name;
    document.getElementById('paPlaceholder').style.display = 'none';
    document.getElementById('paEditor').style.display = 'block';
    document.getElementById('paSelectedTitle').textContent = name;
    document.getElementById('paName').value = name.replace(/[^a-zA-Z0-9]/g, '_');

    // Reset view
    document.getElementById('paSpec').style.display = 'none';
    document.getElementById('paTestOut').style.display = 'none';
    document.getElementById('paCodeOut').textContent = '# Select "Regenerate" to see snippet';

    paRenderList();
    paLoadSpec();
  }

  async function paLoadSpec() {
    const specEl = document.getElementById('paSpec');
    try {
      const js = await postJSON('/reflection/connectors/pyairbyte/spec', {
        kind: document.getElementById('paKind').value,
        connector: paState.selected
      });
      specEl.textContent = JSON.stringify(js.spec || {}, null, 2);
    } catch (e) {
      specEl.textContent = "Spec not available for this connector.";
    }
  }

  async function paTest() {
    const out = document.getElementById('paTestOut');
    out.style.display = 'block';
    out.textContent = "Testing connection...";
    try {
      const cfg = JSON.parse(document.getElementById('paConfig').value || '{}');
      const js = await postJSON('/reflection/connectors/pyairbyte/check', {
        kind: document.getElementById('paKind').value,
        connector: paState.selected,
        config: cfg
      });
      out.textContent = JSON.stringify(js, null, 2);
    } catch (e) {
      out.textContent = "Error: " + e.message;
    }
  }

  async function paGenerateCode() {
    try {
      const cfg = JSON.parse(document.getElementById('paConfig').value || '{}');
      const js = await postJSON('/reflection/connectors/pyairbyte/codegen', {
        kind: document.getElementById('paKind').value,
        connector: paState.selected,
        config: cfg,
        name: document.getElementById('paName').value
      });
      paState.code = js.code;
      document.getElementById('paCodeOut').textContent = js.code;
      toast("Snippet generated");
    } catch (e) { toast("Check JSON: " + e.message); }
  }

  async function loadPyAirbyteConnectors() {
    const js = await getJSON('/reflection/connectors/pyairbyte/connectors');
    paState.connectors = (js.connectors || []).sort();
    paState.popular = js.popular || {sources:[],destinations:[]};

    const popWrap = document.getElementById('paPopular');
    popWrap.innerHTML = '';
    const kind = document.getElementById('paKind').value;
    const popList = kind === 'source' ? paState.popular.sources : paState.popular.destinations;

    popList.forEach(p => {
        const pill = document.createElement('div');
        pill.className = 'pill pill-btn mr-1 mb-1';
        pill.textContent = p.replace('source-', '').replace('destination-', '');
        pill.onclick = () => {
            document.getElementById('paSearch').value = p;
            paRenderList();
        };
        popWrap.appendChild(pill);
    });

    paRenderList();
  }

  async function loadSaved() {
    const { org, sup } = ctx();
    const js = await getJSON(`/reflection/connectors/saved?org=${encodeURIComponent(org)}&sup=${encodeURIComponent(sup)}`);
    const wrap = document.getElementById('savedList');
    wrap.innerHTML = '';
    const items = js.data?.items || [];

    document.getElementById('savedEmpty').style.display = items.length ? 'none' : 'block';

    items.forEach(it => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <div style="font-weight:800; font-size:13px;">${it.name} <span class="muted" style="font-weight:400;">(${it.kind})</span></div>
          <button class="btn btn-xs btn-danger-outline" data-id="${it.id}"><i class="fas fa-trash"></i></button>
        </div>
        <div class="muted mono" style="font-size:10px; margin-bottom:8px;">${it.connector || it.definitionId}</div>
        <pre class="mono" style="max-height:80px; font-size:10px; margin:0;">${JSON.stringify(it.connectionConfiguration || {}, null, 1)}</pre>
      `;
      card.querySelector('button').onclick = async () => {
        if(confirm('Delete?')) {
            await fetch(`/reflection/connectors/saved/${it.id}?org=${org}&sup=${sup}`, { method:'DELETE' });
            loadSaved();
        }
      };
      wrap.appendChild(card);
    });
  }

  // Event Listeners
  document.getElementById('btnPaLoad')?.addEventListener('click', loadPyAirbyteConnectors);
  document.getElementById('paSearch')?.addEventListener('input', paRenderList);
  document.getElementById('paKind')?.addEventListener('change', () => { loadPyAirbyteConnectors(); paRenderList(); });
  document.getElementById('btnPaSpec')?.addEventListener('click', () => {
    const s = document.getElementById('paSpec');
    s.style.display = s.style.display === 'none' ? 'block' : 'none';
  });
  document.getElementById('btnPaTest')?.addEventListener('click', paTest);
  document.getElementById('btnPaGen')?.addEventListener('click', paGenerateCode);
  document.getElementById('btnPaCopy')?.addEventListener('click', () => {
    navigator.clipboard.writeText(paState.code);
    toast("Copied to clipboard");
  });
  document.getElementById('btnPaSave')?.addEventListener('click', async () => {
      const { org, sup } = ctx();
      const item = {
          id: 'pa_' + Date.now(),
          name: document.getElementById('paName').value,
          kind: document.getElementById('paKind').value,
          connector: paState.selected,
          connectionConfiguration: JSON.parse(document.getElementById('paConfig').value || '{}'),
          runtime: 'pyairbyte'
      };
      await postJSON('/reflection/connectors/saved/upsert', { org, sup, item });
      toast("Saved to workspace");
      loadSaved();
  });

  // Init
  loadPyAirbyteConnectors();
  loadSaved();
  getJSON('/reflection/connectors/pyairbyte/status').then(js => {
    if(document.getElementById('pyairbyteStatus2'))
        document.getElementById('pyairbyteStatus2').textContent = js.installed ? `PyAirbyte Active (${js.module})` : 'PyAirbyte Not Found';
  });

})();
</script>
{% endblock %}