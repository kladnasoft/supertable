{% extends "base.html" %}

{% block title %}Ingestion{% endblock %}

{% block head_extra %}
<style>
    /* ---- Tabs (match admin.html style) ---- */
  #tab-navigation,
  .tabs-row {
    display: flex;
    gap: 24px;
    margin-top: 16px;
    border-bottom: 1px solid #e2e8f0;
    padding: 0 2px;
    flex-wrap: wrap;
  }

  .tab {
    padding: 8px 0;
    margin-bottom: -1px;
    border: none;
    border-bottom: 2px solid transparent;
    background: transparent;
    cursor: pointer;
    font-size: 13px;
    color: #64748b;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .tab i { font-size: 13px; }

  .tab:hover { color: #0f172a; }

  .tab.active {
    color: #1c96ca;
    border-bottom-color: #1c96ca;
    font-weight: 500;
  }

  .tabpane { margin-top: 16px; }
  .tabpane.hidden { display:none; }

  /* ---- List rows ---- */
  .rowcard {
    margin-top: 10px;
    border: 1px solid rgba(15,23,42,.10);
    border-radius: 14px;
    background: #fff;
    padding: 12px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .rowcard .title { font-weight: 900; color:#0f172a; }
  .rowcard .sub { font-size: 12px; color:#64748b; margin-top:3px; }

  /* ---- Pipe editor ---- */
  .split {
    display:flex;
    gap: 12px;
    margin-top: 12px;
    align-items: stretch;
    flex-wrap: wrap;
  }
  .split .left {
    flex: 1;
    min-width: 260px;
  }
  .split .right {
    flex: 2;
    min-width: 320px;
  }
  #pipeEditor {
    width: 100%;
    min-height: 320px;
    resize: vertical;
    border-radius: 14px;
    border: 1px solid rgba(15,23,42,.14);
    padding: 12px 12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 13px;
    line-height: 1.35;
    background: rgba(248,250,252,.9);
  }

  /* ---- Enable pill ---- */
  .pill { font-size: 12px; padding: 4px 9px; border-radius: 999px; border:1px solid; font-weight: 900; }
  .pill.on { border-color: rgba(16,185,129,35); background: rgba(16,185,129,08); color:#065f46; }
  .pill.off { border-color: rgba(148,163,184,55); background: rgba(148,163,184,10); color:#334155; }

  /* ---- Modal footer ---- */
  #m-footer {
    padding: 12px 15px;
    border-top: 1px solid rgba(15,23,42,.08);
    display:flex;
    justify-content:flex-end;
    gap:10px;
    background: #fff;
  }

  /* Azure-style outline button (match admin.html) */
  .btn-azure-outline {
    border: 1px solid #1c96ca;
    background: transparent;
    color: #1c96ca;
    font-weight: 600;
    transition: background-color 0.2s ease, color 0.2s ease;
  }
  .btn-azure-outline:hover {
    background: #1c96ca;
    color: #ffffff;
  }

  /* ---- Load Data (modern step cards) ---- */
  .load-steps {
    display: grid;
    gap: 14px;
    margin-top: 12px;
  }
  .stepcard {
    border: 1px solid rgba(15,23,42,.10);
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 8px 24px rgba(15,23,42,.06);
    padding: 14px 16px;
  }
  .stephead {
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }
  .stephead .kicker {
    font-size: 12px;
    color: #64748b;
    letter-spacing: .02em;
    font-weight: 700;
  }
  .stephead .title {
    font-size: 14px;
    font-weight: 900;
    color:#0f172a;
    margin-top: 2px;
  }
  .load-row {
    display:flex;
    align-items:center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .file-pill {
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(15,23,42,.12);
    background: rgba(248,250,252,.9);
    font-size: 12px;
    color:#0f172a;
    max-width: 100%;
  }
  .file-pill .name { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; word-break: break-all; }
  .segmented {
    display:inline-flex;
    border: 1px solid rgba(15,23,42,.12);
    border-radius: 999px;
    overflow:hidden;
    background: rgba(248,250,252,.8);
  }
  .segmented button {
    border: 0;
    background: transparent;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 800;
    color: #334155;
    cursor: pointer;
    display:inline-flex;
    align-items:center;
    gap: 7px;
  }
  .segmented button.active {
    background: #1c96ca;
    color: #ffffff;
  }
  .segmented button.active i { color: #ffffff; }
  .segmented button:hover { background: rgba(28,150,202,.10); }
  .segmented button.active:hover { background: #1787b6; }
  .segmented button i { color: #1c96ca; }
  .field {
    display:flex;
    flex-direction:column;
    gap: 6px;
    min-width: 260px;
    flex: 1;
  }
  .field label {
    font-size: 12px;
    color: #64748b;
    font-weight: 800;
  }
  .field input, .field select, .field textarea {
    border-radius: 14px;
    border: 1px solid rgba(15,23,42,.14);
    padding: 10px 12px;
    font-size: 13px;
    background: rgba(248,250,252,.9);
    outline: none;
  }
  .field textarea {
    resize: vertical;
    min-height: 92px;
  }
  .field input.mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  .previewbox {
    border-radius: 14px;
    border: 1px solid rgba(15,23,42,.10);
    background: rgba(248,250,252,.7);
    overflow: hidden;
  }
  .previewhead {
    padding: 10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    border-bottom: 1px solid rgba(15,23,42,.08);
  }
  .previewhead .h {
    font-size: 12px;
    font-weight: 900;
    color:#0f172a;
  }
  .previewbody {
    max-height: 220px;
    overflow:auto;
  }
  .previewtable {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  .previewtable th {
    position: sticky;
    top: 0;
    background: #ffffff;
    text-align:left;
    padding: 8px 8px;
    border-bottom: 1px solid rgba(15,23,42,.10);
    font-weight: 900;
    color:#0f172a;
    white-space: nowrap;
  }
  .previewtable td {
    padding: 7px 8px;
    border-top: 1px solid rgba(15,23,42,.06);
    vertical-align: top;
    max-width: 280px;
    overflow:hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .load-footer {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    flex-wrap: wrap;
  }
  .timer {
    font-size: 12px;
    color:#334155;
    display:inline-flex;
    align-items:center;
    gap: 8px;
  }
  .spinner {
    width: 14px; height: 14px;
    border-radius: 999px;
    border: 2px solid rgba(28,150,202,.25);
    border-top-color: #1c96ca;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .muted { color:#64748b; font-size: 12px; }
  .alert {
    margin-top: 10px;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(15,23,42,.10);
    background: rgba(248,250,252,.9);
    font-size: 12px;
    color:#0f172a;
  }
  .alert.ok { border-left: 4px solid rgba(16,185,129,.9); }
  .alert.err { border-left: 4px solid rgba(239,68,68,.9); }

</style>
{% endblock %}

{% block content %}

{% include "selection.html" %}

<div style="height: 18px;"></div>

<div id="stagingRoot"
     data-org="{{ sel_org }}"
     data-sup="{{ sel_sup }}"
     data-user-hash="{{ session_user_hash }}"
     style="
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        padding: 24px 28px;
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-left: 5px solid #1c96ca;
     ">

  <div style="display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;">
    <div>
      <div style="font-size: 18px; font-weight: 900; color:#0f172a;">Ingestion</div>
    </div>
  </div>

  <div id="tab-navigation" style="margin-top: 16px;">
    <div id="tab-staging" class="tab active" onclick="switchTab('staging')">
      <i class="fas fa-folder-open"></i><span>Staging</span>
    </div>
    <div id="tab-pipe" class="tab" onclick="switchTab('pipe')">
      <i class="fas fa-diagram-project"></i><span>Pipe</span>
    </div>
    <div id="tab-load" class="tab" onclick="switchTab('load')">
      <i class="fas fa-upload"></i><span>Load Data</span>
    </div>
  </div>

  <!-- -------------------- STAGING TAB -------------------- -->
  <div class="tabpane" id="pane-staging">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div style="font-size: 14px; font-weight: 900; color:#0f172a;">Staging</div>
      <button type="button" id="btnCreateStaging" class="btn btn-sm btn-azure-outline">
        <i class="fas fa-plus"></i> Create staging
      </button>
    </div>

    {% if not has_tenant %}
      <div style="margin-top: 10px; color:#64748b;">Select a SuperTable above.</div>
    {% else %}
      <input id="stagingFilter" class="input" placeholder="Filter staging…" style="width:100%; max-width: 420px; padding:10px; border-radius:12px; border:1px solid rgba(15,23,42,.14); margin-top: 10px;" />
      <div id="stagingList" style="margin-top: 10px;"></div>
    {% endif %}
  </div>

  <!-- -------------------- PIPE TAB -------------------- -->
  <div class="tabpane hidden" id="pane-pipe">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div style="font-size: 14px; font-weight: 900; color:#0f172a;">Pipe</div>
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <select id="pipeStagingSelect" class="input" style="min-width: 240px; border-radius: 12px; padding: 8px 10px; border: 1px solid rgba(15,23,42,.14);">
          <option value="">Select staging…</option>
        </select>
        <button type="button" id="btnNewPipe" class="btn btn-sm btn-azure-outline">
          <i class="fas fa-plus"></i> New pipe
        </button>
        <button type="button" id="btnSavePipe" class="btn btn-sm btn-azure-outline">
          <i class="fas fa-save"></i> Save
        </button>
      </div>
    </div>

    {% if not has_tenant %}
      <div style="margin-top: 10px; color:#64748b;">Select a SuperTable above.</div>
    {% else %}
      <div class="split">
        <div class="left">
          <div style="font-size: 12px; font-weight: 900; color:#0f172a; margin: 6px 0;">Pipes</div>
          <div style="display:flex; align-items:center; gap:10px; margin-bottom: 10px; flex-wrap:wrap;">
          <input id="pipeFilter" class="input" placeholder="Filter pipes (name or simple_name)…" style="flex:1; min-width: 220px; padding:9px 10px; border-radius:12px; border:1px solid rgba(15,23,42,.14);" />
          <button type="button" id="btnDeletePipe" class="btn btn-sm btn-danger-outline" style="display:none; white-space:nowrap;">
                <i class="fas fa-trash"></i> Delete
              </button>
        </div>
          <div id="pipeList"></div>
        </div>
        <div class="right">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 6px 0;">
            <div style="font-size: 12px; font-weight: 900; color:#0f172a;">Pipe definition (JSON)</div>
            <div style="display:flex; align-items:center; gap:10px;">
              <span id="pipeEnabledPill" class="pill off" style="display:none;">disabled</span>
              <button type="button" id="btnTogglePipe" class="btn btn-sm btn-azure-outline" style="display:none;">
                <i class="fas fa-toggle-on"></i> Toggle
              </button>
            </div>
          </div>
          <textarea id="pipeEditor" placeholder="Select a staging, then create/select a pipe…"></textarea>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- -------------------- LOAD DATA TAB -------------------- -->
  <div class="tabpane hidden" id="pane-load">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;">
      <div>
        <div style="font-size: 18px; font-weight: 900; color:#0f172a;">Load Data</div>
        <div class="muted" style="margin-top:4px;">Upload a file and load into a table, or stage it for later.</div>
      </div>
    </div>

    {% if not has_tenant %}
      <div style="margin-top: 14px; color:#64748b;">Select a tenant (organization + super) first.</div>
    {% else %}
      <div class="load-steps">

        <!-- Step 1 -->
        <div class="stepcard">
          <div class="stephead">
            <div>
              <div class="kicker">1) CHOOSE A FILE</div>
              <div class="title">Pick a file and preview it instantly</div>
            </div>
          </div>

          <div class="load-row">
            <input id="loadFileInput" type="file" style="display:none;" />
            <label for="loadFileInput" class="btn btn-sm btn-azure-outline" style="margin:0;">
              <i class="fas fa-file-arrow-up"></i> Choose file
            </label>

            <div id="loadFilePill" class="file-pill" style="display:none;">
              <i class="fas fa-paperclip" style="color:#1c96ca;"></i>
              <span class="name" id="loadFileName">—</span>
              <span class="muted" id="loadFileMeta" style="margin-left:8px;">—</span>
            </div>

            <div class="muted">Supported: csv, tsv, json/jsonl, parquet</div>
          </div>

          <div id="loadPreview" style="margin-top: 12px; display:none;">
            <div class="previewbox">
              <div class="previewhead">
                <div class="h"><i class="fas fa-table" style="color:#1c96ca; margin-right:6px;"></i> Snake peek</div>
                <div class="muted" id="loadPreviewInfo">—</div>
              </div>
              <div class="previewbody">
                <table class="previewtable">
                  <thead id="loadPreviewThead"></thead>
                  <tbody id="loadPreviewTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="stepcard">
          <div class="stephead">
            <div>
              <div class="kicker">2) TARGET</div>
              <div class="title">Choose where to load</div>
            </div>
            <div class="segmented" role="tablist" aria-label="Load target">
              <button type="button" id="modeTableBtn" class="active" aria-selected="true">
                <i class="fas fa-database"></i> Table
              </button>
              <button type="button" id="modeStagingBtn" aria-selected="false">
                <i class="fas fa-folder-open"></i> Staging
              </button>
            </div>
          </div>

          <div class="load-row" style="margin-top:4px;">
            <div id="targetTablePanel" class="field">
              <label for="loadTableName">Table name (autocomplete + create new)</label>
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <input id="loadTableName" class="mono" placeholder="e.g. table_1" list="loadTableSuggestions" />
                <datalist id="loadTableSuggestions"></datalist>
                <button type="button" id="btnRefreshTables" class="btn btn-sm btn-azure-outline">
                  <i class="fas fa-rotate"></i> Refresh
                </button>
              </div>
              <div class="muted">Tip: start typing to see existing tables. You can also type a new one.</div>
            </div>

            <div id="targetStagingPanel" class="field" style="display:none;">
              <label for="loadStagingName">Staging name</label>
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <select id="loadStagingName">
                  <option value="">Select staging…</option>
                </select>
                <button type="button" id="btnRefreshStagings" class="btn btn-sm btn-azure-outline">
                  <i class="fas fa-rotate"></i> Refresh
                </button>
              </div>
              <div class="muted">Your file will be stored in the selected staging and listed under the Staging tab.</div>
            </div>
          </div>
        </div>

        
        <!-- Step 3 -->
        <div class="stepcard" id="overwriteStepCard">
          <div class="stephead">
            <div>
              <div class="kicker">3) OVERWRITE</div>
              <div class="title">Optional: overwrite matching rows</div>
              <div class="muted">Add column names (comma or newline separated). Leave empty to append.</div>
            </div>
          </div>

          <div class="field" style="min-width: 320px;">
            <label for="loadOverwriteCols">Overwrite columns</label>
            <textarea id="loadOverwriteCols" rows="4" placeholder="e.g. id&#10;email"></textarea>
          </div>
        </div>

<!-- Step 4 -->
        <div class="stepcard">
          <div class="stephead">
            <div>
              <div class="kicker">4) LOAD</div>
              <div class="title">Upload & load the file</div>
            </div>
          </div>

          <div class="load-footer">
            <div class="timer" id="loadTimer" style="display:none;">
              <span class="spinner"></span>
              <span>Loading:</span>
              <span class="mono" id="loadTimerVal">0.000s</span>
            </div>

            <button type="button" id="loadStartBtn" class="btn btn-sm btn-azure-outline" disabled>
              <i class="fas fa-upload"></i> Upload & Load
            </button>
          </div>

          <div id="loadResult" style="display:none;"></div>
        </div>

      </div>
    {% endif %}
  </div>

</div>

<!-- Modal (shared styling from base.html) -->
<div id="modal">
  <div id="modal-card">
    <div id="m-header">
      <div id="m-title">Modal</div>
      <button type="button" id="m-close" style="border:0;background:transparent;font-size:18px;cursor:pointer;color:#334155;">✕</button>
    </div>
    <div id="m-body"></div>
    <div id="m-footer">
      <button type="button" id="m-cancel" class="btn btn-sm btn-secondary">Cancel</button>
      <button type="button" id="m-confirm" class="btn btn-sm btn-primary">Confirm</button>
    </div>
  </div>
</div>

{% endblock %}

{% block body_scripts %}
<script>
(function () {
  function enc(v) { return encodeURIComponent(v || ""); }

  function root() { return document.getElementById("stagingRoot"); }
  function currentOrgSup() {
    const el = root();
    return {
      org: el ? (el.dataset.org || "") : "",
      sup: el ? (el.dataset.sup || "") : "",
      userHash: el ? (el.dataset.userHash || "") : "",
    };
  }

  function escapeHtml(str) {
    return String(str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function nsToLocalString(nsVal) {
    const raw = (nsVal === undefined || nsVal === null) ? "" : String(nsVal);
    if (!raw) return "";
    try {
      const ms = Number(BigInt(raw) / 1000000n);
      if (!Number.isFinite(ms)) return raw;
      return new Date(ms).toLocaleString();
    } catch (e) {
      const n = Number(raw);
      if (!Number.isFinite(n)) return raw;
      return new Date(Math.floor(n / 1e6)).toLocaleString();
    }
  }

  async function getJSON(url) {
    const resp = await fetch(url, { credentials: "same-origin" });
    let js = null;
    try { js = await resp.json(); } catch (e) { js = null; }
    if (!resp.ok) {
      const msg = (js && (js.detail || js.error)) || ("Request failed: " + resp.status + " " + resp.statusText);
      throw new Error(msg);
    }
    return js;
  }

  async function postJSON(url, payload) {
    const opts = {
      method: "POST",
      credentials: "same-origin",
      headers: { "Content-Type": "application/json" },
      body: payload === undefined ? null : JSON.stringify(payload),
    };
    const resp = await fetch(url, opts);
    let js = null;
    try { js = await resp.json(); } catch (e) { js = null; }
    if (!resp.ok) {
      const msg = (js && (js.detail || js.error)) || ("Request failed: " + resp.status + " " + resp.statusText);
      throw new Error(msg);
    }
    return js;
  }

  function showModal(title, bodyHtml, onConfirm, confirmText) {
    const modal = document.getElementById("modal");
    const titleEl = document.getElementById("m-title");
    const bodyEl = document.getElementById("m-body");
    const btnClose = document.getElementById("m-close");
    const btnCancel = document.getElementById("m-cancel");
    const btnConfirm = document.getElementById("m-confirm");

    titleEl.textContent = title || "Modal";
    bodyEl.innerHTML = bodyHtml || "";
    btnConfirm.textContent = confirmText || "Confirm";

    function close() {
      modal.style.display = "none";
      btnClose.removeEventListener("click", close);
      btnCancel.removeEventListener("click", close);
      btnConfirm.removeEventListener("click", confirm);
    }

    async function confirm() {
      try {
        if (onConfirm) await onConfirm();
        close();
      } catch (e) {
        alert(e && e.message ? e.message : String(e));
      }
    }

    btnClose.addEventListener("click", close);
    btnCancel.addEventListener("click", close);
    btnConfirm.addEventListener("click", confirm);

    modal.style.display = "flex";
  }

  function showJson(obj) {
    const pretty = JSON.stringify(obj || {}, null, 2);
    showModal(
      "JSON",
      `<pre style="margin:0;white-space:pre-wrap;font-family:monospace;font-size:13px;">${escapeHtml(pretty)}</pre>`,
      async () => {},
      "Close"
    );
  }

  window.showJson = showJson;

  window.switchTab = function switchTab(name) {
    const tabs = ["staging", "pipe", "load"];
    for (const t of tabs) {
      const btn = document.getElementById("tab-" + t);
      const pane = document.getElementById("pane-" + t);
      if (btn) btn.classList.toggle("active", t === name);
      if (pane) pane.classList.toggle("hidden", t !== name);
    }
    const u = new URL(window.location.href);
    u.hash = "#" + name;
    history.replaceState(null, "", u.toString());
    if (name === "pipe") {
      setTimeout(async () => {
        const stgSel = document.getElementById("pipeStagingSelect");
        if (stgSel && stgSel.value && String(stgSel.value).trim() && String(stgSel.value).trim() !== lastPipesStagingLoaded) {
          try { await refreshPipes(); } catch (e) {}
        }
      }, 0);
    }
    if (name === "load") {
      setTimeout(() => { try { initLoadTab(); } catch (e) {} }, 0);
    }
  };

  // -------------------- Staging (expandable, scrollable, lazy-load) --------------------

  let selectedStagingName = "";
  let expandedStagingName = "";
  let expandedBodyEl = null;

  let lastStagingNames = [];
  const STAGING_FILES_PAGE_SIZE = 50;
  const stagingFilesState = {}; // { [stg]: { offset:number, total:number|null, loading:boolean } }

  function setSelectedStaging(stg) {
    selectedStagingName = (stg || "").trim();

    // sync pipe tab selector
    const sel = document.getElementById("pipeStagingSelect");
    if (sel && selectedStagingName) {
      const has = Array.from(sel.options || []).some(o => o.value === selectedStagingName);
      if (has) sel.value = selectedStagingName;
    }
  }

  function _filterList(items, q) {
    q = (q || "").trim().toLowerCase();
    if (!q) return items;
    return (items || []).filter(x => String(x || "").toLowerCase().includes(q));
  }

  async function fetchStagingFilesPage(stg, offset, limit) {
    const { org, sup } = currentOrgSup();
    return await getJSON(`/reflection/ingestion/staging/files?org=${enc(org)}&sup=${enc(sup)}&staging_name=${enc(stg)}&offset=${enc(String(offset))}&limit=${enc(String(limit))}`);
  }

  function ensureStagingFilesState(stg) {
    if (!stagingFilesState[stg]) stagingFilesState[stg] = { offset: 0, total: null, loading: false };
    return stagingFilesState[stg];
  }

  function ensureFilesTable(bodyEl) {
    if (bodyEl.querySelector("table[data-files-table='1']")) return;

    bodyEl.innerHTML = `
      <div style="min-width:0;">
        <table data-files-table="1" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; font-size:12px; color:#64748b; font-weight:900; padding:6px 6px;">file</th>
              <th style="text-align:left; font-size:12px; color:#64748b; font-weight:900; padding:6px 6px; width:90px;">rows</th>
              <th style="text-align:left; font-size:12px; color:#64748b; font-weight:900; padding:6px 6px; width:220px;">written_at</th>
            </tr>
          </thead>
          <tbody data-files-tbody="1"></tbody>
        </table>
        <div data-files-footer="1" style="color:#64748b; font-size:12px; margin-top:10px;"></div>
      </div>
    `;
  }

  function setFilesFooter(bodyEl, shown, total) {
    const footer = bodyEl.querySelector("[data-files-footer='1']");
    if (!footer) return;
    const t = (total === null || total === undefined) ? "?" : String(total);
    footer.textContent = `Showing ${shown} / ${t}`;
  }

  function appendFileRows(bodyEl, items) {
    const tbody = bodyEl.querySelector("[data-files-tbody='1']");
    if (!tbody) return;

    for (const it of (items || [])) {
      const file = it && it.file ? String(it.file) : "";
      const rows = (it && it.rows !== undefined && it.rows !== null) ? String(it.rows) : "";
      const ns = (it && it.written_at_ns !== undefined && it.written_at_ns !== null) ? String(it.written_at_ns) : "";
      const dt = nsToLocalString(ns);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:7px 6px; border-top:1px solid rgba(15,23,42,.06); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px; word-break:break-all;">
          ${escapeHtml(file)}
        </td>
        <td style="padding:7px 6px; border-top:1px solid rgba(15,23,42,.06); font-size:12px;">
          ${escapeHtml(rows)}
        </td>
        <td title="${escapeHtml(ns)}" style="padding:7px 6px; border-top:1px solid rgba(15,23,42,.06); font-size:12px;">
          ${escapeHtml(dt)}
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function loadMoreStagingFiles(stg, bodyEl, reset) {
    const state = ensureStagingFilesState(stg);
    if (state.loading) return;
    if (!reset && state.total !== null && state.offset >= state.total) return;

    state.loading = true;
    try {
      if (reset) {
        state.offset = 0;
        state.total = null;
        ensureFilesTable(bodyEl);
        const tbody = bodyEl.querySelector("[data-files-tbody='1']");
        if (tbody) tbody.innerHTML = "";
        setFilesFooter(bodyEl, 0, null);
      }

      // Loading marker
      let marker = bodyEl.querySelector("[data-loading='1']");
      if (!marker) {
        marker = document.createElement("div");
        marker.dataset.loading = "1";
        marker.style.color = "#64748b";
        marker.style.fontSize = "12px";
        marker.style.marginTop = "8px";
        marker.textContent = reset ? "Loading…" : "Loading more…";
        bodyEl.appendChild(marker);
      } else {
        marker.textContent = reset ? "Loading…" : "Loading more…";
      }

      const data = await fetchStagingFilesPage(stg, state.offset, STAGING_FILES_PAGE_SIZE);
      const items = (data && data.items) ? data.items : [];
      const total = (data && data.total !== undefined && data.total !== null) ? Number(data.total) : 0;

      if (marker) marker.remove();

      // No files case
      if (reset && (!items || !items.length) && total === 0) {
        bodyEl.innerHTML = "<div style='color:#64748b; font-size:12px;'>No files recorded yet for this staging.</div>";
        return;
      }

      ensureFilesTable(bodyEl);
      appendFileRows(bodyEl, items);

      state.total = Number.isFinite(total) ? total : (state.total || null);
      state.offset += (items || []).length;

      setFilesFooter(bodyEl, state.offset, state.total);
    } finally {
      state.loading = false;
    }
  }

  function bindLazyScroll(stg, bodyEl) {
    if (bodyEl.dataset.lazyBound === "1") return;
    bodyEl.dataset.lazyBound = "1";

    bodyEl.addEventListener("scroll", async () => {
      const nearBottom = bodyEl.scrollTop + bodyEl.clientHeight >= bodyEl.scrollHeight - 40;
      if (!nearBottom) return;
      await loadMoreStagingFiles(stg, bodyEl, false);
    });
  }

  function collapseExpandedIfAny() {
    if (expandedBodyEl) {
      expandedBodyEl.style.display = "none";
    }
    expandedStagingName = "";
    expandedBodyEl = null;
  }

  async function toggleStaging(stg, bodyEl, hintEl) {
    const alreadyExpanded = (expandedStagingName === stg) && bodyEl.style.display !== "none";

    if (alreadyExpanded) {
      bodyEl.style.display = "none";
      if (hintEl) hintEl.style.display = "";
      expandedStagingName = "";
      expandedBodyEl = null;
      return;
    }

    // Collapse previous expanded
    if (expandedBodyEl && expandedBodyEl !== bodyEl) {
      expandedBodyEl.style.display = "none";
      const prevHint = expandedBodyEl.closest("[data-stg-row='1']")?.querySelector("[data-stg-hint='1']");
      if (prevHint) prevHint.style.display = "";
    }

    // Expand this one
    expandedStagingName = stg;
    expandedBodyEl = bodyEl;
    setSelectedStaging(stg);

    if (hintEl) hintEl.style.display = "none";
    bodyEl.style.display = "";
    bodyEl.style.maxHeight = "280px";
    bodyEl.style.overflow = "auto";
    bodyEl.style.paddingRight = "6px";

    // Sync pipe tab and refresh pipes in background
    const sel = document.getElementById("pipeStagingSelect");
    if (sel && sel.value !== stg) {
      sel.value = stg;
      try { await refreshPipes(); } catch (e) {}
    }

    if (bodyEl.dataset.loaded !== "1") {
      bodyEl.dataset.loaded = "1";
      await loadMoreStagingFiles(stg, bodyEl, true);
      bindLazyScroll(stg, bodyEl);
    }
  }

  async function refreshStagings() {
    const { org, sup } = currentOrgSup();
    const list = document.getElementById("stagingList");
    const sel = document.getElementById("pipeStagingSelect");
    if (!org || !sup) return;

    if (list) list.innerHTML = "<div style='color:#64748b;'>Loading…</div>";

    const data = await getJSON(`/reflection/ingestion/stagings?org=${enc(org)}&sup=${enc(sup)}`);
    const names = (data && data.staging_names) ? data.staging_names : [];
    lastStagingNames = Array.isArray(names) ? names : [];

    if (sel) {
      const prev = "";
      sel.innerHTML = "<option value=''>Select staging…</option>";
      for (const n of lastStagingNames) {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
      }
      if (prev && lastStagingNames.includes(prev)) {
        sel.value = "";
      } else {
        sel.value = "";
      }
      setSelectedStaging("");
    }

    renderStagingList();
  }

  function renderStagingList() {
    const { org, sup } = currentOrgSup();
    const list = document.getElementById("stagingList");
    if (!list) return;

    if (!lastStagingNames.length) {
      list.innerHTML = "<div style='color:#64748b;'>No staging found.</div>";
      return;
    }

    const filterEl = document.getElementById("stagingFilter");
    const q = filterEl ? (filterEl.value || "") : "";
    const names = _filterList(lastStagingNames, q);

    if (!names.length) {
      list.innerHTML = "<div style='color:#64748b;'>No staging matches the filter.</div>";
      return;
    }

    list.innerHTML = "";

    for (const n of names) {
      const row = document.createElement("div");
      row.className = "rowcard";
      row.dataset.stgRow = "1";
      row.style.display = "grid";
      row.style.gridTemplateColumns = "minmax(160px, 240px) 1fr auto";
      row.style.alignItems = "start";
      row.style.gap = "12px";

      row.innerHTML = `
        <div data-stg-name="1" style="cursor:pointer; min-width:0;">
          <div class="title">${escapeHtml(n)}</div>
        </div>

        <div style="min-width:0;">
          <div data-stg-hint="1" class="sub" style="margin-top:2px;">Click the staging name to view files.</div>
          <div data-stg-body="1" style="display:none; margin-top:8px;"></div>
        </div>

        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">          <button type="button" class="btn btn-sm btn-danger-outline" onclick="deleteStaging('${escapeHtml(n)}'); event.stopPropagation();">
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      `;

      const nameEl = row.querySelector("[data-stg-name='1']");
      const hintEl = row.querySelector("[data-stg-hint='1']");
      const bodyEl = row.querySelector("[data-stg-body='1']");
      if (nameEl && bodyEl) {
        nameEl.addEventListener("click", async () => await toggleStaging(n, bodyEl, hintEl));
      }

      list.appendChild(row);
    }

    const filter = document.getElementById("stagingFilter");
    if (filter && filter.dataset.bound !== "1") {
      filter.dataset.bound = "1";
      filter.addEventListener("input", () => renderStagingList());
    }
  }

  window.viewStagingMeta = async function viewStagingMeta(stagingName) {
    const { org, sup } = currentOrgSup();
    if (!org || !sup) return;
    const data = await getJSON(`/reflection/ingestion/staging/meta?org=${enc(org)}&sup=${enc(sup)}&staging_name=${enc(stagingName)}`);
    showJson((data && data.meta) ? data.meta : {});
  };

  window.deleteStaging = async function deleteStaging(stagingName) {
    const { org, sup } = currentOrgSup();
    if (!org || !sup) return;
    if (!confirm("Delete staging '" + stagingName + "'? This removes files and pipes under it.")) return;
    await postJSON(`/reflection/staging/delete?org=${enc(org)}&sup=${enc(sup)}&staging_name=${enc(stagingName)}`);
    // If we deleted the expanded one, clear it
    if (expandedStagingName === stagingName) collapseExpandedIfAny();
    await refreshStagings();
    const u = new URL(window.location.href);
    u.hash = "#staging";
    history.replaceState(null, "", u.toString());
  };

  // -------------------- Pipe tab (filterable) --------------------

  let selectedPipeName = "";
  let selectedPipeEnabled = false;
  let lastPipeItems = [];
  let lastPipesStagingLoaded = "";

  function setPipeButtonsVisible(visible) {
    const pill = document.getElementById("pipeEnabledPill");
    const btnToggle = document.getElementById("btnTogglePipe");
    const btnDelete = document.getElementById("btnDeletePipe");
    if (pill) pill.style.display = visible ? "" : "none";
    if (btnToggle) btnToggle.style.display = visible ? "" : "none";
    if (btnDelete) btnDelete.style.display = visible ? "" : "none";
  }

  function updateEnabledPill(enabled) {
    const pill = document.getElementById("pipeEnabledPill");
    if (!pill) return;
    pill.classList.toggle("on", !!enabled);
    pill.classList.toggle("off", !enabled);
    pill.textContent = enabled ? "enabled" : "disabled";
  }

  async function refreshPipes() {
    const { org, sup } = currentOrgSup();
    const stgSel = document.getElementById("pipeStagingSelect");
    const list = document.getElementById("pipeList");
    const editor = document.getElementById("pipeEditor");
    if (!org || !sup || !stgSel || !list) return;

    const stg = (stgSel.value || "").trim();

    selectedPipeName = "";
    selectedPipeEnabled = false;
    setPipeButtonsVisible(false);
    updateEnabledPill(false);
    if (editor) editor.value = "";

    if (!stg) {
      list.innerHTML = "<div style='color:#64748b;'>Please select a staging area first.</div>";
      lastPipeItems = [];
      lastPipesStagingLoaded = "";
      return;
    }

    list.innerHTML = "<div style='color:#64748b;'>Loading…</div>";
    const data = await getJSON(`/reflection/ingestion/pipes?org=${enc(org)}&sup=${enc(sup)}&staging_name=${enc(stg)}`);
    const items = (data && data.items) ? data.items : [];
    lastPipeItems = Array.isArray(items) ? items : [];
    lastPipesStagingLoaded = stg;
    renderPipeList();
  }

  function renderPipeList() {
    const stgSel = document.getElementById("pipeStagingSelect");
    const list = document.getElementById("pipeList");
    if (!stgSel || !list) return;

    const stg = (stgSel.value || "").trim();
    if (!stg) return;

    let items = lastPipeItems || [];
    const filterEl = document.getElementById("pipeFilter");
    const q = filterEl ? String(filterEl.value || "").trim().toLowerCase() : "";
    if (q) {
      items = items.filter(it => {
        const pn = String(it && it.pipe_name ? it.pipe_name : "").toLowerCase();
        const sn = String(it && it.simple_name ? it.simple_name : "").toLowerCase();
        return pn.includes(q) || sn.includes(q);
      });
    }

    if (!items.length) {
      list.innerHTML = "<div style='color:#64748b;'>No pipes found.</div>";
      return;
    }

    list.innerHTML = "";
    for (const it of items) {
      const pn = it.pipe_name;
      const sn = it.simple_name || "";
      const enabled = !!it.enabled;
      const row = document.createElement("div");
      row.className = "rowcard";
      row.style.cursor = "pointer";
      row.innerHTML = `
        <div style="min-width:0;">
          <div class="title">${escapeHtml(pn)}</div>
          <div class="sub">
            ${sn ? `simple_name: <code>${escapeHtml(sn)}</code> · ` : ""}
            <code>...:meta:staging:${escapeHtml(stg)}:pipe:${escapeHtml(pn)}</code>
          </div>
        </div>
        <div><span class="pill ${enabled ? "on" : "off"}">${enabled ? "enabled" : "disabled"}</span></div>
      `;
      row.addEventListener("click", () => selectPipe(stg, pn));
      list.appendChild(row);
    }

    const filter = document.getElementById("pipeFilter");
    if (filter && filter.dataset.bound !== "1") {
      filter.dataset.bound = "1";
      filter.addEventListener("input", () => renderPipeList());
    }
  }

  async function selectPipe(stagingName, pipeName) {
    const { org, sup } = currentOrgSup();
    const editor = document.getElementById("pipeEditor");
    if (!org || !sup || !editor) return;

    const data = await getJSON(`/reflection/ingestion/pipe/meta?org=${enc(org)}&sup=${enc(sup)}&staging_name=${enc(stagingName)}&pipe_name=${enc(pipeName)}`);
    const meta = (data && data.meta) ? data.meta : {};
    // Ensure required routing fields exist even if legacy Redis entries are partial.
    const cur = currentOrgSup();
    if (meta && typeof meta === "object") {
      meta.organization = String(meta.organization || meta.org || cur.org || "");
      meta.super_name = String(meta.super_name || meta.sup || cur.sup || "");
      meta.staging_name = String(meta.staging_name || stagingName || "");
      meta.pipe_name = String(meta.pipe_name || pipeName || "");
      meta.user_hash = String(meta.user_hash || cur.userHash || "");
    }
    selectedPipeName = String(meta.pipe_name || pipeName || "");
    selectedPipeEnabled = !!meta.enabled;
    editor.value = JSON.stringify(meta || {}, null, 2);
    setPipeButtonsVisible(true);
    updateEnabledPill(selectedPipeEnabled);
  }

  function newPipeTemplate(stg) {
    const { org, sup, userHash } = currentOrgSup();
    return {
      pipe_name: "pipe_01",
      organization: org,
      super_name: sup,
      staging_name: stg,
      user_hash: userHash || "",
      simple_name: "",
      overwrite_columns: ["day"],
      enabled: true,
      meta: {},
    };
  }

  const stgSel = document.getElementById("pipeStagingSelect");
  if (stgSel) {
    stgSel.addEventListener("change", async () => {
      setSelectedStaging(stgSel.value || "");
      await refreshPipes();
    });
    stgSel.addEventListener("click", async () => {
      const v = String(stgSel.value || "").trim();
      if (v && v !== lastPipesStagingLoaded) {
        try { await refreshPipes(); } catch (e) {}
      }
    });
  }

  const btnNewPipe = document.getElementById("btnNewPipe");
  if (btnNewPipe) {
    btnNewPipe.addEventListener("click", async () => {
      const stg = (stgSel && stgSel.value) ? stgSel.value.trim() : "";
      if (!stg) { alert("Please select a staging area first."); return; }

      showModal(
        "New pipe (draft)",
        `
          <div style="display:flex; flex-direction:column; gap:10px;">
            <label style="font-weight:800;">Pipe name</label>
            <input id="modalPipeName" class="input" placeholder="pipe_01" style="width:100%; padding:10px; border-radius:12px; border:1px solid rgba(15,23,42,.14);" />

            <label style="font-weight:800; margin-top:6px;">simple_name</label>
            <input id="modalPipeSimple" class="input" placeholder="" style="width:100%; padding:10px; border-radius:12px; border:1px solid rgba(15,23,42,.14);" />

            <label style="font-weight:800; margin-top:6px;">overwrite_columns</label>
            <input id="modalPipeOverwrite" class="input" placeholder="day" value="day" style="width:100%; padding:10px; border-radius:12px; border:1px solid rgba(15,23,42,.14);" />
            <div style="font-size:12px;color:#64748b;">Comma-separated list (e.g. <code>day,month</code>).</div>

            <label style="display:flex; align-items:center; gap:10px; font-weight:800; margin-top:6px;">
              <input id="modalPipeEnabled" type="checkbox" checked /> enabled
            </label>
          </div>
        `,
        async () => {
          const editor = document.getElementById("pipeEditor");
          const pn = (document.getElementById("modalPipeName").value || "").trim() || "pipe_01";
          const sn = (document.getElementById("modalPipeSimple").value || "").trim();
          const rawCols = (document.getElementById("modalPipeOverwrite").value || "").trim();
          const cols = rawCols ? rawCols.split(",").map(x => x.trim()).filter(Boolean) : [];
          const enabled = !!document.getElementById("modalPipeEnabled").checked;

          selectedPipeName = "";
          selectedPipeEnabled = false;
          setPipeButtonsVisible(false);
          updateEnabledPill(false);

          const obj = newPipeTemplate(stg);
          obj.pipe_name = pn;
          obj.simple_name = sn;
          obj.overwrite_columns = cols;
          obj.enabled = enabled;

          if (editor) editor.value = JSON.stringify(obj, null, 2);
        },
        "Create draft"
      );

      setTimeout(() => {
        const el = document.getElementById("modalPipeName");
        if (el) el.focus();
      }, 20);
    });
  }

  const btnSavePipe = document.getElementById("btnSavePipe");
  if (btnSavePipe) {
    btnSavePipe.addEventListener("click", async () => {
      const editor = document.getElementById("pipeEditor");
      if (!editor) return;
      let obj = null;
      try { obj = JSON.parse(editor.value || "{}"); } catch (e) { alert("Invalid JSON: " + e.message); return; }
      if (!obj || typeof obj !== "object") { alert("Pipe definition must be a JSON object."); return; }

      // Fill required identity fields from current selection (helps when editing legacy/partial entries).
      const cur = currentOrgSup();
      const stg = (stgSel && stgSel.value) ? String(stgSel.value).trim() : "";
      obj.organization = String(obj.organization || obj.org || cur.org || "");
      obj.super_name = String(obj.super_name || obj.sup || cur.sup || "");
      obj.staging_name = String(obj.staging_name || stg || "");
      obj.pipe_name = String(obj.pipe_name || selectedPipeName || "").trim();
      obj.user_hash = String(obj.user_hash || cur.userHash || "");

      if (!obj.organization || !obj.super_name || !obj.staging_name || !obj.pipe_name) {
        alert("Missing required fields: organization, super_name, staging_name, pipe_name.");
        return;
      }

      await postJSON("/reflection/pipes/save", obj);
      await refreshPipes();
      alert("Saved.");
    });
  }

  const btnToggle = document.getElementById("btnTogglePipe");
  if (btnToggle) {
    btnToggle.addEventListener("click", async () => {
      const { org, sup } = currentOrgSup();
      const stg = (stgSel && stgSel.value) ? stgSel.value.trim() : "";
      if (!org || !sup || !stg || !selectedPipeName) return;
      const endpoint = selectedPipeEnabled ? "disable" : "enable";
      await postJSON(`/reflection/pipes/${endpoint}?org=${enc(org)}&sup=${enc(sup)}&staging_name=${enc(stg)}&pipe_name=${enc(selectedPipeName)}`);
      selectedPipeEnabled = !selectedPipeEnabled;
      updateEnabledPill(selectedPipeEnabled);
      await refreshPipes();
    });
  }

  const btnDelete = document.getElementById("btnDeletePipe");
  if (btnDelete) {
    btnDelete.addEventListener("click", async () => {
      const { org, sup } = currentOrgSup();
      const stg = (stgSel && stgSel.value) ? stgSel.value.trim() : "";
      if (!org || !sup || !stg || !selectedPipeName) return;
      if (!confirm("Delete pipe '" + selectedPipeName + "'?")) return;
      await postJSON(`/reflection/pipes/delete?org=${enc(org)}&sup=${enc(sup)}&staging_name=${enc(stg)}&pipe_name=${enc(selectedPipeName)}`);
      selectedPipeName = "";
      selectedPipeEnabled = false;
      setPipeButtonsVisible(false);
      updateEnabledPill(false);
      const editor = document.getElementById("pipeEditor");
      if (editor) editor.value = "";
      await refreshPipes();
    });
  }

  // -------------------- Create staging modal --------------------

  const btnCreateStaging = document.getElementById("btnCreateStaging");
  if (btnCreateStaging) {
    btnCreateStaging.addEventListener("click", async () => {
      const { org, sup } = currentOrgSup();
      if (!org || !sup) return;

      showModal(
        "Create staging",
        `
          <div style="display:flex; flex-direction:column; gap:10px;">
            <label style="font-weight:800;">Staging name</label>
            <input id="modalStagingName" class="input" placeholder="staging_01" style="width:100%; padding:10px; border-radius:12px; border:1px solid rgba(15,23,42,.14);" />
            <div style="font-size:12px;color:#64748b;">Will create folders under <code>${escapeHtml(org)}/${escapeHtml(sup)}/staging/&lt;name&gt;</code>.</div>
          </div>
        `,
        async () => {
          const name = (document.getElementById("modalStagingName").value || "").trim();
          if (!name) throw new Error("staging_name is required.");
          await postJSON(`/reflection/staging/create?org=${enc(org)}&sup=${enc(sup)}&staging_name=${enc(name)}`);
          await refreshStagings();
        },
        "Create"
      );
      setTimeout(() => {
        const el = document.getElementById("modalStagingName");
        if (el) el.focus();
      }, 20);
    });
  }

  // -------------------- Cross-page tenant change --------------------

  window.addEventListener("supertable-changed", function(e) {
    const detail = (e && e.detail) ? e.detail : {};
    const org = detail.org || "";
    const sup = detail.sup || "";
    const u = new URL(window.location.href);
    u.pathname = "/reflection/ingestion";
    u.searchParams.set("org", org);
    u.searchParams.set("sup", sup);
    u.hash = "#staging";
    window.location.href = u.toString();
  });

  // Initial tab from hash
  const h = (window.location.hash || "").replace("#", "");
  if (h === "pipe" || h === "load" || h === "staging") {
    window.switchTab(h);
  }

  // Initial load
  refreshStagings().then(async () => {
    const stgSel2 = document.getElementById("pipeStagingSelect");
    if (stgSel2 && stgSel2.value) await refreshPipes();
  });

  window.refreshStagings = refreshStagings;
  window.refreshPipes = refreshPipes;

  // -------------------- Load Data (modern) --------------------

  let loadMode = "table"; // "table" | "staging"
  let loadSelectedFile = null;
  let loadTimerHandle = null;
  let loadTimerStart = 0;

  function _fmtBytes(n) {
    const v = Number(n || 0);
    if (!Number.isFinite(v) || v <= 0) return "0 B";
    const units = ["B","KB","MB","GB"];
    let u = 0;
    let x = v;
    while (x >= 1024 && u < units.length - 1) { x /= 1024; u += 1; }
    return `${x.toFixed(u === 0 ? 0 : 2)} ${units[u]}`;
  }

  function _setMode(m) {
    loadMode = m;
    const ow = document.getElementById("overwriteStepCard");
    if (ow) ow.style.display = (m === "table") ? "" : "none";

    const b1 = document.getElementById("modeTableBtn");
    const b2 = document.getElementById("modeStagingBtn");
    const p1 = document.getElementById("targetTablePanel");
    const p2 = document.getElementById("targetStagingPanel");
    if (b1) b1.classList.toggle("active", m === "table");
    if (b2) b2.classList.toggle("active", m === "staging");
    if (b1) b1.setAttribute("aria-selected", m === "table" ? "true" : "false");
    if (b2) b2.setAttribute("aria-selected", m === "staging" ? "true" : "false");
    if (p1) p1.style.display = (m === "table") ? "" : "none";
    if (p2) p2.style.display = (m === "staging") ? "" : "none";
    _updateLoadStartEnabled();
  }

  function _updateLoadStartEnabled() {
    const btn = document.getElementById("loadStartBtn");
    if (!btn) return;
    const fileOk = !!loadSelectedFile;
    let targetOk = false;
    if (loadMode === "table") {
      const t = document.getElementById("loadTableName");
      targetOk = !!(t && String(t.value || "").trim());
    } else {
      const s = document.getElementById("loadStagingName");
      targetOk = !!(s && String(s.value || "").trim());
    }
    btn.disabled = !(fileOk && targetOk);
  }

  function _clearPreview() {
    const box = document.getElementById("loadPreview");
    if (box) box.style.display = "none";
    const thead = document.getElementById("loadPreviewThead");
    const tbody = document.getElementById("loadPreviewTbody");
    const info = document.getElementById("loadPreviewInfo");
    if (thead) thead.innerHTML = "";
    if (tbody) tbody.innerHTML = "";
    if (info) info.textContent = "—";
  }

  function _renderPreview(headers, rows, infoText) {
    const box = document.getElementById("loadPreview");
    const thead = document.getElementById("loadPreviewThead");
    const tbody = document.getElementById("loadPreviewTbody");
    const info = document.getElementById("loadPreviewInfo");
    if (!box || !thead || !tbody) return;

    const h = (headers || []).slice(0, 30);
    thead.innerHTML = `<tr>${h.map(x => `<th>${escapeHtml(x)}</th>`).join("")}</tr>`;
    tbody.innerHTML = (rows || []).slice(0, 20).map(r => {
      const cells = h.map((_, i) => {
        const v = (r && r[i] !== undefined && r[i] !== null) ? String(r[i]) : "";
        return `<td title="${escapeHtml(v)}">${escapeHtml(v)}</td>`;
      });
      return `<tr>${cells.join("")}</tr>`;
    }).join("");

    if (info) info.textContent = infoText || "";
    box.style.display = "";
  }

  async function _snakePeekFile(file) {
    _clearPreview();
    if (!file) return;

    const name = (file.name || "").toLowerCase();
    const ext = name.includes(".") ? name.split(".").pop() : "";
    const maxBytes = 512 * 1024;

    // Parquet preview client-side is not supported without heavier deps
    if (ext === "parquet") {
      _renderPreview(["Preview not available"], [["Parquet preview is shown after upload/load."]], "Parquet");
      return;
    }

    const blob = file.slice(0, maxBytes);
    const text = await blob.text();

    try {
      if (ext === "json" || ext === "jsonl" || ext === "ndjson") {
        const trimmed = text.trim();
        let arr = null;

        // Try JSONL first
        const lines = trimmed.split(/\r?\n/).filter(x => x.trim());
        if ((ext === "jsonl" || ext === "ndjson") && lines.length) {
          arr = lines.slice(0, 50).map(l => JSON.parse(l));
        } else {
          const parsed = JSON.parse(trimmed);
          if (Array.isArray(parsed)) arr = parsed.slice(0, 50);
          else if (parsed && Array.isArray(parsed.data)) arr = parsed.data.slice(0, 50);
          else arr = [parsed];
        }

        const keys = [];
        for (const o of (arr || [])) {
          if (o && typeof o === "object" && !Array.isArray(o)) {
            for (const k of Object.keys(o)) if (!keys.includes(k)) keys.push(k);
          }
        }
        const headers = keys.length ? keys : ["value"];
        const rows = (arr || []).slice(0, 20).map(o => headers.map(k => (keys.length ? o?.[k] : o)));
        _renderPreview(headers, rows, `JSON preview (first ${rows.length} rows)`);
        return;
      }

      // CSV/TSV-ish
      const sep = ext === "tsv" ? "\t" : ",";
      const lines = text.split(/\r?\n/).filter(l => l.trim());
      if (!lines.length) {
        _renderPreview(["Empty file"], [["No rows detected."]], "Empty");
        return;
      }
      const head = lines[0].split(sep).map(x => x.trim());
      const rows = lines.slice(1, 21).map(l => l.split(sep));
      _renderPreview(head, rows, `Preview (first ${rows.length} rows)`);
    } catch (e) {
      _renderPreview(["Preview failed"], [[String(e || "Unable to preview file")]], "Preview error");
    }
  }

  async function _refreshStagingNames() {
    const { org, sup } = currentOrgSup();
    const sel = document.getElementById("loadStagingName");
    if (!sel) return;
    sel.innerHTML = `<option value="">Select staging…</option>`;
    if (!org || !sup) return;

    try {
      const data = await getJSON(`/reflection/ingestion/stagings?org=${enc(org)}&sup=${enc(sup)}`);
      const names = (data && data.items) ? data.items : ((data && data.staging_names) ? data.staging_names : (Array.isArray(data) ? data : []));
      for (const n of (names || [])) {
        const opt = document.createElement("option");
        opt.value = String(n);
        opt.textContent = String(n);
        sel.appendChild(opt);
      }
    } catch (e) {
      // ignore
    }
  }

  async function _refreshTableSuggestions() {
    const { org, sup, userHash } = currentOrgSup();
    const dl = document.getElementById("loadTableSuggestions");
    if (!dl) return;
    dl.innerHTML = "";
    if (!org || !sup) return;

    try {
      const data = await getJSON(`/reflection/ingestion/tables?org=${enc(org)}&sup=${enc(sup)}&user_hash=${enc(userHash)}`);
      const tables = (data && data.tables) ? data.tables : [];
      for (const t of (tables || [])) {
        const opt = document.createElement("option");
        opt.value = String(t);
        dl.appendChild(opt);
      }
    } catch (e) {
      // ignore
    }
  }

  function _startLoadTimer() {
    loadTimerStart = performance.now();
    const el = document.getElementById("loadTimer");
    const val = document.getElementById("loadTimerVal");
    if (el) el.style.display = "";
    if (val) val.textContent = "0.000s";

    if (loadTimerHandle) clearInterval(loadTimerHandle);
    loadTimerHandle = setInterval(() => {
      const ms = performance.now() - loadTimerStart;
      if (val) val.textContent = `${(ms / 1000).toFixed(3)}s`;
    }, 50);
  }

  function _stopLoadTimer() {
    if (loadTimerHandle) clearInterval(loadTimerHandle);
    loadTimerHandle = null;
    const el = document.getElementById("loadTimer");
    if (el) el.style.display = "none";
  }

  function _setLoadResult(ok, html) {
    const box = document.getElementById("loadResult");
    if (!box) return;
    box.className = "alert " + (ok ? "ok" : "err");
    box.innerHTML = html;
    box.style.display = "";
  }

  function _setLoadBusy(busy) {
    const btn = document.getElementById("loadStartBtn");
    const fi = document.getElementById("loadFileInput");
    const t = document.getElementById("loadTableName");
    const s = document.getElementById("loadStagingName");
    const b1 = document.getElementById("modeTableBtn");
    const b2 = document.getElementById("modeStagingBtn");
    const r1 = document.getElementById("btnRefreshTables");
    const r2 = document.getElementById("btnRefreshStagings");

    if (btn) btn.disabled = busy || btn.disabled;
    if (fi) fi.disabled = !!busy;
    if (t) t.disabled = !!busy;
    if (s) s.disabled = !!busy;
    if (b1) b1.disabled = !!busy;
    if (b2) b2.disabled = !!busy;
    if (r1) r1.disabled = !!busy;
    if (r2) r2.disabled = !!busy;

    if (btn && busy) btn.innerHTML = `<i class="fas fa-upload"></i> Uploading…`;
    if (btn && !busy) btn.innerHTML = `<i class="fas fa-upload"></i> Upload & Load`;
  }

  async function _doUploadAndLoad() {
    const { org, sup, userHash } = currentOrgSup();
    const btn = document.getElementById("loadStartBtn");
    if (!btn || !loadSelectedFile) return;

    const tableNameEl = document.getElementById("loadTableName");
    const stagingEl = document.getElementById("loadStagingName");

    const tableName = tableNameEl ? String(tableNameEl.value || "").trim() : "";
    const stagingName = stagingEl ? String(stagingEl.value || "").trim() : "";

    if (!org || !sup) {
      _setLoadResult(false, "Missing tenant selection (org/super).");
      return;
    }
    if (!userHash) {
      _setLoadResult(false, "Missing user hash (session). Please re-login.");
      return;
    }
    if (loadMode === "table" && !tableName) {
      _setLoadResult(false, "Please enter a table name.");
      return;
    }
    if (loadMode === "staging" && !stagingName) {
      _setLoadResult(false, "Please select a staging name.");
      return;
    }

    const clientStart = performance.now();
    _setLoadBusy(true);
    _startLoadTimer();

    try {
      const fd = new FormData();
      fd.append("org", org);
      fd.append("sup", sup);
      fd.append("user_hash", userHash);
      fd.append("mode", loadMode);
      if (tableName) fd.append("table_name", tableName);
      const overwriteEl2 = document.getElementById("loadOverwriteCols");
      const overwriteRaw = overwriteEl2 ? String(overwriteEl2.value || "").trim() : "";
      if (loadMode === "table" && overwriteRaw) fd.append("overwrite_columns", overwriteRaw);
      if (stagingName) fd.append("staging_name", stagingName);
      fd.append("file", loadSelectedFile, loadSelectedFile.name || "upload");

      const resp = await fetch("/reflection/ingestion/load/upload", {
        method: "POST",
        body: fd,
        credentials: "same-origin",
      });

      const text = await resp.text();
      let data = null;
      try { data = JSON.parse(text); } catch (e) { data = null; }

      if (!resp.ok) {
        const msg = (data && (data.detail || data.error)) || text || ("Upload failed: " + resp.status);
        throw new Error(msg);
      }

      const clientMs = performance.now() - clientStart;
      const serverMs = data && data.server_duration_ms !== undefined ? Number(data.server_duration_ms) : null;

      const modeTxt = (data && data.mode) ? String(data.mode) : loadMode;
      const rows = (data && data.rows !== undefined) ? String(data.rows) : "";
      const fileType = (data && data.file_type) ? String(data.file_type) : "";
      const job = (data && data.job_uuid) ? String(data.job_uuid) : "";

      const targetTxt = modeTxt === "staging"
        ? `staging <b>${escapeHtml(String(data.staging_name || stagingName))}</b>`
        : `table <b>${escapeHtml(String(data.table_name || tableName))}</b>`;

      const sMsHtml = (serverMs !== null && Number.isFinite(serverMs))
        ? `${serverMs.toFixed(3)} ms`
        : "—";

      _setLoadResult(true, `
        <div style="font-weight:900;">Loaded successfully</div>
        <div class="muted" style="margin-top:6px;">Target: ${targetTxt}</div>
        <div class="muted">Rows: ${escapeHtml(rows)} | Type: ${escapeHtml(fileType)} | Job: <span class="mono">${escapeHtml(job)}</span></div>
        <div style="margin-top:8px; display:flex; gap:14px; flex-wrap:wrap;">
          <div><span class="muted">Server:</span> <span class="mono">${escapeHtml(sMsHtml)}</span></div>
          <div><span class="muted">Client roundtrip:</span> <span class="mono">${(clientMs).toFixed(1)} ms</span></div>
        </div>
      `);

      // If staging, refresh staging list quickly so it appears immediately
      if (modeTxt === "staging") {
        try { await _refreshStagingNames(); } catch (e) {}
      }

    } catch (e) {
      _setLoadResult(false, `<div style="font-weight:900;">Error</div><div class="mono" style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(String(e || "Upload failed"))}</div>`);
    } finally {
      _stopLoadTimer();
      _setLoadBusy(false);
      _updateLoadStartEnabled();
    }
  }

  function initLoadTab() {
    const fileInput = document.getElementById("loadFileInput");
    const filePill = document.getElementById("loadFilePill");
    const fileName = document.getElementById("loadFileName");
    const fileMeta = document.getElementById("loadFileMeta");

    const bTable = document.getElementById("modeTableBtn");
    const bStg = document.getElementById("modeStagingBtn");
    const startBtn = document.getElementById("loadStartBtn");
    const refreshTables = document.getElementById("btnRefreshTables");
    const refreshStagings = document.getElementById("btnRefreshStagings");
    const tableName = document.getElementById("loadTableName");
    const stagingName = document.getElementById("loadStagingName");
    const overwriteEl = document.getElementById("loadOverwriteCols");
    const overwriteCard = document.getElementById("overwriteStepCard");

    if (fileInput && fileInput.dataset.bound !== "1") {
      fileInput.dataset.bound = "1";
      fileInput.addEventListener("change", async () => {
        const f = (fileInput.files && fileInput.files[0]) ? fileInput.files[0] : null;
        loadSelectedFile = f;
        if (f && filePill && fileName && fileMeta) {
          fileName.textContent = f.name || "upload";
          fileMeta.textContent = `${_fmtBytes(f.size)} · ${String((f.type || "").toLowerCase() || "file")}`;
          filePill.style.display = "";
        } else if (filePill) {
          filePill.style.display = "none";
        }

        await _snakePeekFile(f);
        _updateLoadStartEnabled();
      });
    }

    if (bTable && bTable.dataset.bound !== "1") {
      bTable.dataset.bound = "1";
      bTable.addEventListener("click", () => _setMode("table"));
    }
    if (bStg && bStg.dataset.bound !== "1") {
      bStg.dataset.bound = "1";
      bStg.addEventListener("click", () => _setMode("staging"));
    }

    if (refreshTables && refreshTables.dataset.bound !== "1") {
      refreshTables.dataset.bound = "1";
      refreshTables.addEventListener("click", async () => { await _refreshTableSuggestions(); });
    }
    if (refreshStagings && refreshStagings.dataset.bound !== "1") {
      refreshStagings.dataset.bound = "1";
      refreshStagings.addEventListener("click", async () => { await _refreshStagingNames(); });
    }

    if (tableName && tableName.dataset.bound !== "1") {
      tableName.dataset.bound = "1";
      tableName.addEventListener("input", _updateLoadStartEnabled);
    }
    if (overwriteEl && overwriteEl.dataset.bound !== "1") {
      overwriteEl.dataset.bound = "1";
      overwriteEl.addEventListener("input", _updateLoadStartEnabled);
    }

    if (stagingName && stagingName.dataset.bound !== "1") {
      stagingName.dataset.bound = "1";
      stagingName.addEventListener("change", _updateLoadStartEnabled);
    }

    if (startBtn && startBtn.dataset.bound !== "1") {
      startBtn.dataset.bound = "1";
      startBtn.addEventListener("click", _doUploadAndLoad);
    }

    // initial refresh
    _setMode(loadMode || "table");
    _refreshTableSuggestions();
    _refreshStagingNames();
    _updateLoadStartEnabled();
  }

})();
</script>
{% endblock %}
