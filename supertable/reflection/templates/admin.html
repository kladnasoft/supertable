<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SuperTable - Admin</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js">
  </script>

  <style>
    :root {
      --primary-color: #1c96ca;
      --primary-light: #e6f4fa;
      --secondary-color: #147ba3;
      --dark-color: #1a1a2e;
      --light-color: #f8f9fa;
      --text-color: #2b2d42;
      --text-light: #8d99ae;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);

      --panel-bg: #ffffff;
      --panel-border: #e0e5f0;
      --panel-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont;
      background: #f3f6fb;
      color: var(--text-color);
    }

    a {
      color: var(--primary-color);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .content-container {
      margin-left: 280px;
      min-height: 100vh;
      background-color: #f3f6fb;
      transition: var(--transition);
      padding-bottom: 40px;
    }

    .sidebar-collapsed ~ .content-container {
      margin-left: 80px;
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .card {
      background: var(--panel-bg);
      border-radius: 16px;
      box-shadow: var(--panel-shadow);
      border: 1px solid var(--panel-border);
    }

    .section {
      padding: 16px 20px;
    }

    .muted { color: var(--text-light); }
    .btn-ghost {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #d0d7e7;
      background: transparent;
      color: #475569;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-ghost:hover {
      background: #e2e8f0;
    }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; }

    .border-b { border-bottom: 1px solid #e2e8f0; }
    .px-3 { padding-left: 12px; padding-right: 12px; }
    .py-2 { padding-top: 8px; padding-bottom: 8px; }
    .mt-2 { margin-top: 8px; }
    .mt-3 { margin-top: 12px; }
    .mt-4 { margin-top: 16px; }
    .text-sm { font-size: 12px; }
    .text-xs { font-size: 11px; }
    .font-mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                   "Liberation Mono", "Courier New", monospace;
    }
    .break-all { word-break: break-all; }

    /* Execute / Result / Timings–style tab bar */
    #tab-navigation {
      display: flex;
      gap: 24px;
      margin-top: 16px;
      border-bottom: 1px solid #e2e8f0;
      padding: 0 2px;
    }

    .tab {
      padding: 8px 0;
      margin-bottom: -1px;
      border: none;
      border-bottom: 2px solid transparent;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      color: #64748b;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .tab i {
      font-size: 13px;
    }

    .tab.active {
      color: #1c96ca;
      border-bottom-color: #1c96ca;
      font-weight: 500;
    }

    /* visible + button in tab header */
    .tab-add {
      margin-left: 4px;
      min-width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      cursor: pointer;
      color: #0f172a;
      padding: 0;
    }

    .tab-add:hover {
      background: #e2e8f0;
    }

    .hidden { display:none; }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index: 2000;
    }

    .modal .panel {
      background:#ffffff;
      max-width:900px;
      width:100%;
      border-radius:16px;
      padding:16px;
      box-shadow: var(--panel-shadow);
      border: 1px solid var(--panel-border);
      color: var(--text-color);
    }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 12px;
    }

    .badge-ok {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      background:#dcfce7;
      border:1px solid #bbf7d0;
      color:#166534;
      font-size:11px;
    }

    .badge-warn {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      background:#fef3c7;
      border:1px solid #fde68a;
      color:#92400e;
      font-size:11px;
    }

    .list-compact {
      list-style:none;
      padding:0;
      margin:0;
    }
    .list-compact li {
      font-size:12px;
      padding:4px 0;
      border-bottom:1px dashed #e2e8f0;
    }
    .list-compact li:last-child { border-bottom:none; }

    .pill {
      display:inline-block;
      border-radius:999px;
      padding:2px 8px;
      font-size:10px;
      border:1px solid #cbd5e1;
      background:#f8fafc;
      color:#475569;
    }

    .value {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                   "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      word-break: break-all;
    }

    .value-muted {
      color:#94a3b8;
      font-style:italic;
    }

    /* Mirror cards + switches inside Mirrors tab */
    .mirror-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 14px;
    }

    .mirror-card {
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      background: #f9fafb;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .mirror-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .mirror-title {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .mirror-format {
      font-weight: 600;
      font-size: 13px;
      color: #0f172a;
    }

    .mirror-desc {
      font-size: 12px;
      color: #64748b;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 34px;
      height: 18px;
      flex-shrink: 0;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: #cbd5f5;
      border-radius: 999px;
      transition: var(--transition);
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 2px;
      top: 2px;
      background-color: #ffffff;
      border-radius: 50%;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.35);
      transition: var(--transition);
    }

    .switch input:checked + .slider {
      background: #1c96ca;
    }

    .switch input:checked + .slider:before {
      transform: translateX(16px);
    }

    /* Simple form styles for create modals */
    .form-group {
      margin-bottom: 10px;
    }
    .form-group label {
      font-size: 12px;
      color: #475569;
      display:block;
      margin-bottom: 4px;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      padding: 6px 8px;
      font-size: 13px;
    }

    /* From original config.html */
    .header-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
  
    .tab-sep {
      width: 1px;
      height: 22px;
      background: rgba(15, 23, 42, 0.12);
      margin: 0 10px;
      align-self: center;
      border-radius: 1px;
    }

    /* --- Readable details blocks in modal --- */
    .details-wrap {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .details-card {
      border: 1px solid rgba(15, 23, 42, 0.10);
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 1px 0 rgba(15, 23, 42, 0.04);
      overflow: hidden;
    }

    .details-card-header {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: rgba(28, 150, 202, 0.06);
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
    }

    .details-card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      color: #0f172a;
      font-size: 13px;
    }

    .details-card-title i {
      color: var(--accent);
    }

    .details-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #0f172a;
      background: rgba(15, 23, 42, 0.06);
      border: 1px solid rgba(15, 23, 42, 0.10);
      padding: 4px 8px;
      border-radius: 999px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .details-grid {
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .details-row {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 10px;
      align-items: start;
    }

    @media (max-width: 740px) {
      .details-row { grid-template-columns: 1fr; }
    }

    .details-label {
      font-size: 12px;
      color: rgba(15, 23, 42, 0.72);
      font-weight: 600;
    }

    .details-value {
      font-size: 12px;
      color: #0f172a;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(15, 23, 42, 0.04);
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 10px;
      padding: 8px 10px;
      line-height: 1.45;
    }

    .details-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: rgba(15, 23, 42, 0.04);
      color: #0f172a;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .chip-strong {
      background: rgba(28, 150, 202, 0.10);
      border-color: rgba(28, 150, 202, 0.35);
    }

  </style>

  <script>
    function api(path, opts) {
      opts = opts || {};
      opts.headers = opts.headers || {};
      if (window.__admintoken) opts.headers['X-Admin-Token'] = window.__admintoken;
      return fetch(path, opts).then(async res => {
        if (!res.ok) { const t = await res.text(); throw new Error(''+res.status+': '+t); }
        return res.json();
      });
    }

    // --- tiny helpers for safe HTML ---
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    
    function safeJsonParseList(val) {
      if (val === null || val === undefined) return [];
      if (Array.isArray(val)) return val;
      const s = String(val);
      try {
        const parsed = JSON.parse(s);
        return Array.isArray(parsed) ? parsed : [parsed];
      } catch {
        return s ? [s] : [];
      }
    }

    function fmtUtcFromMs(msLike) {
      const n = Number(msLike);
      if (!Number.isFinite(n) || n <= 0) return '';
      const d = new Date(n);
      return d.toISOString().replace('T', ' ').replace('Z', ' UTC');
    }

    function renderChips(items, strong) {
      const arr = (items || []).filter(x => x !== null && x !== undefined).map(x => String(x));
      if (!arr.length) return '<span class="details-value" style="display:inline-block;">—</span>';
      return '<div class="details-chips">' + arr.map(v => `<span class="chip ${strong ? 'chip-strong' : ''}">${escapeHtml(v)}</span>`).join('') + '</div>';
    }

    function renderDetailsModal(payload, iconClass) {
      const hash = payload && payload.hash ? String(payload.hash) : '';
      const data = (payload && payload.data) ? payload.data : {};

      // Normalize common fields
      const role = data && data.role ? String(data.role) : '';
      const username = data && data.username ? String(data.username) : '';

      const headerTitle = role ? `Role: ${escapeHtml(role)}` : (username ? `User: ${escapeHtml(username)}` : 'Details');

      const metaBadge = hash ? `<span class="details-badge"><i class="fas fa-fingerprint"></i>${escapeHtml(hash)}</span>` : '';

      const rows = [];

      // Role fields
      if (role) {
        rows.push({ k: 'Role', v: `<div class="details-value">${escapeHtml(role)}</div>` });
        rows.push({ k: 'Tables', v: renderChips(safeJsonParseList(data.tables), true) });
        rows.push({ k: 'Columns', v: renderChips(safeJsonParseList(data.columns), false) });
        rows.push({ k: 'Filters', v: renderChips(safeJsonParseList(data.filters), false) });
      }

      // User fields
      if (username) {
        rows.push({ k: 'Username', v: `<div class="details-value">${escapeHtml(username)}</div>` });
        rows.push({ k: 'Roles', v: renderChips(safeJsonParseList(data.roles), true) });
        if (data.created_ms) rows.push({ k: 'Created', v: `<div class="details-value">${escapeHtml(fmtUtcFromMs(data.created_ms))}</div>` });
        if (data.modified_ms) rows.push({ k: 'Modified', v: `<div class="details-value">${escapeHtml(fmtUtcFromMs(data.modified_ms))}</div>` });
      }

      // Always show raw data keys not already covered (compact)
      const covered = new Set(rows.map(r => r.k.toLowerCase()));
      Object.keys(data || {}).forEach((k) => {
        if (!k) return;
        const keyLower = String(k).toLowerCase();
        if (covered.has(keyLower)) return;
        rows.push({ k: k, v: `<div class="details-value">${escapeHtml(String(data[k]))}</div>` });
      });

      const gridHtml = rows.map(r => `
        <div class="details-row">
          <div class="details-label">${escapeHtml(r.k)}</div>
          <div>${r.v}</div>
        </div>
      `).join('');

      return `
        <div class="details-wrap">
          <div class="details-card">
            <div class="details-card-header">
              <div class="details-card-title"><i class="fas ${escapeHtml(iconClass || 'fa-info-circle')}"></i><span>${headerTitle}</span></div>
              ${metaBadge}
            </div>
            <div class="details-grid">
              ${gridHtml}
            </div>
          </div>
        </div>
      `;
    }
function escapeHtmlAttr(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }


    function escapeJs(str) {
      if (str === null || str === undefined) return '';
      // Safe for single-quoted JS strings in inline onclick handlers.
      return String(str)
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/\r/g, '\\r')
        .replace(/\n/g, '\\n')
        .replace(/\u2028/g, '\\u2028')
        .replace(/\u2029/g, '\\u2029');
    }

    // Mirrors & detail viewers use the selected super from selection.html (pairSel)
    // and a fixed organization.
    async function toggleMirror(fmt, el) {
      const enable = el.checked;
      const sel = document.getElementById('pairSel');
      const sup = sel ? sel.value : '';
      const org = (window.__org || '');

      const ep = enable ? '/reflection/mirrors/enable' : '/reflection/mirrors/disable';
      await api(
        `${ep}?fmt=${encodeURIComponent(fmt)}&org=${encodeURIComponent(org)}&sup=${encodeURIComponent(sup)}`,
        { method: 'POST' }
      );
      location.reload();
    }

    async function viewUser(hash) {
      const sel = document.getElementById('pairSel');
      const sup = sel ? sel.value : '';
      const org = (window.__org || '');
      const data = await api(`/reflection/user/${encodeURIComponent(hash)}?org=${encodeURIComponent(org)}&sup=${encodeURIComponent(sup)}`);
      showModal('User ' + hash, renderDetailsModal(data, 'fa-user'));
    }

    async function viewRole(hash) {
      const sel = document.getElementById('pairSel');
      const sup = sel ? sel.value : '';
      const org = (window.__org || '');
      const data = await api(`/reflection/role/${encodeURIComponent(hash)}?org=${encodeURIComponent(org)}&sup=${encodeURIComponent(sup)}`);
      showModal('Role ' + hash, renderDetailsModal(data, 'fa-user-shield'));
    }

    async function viewMirror(hash) {
      const sel = document.getElementById('pairSel');
      const sup = sel ? sel.value : '';
      const org = (window.__org || '');
      const data = await api(`/reflection/mirror/${encodeURIComponent(hash)}?org=${encodeURIComponent(org)}&sup=${encodeURIComponent(sup)}`);
      showModal('Mirror '+hash, JSON.stringify(data, null, 2));
    }

    /* --- Simple create modals --- */

    function createUserModal() {
      document.getElementById('modal-create-user').style.display = 'flex';
    }

    function closeCreateUserModal() {
      document.getElementById('modal-create-user').style.display = 'none';
    }

    function createRoleModal() {
      document.getElementById('modal-create-role').style.display = 'flex';
    }

    function closeCreateRoleModal() {
      document.getElementById('modal-create-role').style.display = 'none';
    }

    // Placeholder submit handlers (hook to your API later)
    function submitCreateUser(event) {
      event.preventDefault();
      alert('User would be created here.');
      closeCreateUserModal();
    }

    function submitCreateRole(event) {
      event.preventDefault();
      alert('Role would be created here.');
      closeCreateRoleModal();
    }

    /* --- .env CONFIG TAB LOGIC --- */

    async function loadEnvConfig() {
      const infoEl = document.getElementById('env-config-info');
      const pathEl = document.getElementById('env-config-path');
      const tbody = document.getElementById('env-config-table-body');
      if (!infoEl || !pathEl || !tbody) return;

      tbody.innerHTML = '<tr><td colspan="4" class="px-3 py-2 text-sm muted">Loading...</td></tr>';

      try {
        const data = await api('/reflection/env');
        if (data.found) {
          infoEl.innerHTML = `
            <span class="badge-ok">
              <i class="fas fa-check-circle"></i>
              .env file found and loaded
            </span>
          `;
        } else {
          infoEl.innerHTML = `
            <span class="badge-warn">
              <i class="fas fa-exclamation-triangle"></i>
              No .env file found
            </span>
          `;
        }

        pathEl.textContent = data.path || '—';

        renderEnvRows(data.items || []);
      } catch (err) {
        console.error(err);
        infoEl.innerHTML = `
          <span class="badge-warn">
            <i class="fas fa-exclamation-triangle"></i>
            Error loading .env (${escapeHtml(err.message || String(err))})
          </span>
        `;
        tbody.innerHTML = '<tr><td colspan="4" class="px-3 py-2 text-sm muted">Failed to load .env.</td></tr>';
      }
    }

    function renderEnvRows(items) {
      const tbody = document.getElementById('env-config-table-body');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!items || !items.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-3 py-2 text-sm muted">No variables found in .env.</td></tr>';
        return;
      }

      items.forEach((item) => {
        const key = item.key || '';
        const val = item.value || '';
        const isSensitive = !!item.is_sensitive;

        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.setAttribute('data-key', key);
        tr.setAttribute('data-sensitive', isSensitive ? '1' : '0');

        tr.innerHTML = `
          <td class="px-3 py-2 text-sm">
            <span class="value">${escapeHtml(key)}</span>
            ${isSensitive ? '<span class="pill" style="margin-left:6px;"><i class="fas fa-lock" style="font-size:9px;"></i>&nbsp;sensitive</span>' : ''}
          </td>
          <td class="px-3 py-2 text-sm">
            <input
              type="${isSensitive ? 'password' : 'text'}"
              class="env-value-input" readonly
              value="${escapeHtmlAttr(val)}"
              style="width:100%; border-radius:8px; border:1px solid #cbd5e1; padding:4px 6px; font-size:12px; background:#f8fafc; color:#0f172a; cursor:default;"
            />
          </td>
          <td class="px-3 py-2 text-xs">
            ${isSensitive
              ? '<i class="fas fa-eye-slash"></i>&nbsp;hidden'
              : '<i class="fas fa-eye"></i>&nbsp;visible'}
          </td>
          <td class="px-3 py-2 text-sm">
            ${isSensitive
              ? '<button type="button" class="btn-ghost env-toggle-secret"><i class="fas fa-eye"></i>&nbsp;Show</button>'
              : ''}
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    async function saveEnvConfig() {
      const tbody = document.getElementById('env-config-table-body');
      if (!tbody) return;

      const rows = Array.from(tbody.querySelectorAll('tr[data-key]'));
      const items = rows.map(row => {
        const key = row.getAttribute('data-key') || '';
        const input = row.querySelector('.env-value-input');
        const value = input ? input.value : '';
        return { key, value };
      });

      try {
        await api('/reflection/env', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: items })
        });

        const saveMsg = document.getElementById('env-save-message');
        if (saveMsg) {
          saveMsg.innerHTML = `
            <span class="badge-ok">
              <i class="fas fa-check-circle"></i>
              Saved to .env
            </span>
          `;
          setTimeout(() => { saveMsg.innerHTML = ''; }, 2500);
        }
      } catch (err) {
        console.error(err);
        const saveMsg = document.getElementById('env-save-message');
        if (saveMsg) {
          saveMsg.innerHTML = `
            <span class="badge-warn">
              <i class="fas fa-exclamation-triangle"></i>
              Save failed (${escapeHtml(err.message || String(err))})
            </span>
          `;
          setTimeout(() => { saveMsg.innerHTML = ''; }, 4000);
        }
      }
    }

    function toggleAllSecrets() {
      const inputs = document.querySelectorAll('#env-config-table-body tr[data-sensitive="1"] .env-value-input');
      if (!inputs.length) return;
      // check the first sensitive input to decide target state
      const show = Array.from(inputs).some(input => input.type === 'password');
      inputs.forEach(input => {
        input.type = show ? 'text' : 'password';
      });

      // update all row buttons text/icons
      const buttons = document.querySelectorAll('#env-config-table-body .env-toggle-secret');
      buttons.forEach(btn => {
        btn.innerHTML = show
          ? '<i class="fas fa-eye-slash"></i>&nbsp;Hide'
          : '<i class="fas fa-eye"></i>&nbsp;Show';
      });
    }

    /* --- Tab + details modal --- */

    
    function _fmtDate(ms) {
      if (!ms && ms !== 0) return '—';
      try { return new Date(ms).toLocaleString(); } catch (e) { return String(ms); }
    }

    function _maskTokenId(tokenId) {
      const s = String(tokenId || '');
      if (s.length <= 12) return s;
      return s.slice(0, 8) + '…' + s.slice(-6);
    }

    async function loadTokens() {
      const body = document.getElementById('tokensBody');
      if (!body) return;
      body.innerHTML = '<tr><td colspan="4" class="muted">Loading…</td></tr>';
      try {
        const org = window.__org || '';
        const data = await api(`/reflection/tokens?org=${encodeURIComponent(org)}`);
        const tokens = (data && data.tokens) || [];
        if (!tokens.length) {
          body.innerHTML = '<tr><td colspan="4" class="muted">No tokens yet.</td></tr>';
          return;
        }
        body.innerHTML = '';
        tokens.forEach(t => {
          const tokenId = t.token_id || '';
          const label = t.label || '';
          const created = _fmtDate(t.created_ms);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td title="${escapeHtml(tokenId)}"><code>${escapeHtml(_maskTokenId(tokenId))}</code></td>
            <td>${escapeHtml(label)}</td>
            <td>${escapeHtml(created)}</td>
            <td>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteToken('${escapeJs(tokenId)}')">Delete</button>
            </td>
          `;
          body.appendChild(tr);
        });
      } catch (e) {
        body.innerHTML = '<tr><td colspan="4" class="text-danger">Failed to load tokens: '+escapeHtml(e.message)+'</td></tr>';
      }
    }

    async function createTokenModal() {
      const html = `
        <div style="display:flex; flex-direction:column; gap:10px;">
          <label class="muted text-sm">Label (optional)</label>
          <input id="tokenLabel" class="form-control" placeholder="e.g. dev, shared, read-only"/>
          <div class="muted text-sm">The plaintext token will be shown once after creation.</div>
        </div>
      `;
      showModal('Create Login Token', html, async () => {
        const labelEl = document.getElementById('tokenLabel');
        const label = labelEl ? labelEl.value : '';
        const org = window.__org || '';
        const res = await api(`/reflection/tokens?org=${encodeURIComponent(org)}&label=${encodeURIComponent(label || '')}`, {
          method: 'POST'
        });
        const token = res && res.token ? res.token : '';
        const tokenId = res && res.token_id ? res.token_id : '';
        showModal('Token Created', `
          <div class="muted text-sm" style="margin-bottom:8px;">Copy this token now. It will not be shown again.</div>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <div><div class="muted text-sm">Token</div><pre style="margin:0; white-space:pre-wrap;">${escapeHtml(token)}</pre></div>
            <div><div class="muted text-sm">Token ID (sha256)</div><pre style="margin:0; white-space:pre-wrap;">${escapeHtml(tokenId)}</pre></div>
          </div>
        `);
        await loadTokens();
      });
    }

    async function deleteToken(tokenId) {
      if (!tokenId) return;
      const org = window.__org || '';
      if (!confirm('Delete token ' + tokenId + '?')) return;
      await api(`/reflection/tokens/${encodeURIComponent(tokenId)}?org=${encodeURIComponent(org)}`, { method: 'DELETE' });
      await loadTokens();
    }

function switchTab(id) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tabpane').forEach(p => p.classList.add('hidden'));
      document.getElementById('tab-'+id).classList.add('active');
      document.getElementById('pane-'+id).classList.remove('hidden');

      if (id === 'config') {
        loadEnvConfig();
      }
      if (id === 'tokens') {
        loadTokens();
      }
    }

    function showModal(title, bodyHtml, onConfirm, confirmText) {
      const titleEl = document.getElementById('m-title');
      const bodyEl = document.getElementById('m-body');
      const modalEl = document.getElementById('modal');
      const confirmBtn = document.getElementById('m-confirm');

      titleEl.textContent = title;

      // Render as HTML (callers should use escapeHtml() when injecting untrusted strings)
      bodyEl.innerHTML = bodyHtml || "";

      // Reset confirm button
      if (confirmBtn) {
        confirmBtn.style.display = 'none';
        confirmBtn.textContent = (confirmText && String(confirmText)) || 'OK';

        // Remove any previous handler safely by cloning
        const newBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);

        if (typeof onConfirm === 'function') {
          newBtn.style.display = 'inline-flex';
          newBtn.onclick = async () => {
            try {
              newBtn.disabled = true;
              await onConfirm();
            } finally {
              newBtn.disabled = false;
            }
          };
        }
      }

      modalEl.style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    $(document).ready(function(){
      window.__admintoken = "{{ token|e }}";
      window.__org = {{ session_org|default(sel_org|default("", true), true)|tojson }};

      $("#toggleSidebar").on("click", function() {
        $("#sidebar").toggleClass("sidebar-collapsed");
        localStorage.setItem('st_sidebar_collapsed', $("#sidebar").hasClass("sidebar-collapsed"));
      });

      if (localStorage.getItem('st_sidebar_collapsed') === 'true') {
        $("#sidebar").addClass("sidebar-collapsed");
      }

      var path = window.location.pathname;
      if (path.startsWith("/reflection/execute")) {
        $("#link-execute").addClass("active");
      } else if (path.startsWith("/reflection/tables")) {
        $("#link-tables").addClass("active");
      } else {
        $("#link-admin").addClass("active");
      }

      // per-row secret toggle (event delegation)
      $('#env-config-table-body').on('click', '.env-toggle-secret', function() {
        const row = this.closest('tr');
        const input = row ? row.querySelector('.env-value-input') : null;
        if (!input) return;
        if (input.type === 'password') {
          input.type = 'text';
          this.innerHTML = '<i class="fas fa-eye-slash"></i>&nbsp;Hide';
        } else {
          input.type = 'password';
          this.innerHTML = '<i class="fas fa-eye"></i>&nbsp;Show';
        }
      });
    });
  </script>
</head>
<body>
  {% include "sidebar.html" %}

  <div class="content-container">
    {% if not authorized %}
      <div class="wrap"><p>Unauthorized</p></div>
    {% else %}
    <div class="wrap">

      {# SuperTable selection + metrics block #}
      {% include "selection.html" %}

      <div id="tab-navigation">
        <div id="tab-users" class="tab active" onclick="switchTab('users')">
          <i class="fas fa-users"></i><span>Users</span>
          <button type="button" class="tab-add" onclick="createUserModal(); event.stopPropagation();">
            +
          </button>
        </div>
        <div id="tab-roles" class="tab" onclick="switchTab('roles')">
          <i class="fas fa-user-shield"></i><span>Roles</span>
          <button type="button" class="tab-add" onclick="createRoleModal(); event.stopPropagation();">
            +
          </button>
        </div>
        <div id="tab-tokens" class="tab" onclick="switchTab('tokens')">
          <i class="fas fa-key"></i><span>Tokens</span>
          <button type="button" class="tab-add" onclick="createTokenModal(); event.stopPropagation();">+</button>
        </div>

        <div class="tab-sep" aria-hidden="true"></div>

        <div id="tab-mirrors" class="tab" onclick="switchTab('mirrors')">
          <i class="fas fa-mirror"></i><span>Mirrors</span>
        </div>

        <div class="tab-sep" aria-hidden="true"></div>

        <div id="tab-config" class="tab" onclick="switchTab('config')">
          <i class="fas fa-cog"></i><span>.env</span>
        </div>
      </div>

      <!-- USERS TAB -->
      <div id="pane-users" class="tabpane">
        <div class="card mt-4">
          <div class="section">
            <div class="muted text-sm">Users</div>
            <div class="mt-2">
              <table>
                <thead>
                  <tr class="border-b">
                    <th class="px-3 py-2 text-xs muted">hash</th>
                    <th class="px-3 py-2 text-xs muted">name</th>
                    <th class="px-3 py-2 text-xs muted">roles</th>
                  </tr>
                </thead>
                <tbody>
                  {% for u in users %}
                  <tr class="border-b">
                    <!-- hash -->
                    <td class="px-3 py-2 font-mono text-sm">{{ u.hash }}</td>

                    <!-- name / username as button -->
                    <td class="px-3 py-2 text-sm">
                      <button class="btn-ghost" onclick="viewUser('{{ u.hash }}')">
                        {{ u.get('name') or u.get('username') or '' }}
                      </button>
                    </td>

                    <!-- roles as buttons with same style -->
                    <td class="px-3 py-2 text-sm">
                      {% set user_roles = u.get('roles') or [] %}
                      {% if not user_roles %}
                        <span class="value-muted">—</span>
                      {% else %}
                        {% for rh in user_roles %}
                          {% set r = (roles | selectattr('hash', 'equalto', rh) | list | first) %}
                          {% if r %}
                            <button class="btn-ghost"
                                    style="margin-right:4px; margin-bottom:2px;"
                                    title="{{ rh }}"
                                    onclick="viewRole('{{ rh }}')">
                              {{ r.get('role') or r.get('type') or r.get('description') or rh }}
                            </button>
                          {% else %}
                            <button class="btn-ghost"
                                    style="margin-right:4px; margin-bottom:2px;"
                                    title="{{ rh }}"
                                    onclick="viewRole('{{ rh }}')">
                              {{ rh }}
                            </button>
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ROLES TAB -->
      <div id="pane-roles" class="tabpane hidden">
        <div class="card mt-4">
          <div class="section">
            <div class="muted text-sm">Roles</div>
            <div class="mt-2">
              <table>
                <thead>
                  <tr class="border-b">
                    <th class="px-3 py-2 text-xs muted">hash</th>
                    <th class="px-3 py-2 text-xs muted">name</th>
                    <th class="px-3 py-2 text-xs muted">description</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in roles %}
                  <tr class="border-b">
                    <!-- hash -->
                    <td class="px-3 py-2 font-mono text-sm">{{ r.hash }}</td>

                    <!-- name as button -->
                    <td class="px-3 py-2 text-sm">
                      <button class="btn-ghost" onclick="viewRole('{{ r.hash }}')">
                        {{ r.get('role') or r.get('type') or r.get('description') or 'View role' }}
                      </button>
                    </td>

                    <!-- description: tables/columns/filters nicely formatted -->
                    <td class="px-3 py-2 text-sm">
                      {% set tables_raw = r.get('tables') or '' %}
                      {% set columns_raw = r.get('columns') or '' %}
                      {% set filters_raw = r.get('filters') or '' %}

                      {% if tables_raw in ['["*"]', '*'] %}
                        {% set tables_fmt = 'All tables' %}
                      {% elif tables_raw %}
                        {% set tables_fmt = tables_raw
                          |replace('["','')
                          |replace('"]','')
                          |replace('","',', ') %}
                      {% else %}
                        {% set tables_fmt = '—' %}
                      {% endif %}

                      {% if columns_raw in ['["*"]', '*'] %}
                        {% set columns_fmt = 'All columns' %}
                      {% elif columns_raw %}
                        {% set columns_fmt = columns_raw
                          |replace('["','')
                          |replace('"]','')
                          |replace('","',', ') %}
                      {% else %}
                        {% set columns_fmt = '—' %}
                      {% endif %}

                      {% if filters_raw in ['["*"]', '*'] %}
                        {% set filters_fmt = 'All filters' %}
                      {% elif filters_raw %}
                        {% set filters_fmt = filters_raw
                          |replace('["','')
                          |replace('"]','')
                          |replace('","',', ') %}
                      {% else %}
                        {% set filters_fmt = '—' %}
                      {% endif %}

                      <div class="text-xs">
                        <strong>tables:</strong>
                        <span class="value">{{ tables_fmt }}</span>
                      </div>
                      <div class="text-xs">
                        <strong>columns:</strong>
                        <span class="value">{{ columns_fmt }}</span>
                      </div>
                      <div class="text-xs">
                        <strong>filters:</strong>
                        <span class="value">{{ filters_fmt }}</span>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- MIRRORS TAB -->
      <div id="pane-mirrors" class="tabpane hidden">
        <div class="card mt-4">
          <div class="section">
            <div class="muted text-sm">Mirrors</div>
            <div class="mt-2 text-xs muted">
              Enable or disable supported mirror formats for the selected SuperTable.
            </div>
            <div class="mirror-grid">
              {% for fmt in ["DELTA","ICEBERG","PARQUET"] %}
              <div class="mirror-card">
                <div class="mirror-card-header">
                  <div class="mirror-title">
                    <span class="mirror-format">{{ fmt }}</span>
                  </div>
                  <label class="switch">
                    <input type="checkbox"
                           {% if fmt in mirrors_enabled_formats %}checked{% endif %}
                           onchange="toggleMirror('{{fmt}}', this)">
                    <span class="slider"></span>
                  </label>
                </div>
                <div class="mirror-desc">
                  {% if fmt == "DELTA" %}
                    Delta Lake compatible transactional tables with ACID semantics.
                  {% elif fmt == "ICEBERG" %}
                    Apache Iceberg tables optimized for large analytical datasets.
                  {% elif fmt == "PARQUET" %}
                    Plain Parquet files for lightweight interoperability.
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      
      <!-- TOKENS TAB -->
      <div id="pane-tokens" class="tabpane hidden">
        <div class="card mt-4">
          <div class="section">
            <div class="d-flex align-items-center justify-content-between">
              <div class="muted text-sm">Login Tokens</div>
              <button class="btn btn-sm btn-primary" onclick="createTokenModal()">Create Token</button>
            </div>
            <div class="mt-2">
              <table>
                <thead>
                  <tr class="border-top">
                    <th style="width: 36%;">Token ID</th>
                    <th style="width: 24%;">Label</th>
                    <th style="width: 20%;">Created</th>
                    <th style="width: 20%;">Action</th>
                  </tr>
                </thead>
                <tbody id="tokensBody">
                  <tr><td colspan="4" class="muted">Loading…</td></tr>
                </tbody>
              </table>
              <div class="muted text-sm mt-2">
                Tokens are stored hashed (sha256) in Redis. When you create a token, the plaintext value is shown once.
              </div>
            </div>
          </div>
        </div>
      </div>

<!-- CONFIG TAB -->
      <div id="pane-config" class="tabpane hidden">
        <div class="mt-4">
          <div class="card">
            <div class="section">
              <div class="header-row">
                <div>
                  <h4>
                    <i class="fas fa-cog" style="color:#1c96ca;"></i>&nbsp;
                    Environment configuration (.env)
                  </h4>
                  <div class="text-xs muted">
                    Display values from the project <code>.env</code> file. Sensitive values are hidden by default.
                  </div>
                </div>
                <div id="env-save-message"></div>
              </div>

              <div class="text-sm muted" style="margin-top:4px;">.env file</div>
              <div id="env-config-info" class="mt-2 text-xs">
                <!-- status badge injected by loadEnvConfig() -->
              </div>
              <div class="text-xs" style="margin-top:8px;">
                <strong>Path:</strong>
                <span class="value" id="env-config-path">—</span>
              </div>

              <div class="mt-3 text-sm muted">Variables</div>
              <div class="text-xs muted" style="margin-top:4px;">
                Values are read from the <code>.env</code> file on disk (via <code>python-dotenv</code>).
                Sensitive keys (passwords, tokens, secrets, keys) are masked by default; you can reveal them locally.
              </div>

              <div style="margin-top:12px; overflow:auto; max-height:65vh;">
                <table>
                  <thead>
                    <tr class="border-b">
                      <th class="px-3 py-2 text-xs muted">Key</th>
                      <th class="px-3 py-2 text-xs muted">Value</th>
                      <th class="px-3 py-2 text-xs muted">Visibility</th>
                      <th class="px-3 py-2 text-xs muted">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="env-config-table-body">
                    <tr>
                      <td colspan="4" class="px-3 py-2 text-sm muted">Loading...</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div style="margin-top:10px; display:flex; align-items:center; justify-content:space-between;">
                <div>
                  <button type="button" class="btn-ghost" onclick="loadEnvConfig()">
                    <i class="fas fa-sync-alt"></i>&nbsp;Reload from disk
                  </button>
                </div>
                <div>
                  <button type="button" class="btn-ghost" onclick="toggleAllSecrets()">
                    <i class="fas fa-eye"></i>&nbsp;Toggle all secrets
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- END CONFIG TAB -->

      <!-- Detail view modal -->
      <div id="modal" class="modal"
           onclick="if(event.target.id==='modal'){closeModal()}">
        <div class="panel">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <h3 id="m-title" style="margin:0; font-size:16px;"></h3>
            <div style="display:flex; gap:8px; align-items:center;"><button id="m-confirm" class="btn-primary" style="display:none;" type="button">OK</button><button class="btn-ghost" onclick="closeModal()">Close</button></div>
          </div>
          <div id="m-body" class="mt-2" style="max-height:60vh; overflow:auto;"></div>
        </div>
      </div>

      <!-- Create User modal -->
      <div id="modal-create-user" class="modal"
           onclick="if(event.target.id==='modal-create-user'){closeCreateUserModal()}">
        <div class="panel" style="max-width:500px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <h3 style="margin:0; font-size:16px;">Create User</h3>
            <button class="btn-ghost" onclick="closeCreateUserModal()">Close</button>
          </div>
          <form class="mt-3" onsubmit="submitCreateUser(event)">
            <div class="form-group">
              <label for="new-user-name">Name</label>
              <input id="new-user-name" name="name" type="text" required>
            </div>
            <div class="form-group">
              <label for="new-user-email">Email</label>
              <input id="new-user-email" name="email" type="email">
            </div>
            <div class="form-group">
              <label for="new-user-roles">Roles (comma separated)</label>
              <input id="new-user-roles" name="roles" type="text">
            </div>
            <div style="margin-top:12px; text-align:right;">
              <button type="button" class="btn-ghost" onclick="closeCreateUserModal()">Cancel</button>
              <button type="submit" class="btn-ghost" style="margin-left:8px;">
                <i class="fas fa-check"></i>&nbsp;Create
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Create Role modal -->
      <div id="modal-create-role" class="modal"
           onclick="if(event.target.id==='modal-create-role'){closeCreateRoleModal()}">
        <div class="panel" style="max-width:500px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <h3 style="margin:0; font-size:16px;">Create Role</h3>
            <button class="btn-ghost" onclick="closeCreateRoleModal()">Close</button>
          </div>
          <form class="mt-3" onsubmit="submitCreateRole(event)">
            <div class="form-group">
              <label for="new-role-type">Role type</label>
              <input id="new-role-type" name="type" type="text" required>
            </div>
            <div class="form-group">
              <label for="new-role-desc">Description</label>
              <input id="new-role-desc" name="description" type="text">
            </div>
            <div style="margin-top:12px; text-align:right;">
              <button type="button" class="btn-ghost" onclick="closeCreateRoleModal()">Cancel</button>
              <button type="submit" class="btn-ghost" style="margin-left:8px;">
                <i class="fas fa-check"></i>&nbsp;Create
              </button>
            </div>
          </form>
        </div>
      </div>

    </div>
    {% endif %}
  </div>
</body>
</html>
