<div class="super-container" style="
    /* Using the main content background color from the sidebar CSS */
    background-color: #f3f6fb;
    font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    padding: 0px;
">
    <div class="card-professional-themed" style="
        background-color: #ffffff;
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        padding: 24px 50px;
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-left: 5px solid #1c96ca; /* Primary Accent Color */
    ">
        
        {% if session_username %}
        <div style="
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            margin-bottom:18px;
            padding:10px 14px;
            border:1px solid rgba(15,23,42,.08);
            border-radius:12px;
            background: linear-gradient(180deg, rgba(28,150,202,.08), rgba(28,150,202,.03));
            font-size: 13px;
            color:#334155;
        ">
          <div>
            <strong style="color:#0f172a;">{{ session_username }}</strong>
            <span style="color:#94a3b8;">•</span>
            <span>Org:</span> <strong style="color:#0f172a;">{{ session_org }}</strong>
          </div>
          <div style="color:#64748b;">
            {% if session_is_superuser %}
              <span style="display:inline-flex;align-items:center;gap:6px;">
                <span style="width:8px;height:8px;border-radius:999px;background:#10b981;display:inline-block;"></span>
                Superuser
              </span>
            {% else %}
              <span style="display:inline-flex;align-items:center;gap:6px;">
                <span style="width:8px;height:8px;border-radius:999px;background:#3b82f6;display:inline-block;"></span>
                User
              </span>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <div class="grid-professional" style="
            display: flex;
            gap: 40px;
            align-items: flex-start;
        ">
            <!-- LEFT: SuperTable selector -->
            <div style="flex-shrink: 0; min-width: 300px;">
                <label style="
                    display: block;
                    font-size: 14px;
                    color: #475569;
                    margin-bottom: 8px;
                    font-weight: 600;
                ">Select SuperTable</label>
                <select id="pairSel" onchange="onPairChange()" style="
                    width: 100%;
                    padding: 10px 12px;
                    border: 1px solid #d0d7e7;
                    border-radius: 8px;
                    font-size: 16px;
                    background-color: #ffffff;
                    cursor: pointer;
                    appearance: none;
                    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Cpath%20d%3D%22M4%207L10%2013L16%207%22%20stroke%3D%22%23475569%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%0A%3C%2Fsvg%3E');
                    background-repeat: no-repeat;
                    background-position: right 10px center;
                ">
                </select>
                {% if session_is_superuser %}
                <div style="display:flex; gap:10px; margin-top:12px;">
                  <button type="button" id="btnCreateSuper" style="flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(28,150,202,.35); background: rgba(28,150,202,.10); color:#0f172a; font-weight:700; cursor:pointer;">+ Create</button>
                  <button type="button" id="btnDeleteSuper" style="flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(239,68,68,.35); background: rgba(239,68,68,.08); color:#0f172a; font-weight:700; cursor:pointer;">− Delete</button>
                </div>
                {% endif %}
                <div style="
                    font-size: 12px;
                    color: #8894a8;
                    margin-top: 10px;
                ">
                    Select a SuperTable to view its aggregated data metrics.
                </div>
            </div>

            <!-- RIGHT: Metric cards -->
            <div style="flex-grow: 1;">
                <div class="summary-grid" style="
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 15px;
                ">

                    <!-- FILES -->
                    <div class="metric-card-themed" style="
                        background-color: #f5faff;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        padding: 15px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    ">
                        <div class="metric-icon" style="
                            color: #1c96ca;
                            font-size: 20px;
                        "><i class="fas fa-file"></i></div>
                        <div class="metric-content">
                            <div class="metric-label" style="
                                font-size: 12px;
                                color: #475569;
                                font-weight: 500;
                            ">FILES</div>
                            <div class="metric-value" id="tenantFilesValue" style="
                                font-size: 20px;
                                font-weight: 700;
                                color: #34475e;
                            ">n/a</div>
                        </div>
                    </div>

                    <!-- ROWS -->
                    <div class="metric-card-themed" style="
                        background-color: #ffffff;
                        border: 1px solid #d0d7e7;
                        border-radius: 8px;
                        padding: 15px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    ">
                        <div class="metric-icon" style="
                            color: #475569;
                            font-size: 20px;
                        "><i class="fas fa-bars"></i></div>
                        <div class="metric-content">
                            <div class="metric-label" style="
                                font-size: 12px;
                                color: #475569;
                                font-weight: 500;
                            ">ROWS</div>
                            <div class="metric-value" id="tenantRowsValue" style="
                                font-size: 20px;
                                font-weight: 700;
                                color: #34475e;
                            ">n/a</div>
                        </div>
                    </div>

                    <!-- VERSION -->
                    <div class="metric-card-themed" style="
                        background-color: #f5faff;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        padding: 15px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    ">
                        <div class="metric-icon" style="
                            color: #1c96ca;
                            font-size: 20px;
                        "><i class="fas fa-code-branch"></i></div>
                        <div class="metric-content">
                            <div class="metric-label" style="
                                font-size: 12px;
                                color: #475569;
                                font-weight: 500;
                            ">VERSION</div>
                            <div class="metric-value" id="tenantVersionValue" style="
                                font-size: 20px;
                                font-weight: 700;
                                color: #34475e;
                            ">n/a</div>
                        </div>
                    </div>

                    <!-- BYTE SIZE -->
                    <div class="metric-card-themed" style="
                        background-color: #f5faff;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        padding: 15px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    ">
                        <div class="metric-icon" style="
                            color: #1c96ca;
                            font-size: 20px;
                        "><i class="fas fa-database"></i></div>
                        <div class="metric-content">
                            <div class="metric-label" style="
                                font-size: 12px;
                                color: #475569;
                                font-weight: 500;
                            ">BYTE SIZE</div>
                            <div class="metric-value" id="tenantSizeValue" style="
                                font-size: 20px;
                                font-weight: 700;
                                color: #34475e;
                            ">n/a</div>
                        </div>
                    </div>
                </div>

                <div class="tenant-updated" style="
                    margin-top: 15px;
                    text-align: right;
                    font-size: 13px;
                    color: #475569;
                ">
                    Last updated:
                    <span id="tenantUpdatedValue" style="
                        font-weight: 600;
                        color: #34475e;
                    ">n/a</span>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Selection logic: calls /meta/supers and /meta/super -->

<!-- Create/Delete SuperTable Modal -->
<div id="superModal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); z-index:9999; align-items:center; justify-content:center; padding:16px;">
  <div style="width: min(560px, 100%); background:#fff; border-radius:16px; border:1px solid rgba(15,23,42,.12); box-shadow: 0 18px 45px rgba(15,23,42,.25); overflow:hidden;">
    <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:linear-gradient(180deg, rgba(28,150,202,.10), rgba(28,150,202,.03));">
      <div style="font-weight:800; color:#0f172a;" id="superModalTitle">Action</div>
      <button type="button" id="superModalClose" style="border:0; background:transparent; font-size:18px; cursor:pointer; color:#334155;">✕</button>
    </div>
    <div style="padding:16px;">
      <div style="font-size:13px; color:#64748b; margin-bottom:10px;" id="superModalHint"></div>
      <label style="display:block; font-size:12px; font-weight:700; color:#334155; margin-bottom:8px;" for="superNameInput">SuperTable name</label>
      <input id="superNameInput" type="text" placeholder="e.g. example" style="width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(15,23,42,.15); outline:none; font-size:14px;">
      <div style="display:flex; gap:10px; margin-top:14px;">
        <button type="button" id="superModalPrimary" style="flex:1; padding:12px 12px; border-radius:12px; border:0; background:#1c96ca; color:#fff; font-weight:800; cursor:pointer;">Confirm</button>
        <button type="button" id="superModalCancel" style="flex:1; padding:12px 12px; border-radius:12px; border:1px solid rgba(15,23,42,.15); background:#fff; color:#0f172a; font-weight:800; cursor:pointer;">Cancel</button>
      </div>
      <div style="margin-top:12px; font-size:12px; color:#ef4444; display:none;" id="superModalError"></div>
      <div style="margin-top:10px; font-size:12px; color:#10b981; display:none;" id="superModalOk"></div>
    </div>
  </div>
</div>

<script>
(function () {
    // Organization and user hash are injected server-side from the current tenant / selected user.
    // sel_org comes from the backend tenant resolution; default_user_hash is derived from the first admin user.
    const ORG_NAME = {{ session_org|default(sel_org|default("", true), true)|tojson }};
    const USER_HASH = {{ session_user_hash|default(default_user_hash|default("", true), true)|tojson }};
    const IS_SUPERUSER = {{ session_is_superuser|default(false, true)|tojson }};

    const pairSel = document.getElementById("pairSel");
    let lastSupers = [];

    const btnCreate = document.getElementById("btnCreateSuper");
    const btnDelete = document.getElementById("btnDeleteSuper");
    const filesEl = document.getElementById("tenantFilesValue");
    const rowsEl = document.getElementById("tenantRowsValue");
    const sizeEl = document.getElementById("tenantSizeValue");
    const versionEl = document.getElementById("tenantVersionValue");
    const updatedEl = document.getElementById("tenantUpdatedValue");

    function formatBytes(bytes) {
        if (bytes === null || bytes === undefined || isNaN(bytes)) {
            return "n/a";
        }
        let val = Number(bytes);
        const units = ["B", "KB", "MB", "GB", "TB", "PB"];
        let i = 0;
        while (val >= 1024 && i < units.length - 1) {
            val /= 1024;
            i++;
        }
        return val.toFixed(1) + " " + units[i];
    }

    function formatDate(ms) {
        if (!ms && ms !== 0) return "n/a";
        const d = new Date(ms);
        if (isNaN(d.getTime())) return "n/a";
        return d.toLocaleString();
    }

    function applySuperMeta(superMeta) {
        if (!superMeta) {
            filesEl.textContent = "n/a";
            rowsEl.textContent = "n/a";
            sizeEl.textContent = "n/a";
            versionEl.textContent = "n/a";
            updatedEl.textContent = "n/a";
            return;
        }

        filesEl.textContent = superMeta.files != null ? superMeta.files : "0";
        rowsEl.textContent = superMeta.rows != null ? superMeta.rows : "0";
        sizeEl.textContent = superMeta.size != null ? formatBytes(superMeta.size) : "n/a";
        versionEl.textContent = superMeta.version != null ? superMeta.version : "n/a";
        updatedEl.textContent = formatDate(superMeta.updated_utc);
    }

    async function loadSupers() {
        try {
            const resp = await fetch(
                "/admin/supers?organization=" + encodeURIComponent(ORG_NAME)
            );
            if (!resp.ok) {
                throw new Error("Failed to load supers: " + resp.status);
            }
            const data = await resp.json();
            const supers = (data && data.supers) || [];

            pairSel.innerHTML = "";

            if (!supers.length) {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "No SuperTables found";
                pairSel.appendChild(opt);
                applySuperMeta(null);
                return;
            }

            supers.forEach(function (name) {
                const opt = document.createElement("option");
                opt.value = name;
                opt.textContent = name;
                pairSel.appendChild(opt);
            });

            // Auto-load first SuperTable
            if (pairSel.value) {
                await loadSuperMeta(pairSel.value);
            } else {
                applySuperMeta(null);
            }
        } catch (err) {
            console.error("Error loading supers:", err);
            applySuperMeta(null);
        }
    }

    async function loadSuperMeta(superName) {
        if (!superName) {
            applySuperMeta(null);
            return;
        }

        try {
            const params = new URLSearchParams({
                organization: ORG_NAME,
                super_name: superName,
                user_hash: USER_HASH
            });

            const resp = await fetch("/admin/super?" + params.toString());
            if (!resp.ok) {
                throw new Error("Failed to load super meta: " + resp.status);
            }
            const data = await resp.json();
            const superMeta = data && data.meta && data.meta.super;
            applySuperMeta(superMeta || null);
        } catch (err) {
            console.error("Error loading super meta:", err);
            applySuperMeta(null);
        }
    }

    // Expose for onchange="onPairChange()"
    window.onPairChange = function onPairChange() {
        const superName = pairSel.value;
        loadSuperMeta(superName);
    };

    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", loadSupers);
    } else {
        loadSupers();
    }

    function showModal(mode, supersList) {
        const modal = document.getElementById("superModal");
        const title = document.getElementById("superModalTitle");
        const hint = document.getElementById("superModalHint");
        const input = document.getElementById("superNameInput");
        const btnPrimary = document.getElementById("superModalPrimary");
        const btnClose = document.getElementById("superModalClose");
        const btnCancel = document.getElementById("superModalCancel");
        const err = document.getElementById("superModalError");
        const ok = document.getElementById("superModalOk");

        err.style.display = "none";
        ok.style.display = "none";
        input.value = "";
        input.setAttribute("list", "");
        input.removeAttribute("list");

        if (mode === "create") {
            title.textContent = "Create SuperTable";
            hint.textContent = "Enter a new SuperTable name and press Create.";
            btnPrimary.textContent = "Create";
        } else {
            title.textContent = "Delete SuperTable";
            hint.textContent = "Type an existing SuperTable name (autocomplete) and press Delete.";
            btnPrimary.textContent = "Delete";
        }

        // datalist for delete autocomplete
        let dl = document.getElementById("superNameDatalist");
        if (!dl) {
            dl = document.createElement("datalist");
            dl.id = "superNameDatalist";
            document.body.appendChild(dl);
        }
        dl.innerHTML = "";
        (supersList || []).forEach(s => {
            const opt = document.createElement("option");
            opt.value = s;
            dl.appendChild(opt);
        });
        if (mode === "delete") {
            input.setAttribute("list", "superNameDatalist");
        }

        function close() {
            modal.style.display = "none";
            modal.style.alignItems = "";
            modal.style.justifyContent = "";
        }

        btnClose.onclick = close;
        btnCancel.onclick = close;
        modal.onclick = (e) => { if (e.target === modal) close(); };

        btnPrimary.onclick = async () => {
            err.style.display = "none";
            ok.style.display = "none";
            const name = (input.value || "").trim();
            if (!name) {
                err.textContent = "SuperTable name is required.";
                err.style.display = "";
                return;
            }

            try {
                if (mode === "create") {
                    const url = `/admin/super?organization=${encodeURIComponent(ORG_NAME)}&super_name=${encodeURIComponent(name)}`;
                    const res = await fetch(url, { method: "POST" });
                    const js = await res.json();
                    if (!js || !js.ok) throw new Error((js && js.detail) || "Create failed");
                    ok.textContent = `Created: ${js.name || name}`;
                    ok.style.display = "";
                } else {
                    // validate exists
                    if (!Array.isArray(supersList) || !supersList.includes(name)) {
                        err.textContent = "Please choose an existing SuperTable name.";
                        err.style.display = "";
                        return;
                    }
                    const url = `/admin/super?organization=${encodeURIComponent(ORG_NAME)}&super_name=${encodeURIComponent(name)}&user_hash=${encodeURIComponent(USER_HASH)}`;
                    const res = await fetch(url, { method: "DELETE" });
                    const js = await res.json();
                    if (!js || !js.ok) throw new Error((js && js.detail) || "Delete failed");
                    ok.textContent = `Deleted: ${js.name || name}`;
                    ok.style.display = "";
                }

                // refresh list
                await loadSupers();
                close();
            } catch (e) {
                err.textContent = e && e.message ? e.message : "Operation failed.";
                err.style.display = "";
            }
        };

        modal.style.display = "flex";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";
        setTimeout(() => input.focus(), 50);
    }

})();
</script>
