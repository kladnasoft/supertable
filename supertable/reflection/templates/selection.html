<div class="super-container" style="
    /* Using the main content background color from the sidebar CSS */
    background-color: #f3f6fb;
    font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    padding: 0px;
">
    <div class="card-professional-themed" style="
        background-color: #ffffff;
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        padding: 24px 50px;
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-left: 5px solid #1c96ca; /* Primary Accent Color */
    ">
        
        {% if session_username %}
        <div style="
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            margin-bottom:18px;
            padding:10px 14px;
            border:1px solid rgba(15,23,42,.08);
            border-radius:12px;
            background: linear-gradient(180deg, rgba(28,150,202,.08), rgba(28,150,202,.03));
            font-size: 13px;
            color:#334155;
        ">
          <div>
            <strong style="color:#0f172a;">{{ session_username }}</strong>
            <span style="color:#94a3b8;">•</span>
            <span>Org:</span> <strong style="color:#0f172a;">{{ session_org }}</strong>
          </div>
          <div style="display:inline-flex;align-items:center;gap:12px;color:#64748b;">
            {% if session_is_superuser %}
              <span style="display:inline-flex;align-items:center;gap:6px;">
                <span style="width:8px;height:8px;border-radius:999px;background:#10b981;display:inline-block;"></span>
                Superuser
              </span>
            {% else %}
              <span style="display:inline-flex;align-items:center;gap:6px;">
                <span style="width:8px;height:8px;border-radius:999px;background:#3b82f6;display:inline-block;"></span>
                User
              </span>
            {% endif %}
          </div>

          <a href="/reflection/logout" title="Logout" style="
              display:inline-flex;
              align-items:center;
              gap:8px;
              padding:8px 12px;
              border-radius:999px;
              border:1px solid rgba(15,23,42,.10);
              background:#ffffff;
              color:#334155;
              text-decoration:none;
              font-weight:700;
          ">
            <i class="fas fa-sign-out-alt" style="color:#1c96ca;"></i>
            <span style="font-size:12px;">Logout</span>
          </a>

        </div>
        {% endif %}

        <div class="grid-professional" style="
            display: flex;
            gap: 40px;
            align-items: flex-start;
        ">
            <!-- LEFT: SuperTable selector -->
            <div style="flex-shrink: 0; min-width: 300px;">

                <div style="display:grid; grid-template-columns:42px 1fr 42px; gap:10px; align-items:center;">
                  <button type="button" id="btnDeleteSuperInline" title="Delete selected SuperTable"
                    style="width:42px; height:42px; border-radius:12px; border:1px solid rgba(239,68,68,.35); background:transparent; color:#0f172a; font-weight:900; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; line-height:1;"
                    onmouseover="this.style.background='rgba(239,68,68,.08)'"
                    onmouseout="this.style.background='transparent'">−</button>

                  <select id="pairSel" onchange="__st_onPairChange()" style="
                        width: 100%;
                        padding: 10px 12px;
                        border: 1px solid #d0d7e7;
                        border-radius: 8px;
                        font-size: 16px;
                        background-color: #ffffff;
                        cursor: pointer;
                        appearance: none;
                        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Cpath%20d%3D%22M4%207L10%2013L16%207%22%20stroke%3D%22%23475569%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%0A%3C%2Fsvg%3E');
                        background-repeat: no-repeat;
                        background-position: right 10px center;
                    ">
                  </select>

                  <button type="button" id="btnCreateSuperInline" title="Create SuperTable"
                    style="width:42px; height:42px; border-radius:12px; border:1px solid #b1dbec; background:transparent; color:#1c96ca; font-weight:900; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; line-height:1;"
                    onmouseover="this.style.background='#b1dbec'"
                    onmouseout="this.style.background='transparent'">+</button>

                  <div style="
                        grid-column: 2;
                        margin-top: 6px;
                        text-align: center;
                        font-size: 13px;
                        color: #475569;
                    ">
                      Last updated:
                      <span id="tenantUpdatedValue" style="font-weight: 600; color: #34475e;">n/a</span>
                  </div>
                </div>
            </div>

            <!-- RIGHT: Metric cards -->
            <div style="flex-grow: 1;">
                <div class="summary-grid" style="
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 15px;
                ">

                    <!-- FILES -->
                    <div class="metric-card-themed" style="
                        background-color: #f5faff;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        padding: 15px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    ">
                        <div class="metric-icon" style="
                            background: #e6f4fa;
                            width: 40px;
                            height: 40px;
                            border-radius: 999px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: #1c96ca;
                            font-size: 20px;
                        "><i class="fa-solid fa-file"></i></div>
                        <div class="metric-content">
                            <div class="metric-label" style="
                                font-size: 12px;
                                color: #475569;
                                font-weight: 500;
                            ">FILES</div>
                            <div class="metric-value" id="tenantFilesValue" style="
                                font-size: 20px;
                                font-weight: 700;
                                color: #34475e;
                            ">n/a</div>
                        </div>
                    </div>

                    <!-- ROWS -->
                    <div class="metric-card-themed" style="
                        background-color: #f5faff;
                        border: 1px solid #d0d7e7;
                        border-radius: 8px;
                        padding: 15px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    ">
                        <div class="metric-icon" style="
                            color: #475569;
                            font-size: 20px;
                        "><i class="fas fa-bars"></i></div>
                        <div class="metric-content">
                            <div class="metric-label" style="
                                font-size: 12px;
                                color: #475569;
                                font-weight: 500;
                            ">ROWS</div>
                            <div class="metric-value" id="tenantRowsValue" style="
                                font-size: 20px;
                                font-weight: 700;
                                color: #34475e;
                            ">n/a</div>
                        </div>
                    </div>

                    <!-- VERSION -->
                    <div class="metric-card-themed" style="
                        background-color: #f5faff;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        padding: 15px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    ">
                        <div class="metric-icon" style="
                            background: #e6f4fa;
                            width: 40px;
                            height: 40px;
                            border-radius: 999px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: #1c96ca;
                            font-size: 20px;
                        "><i class="fas fa-code-branch"></i></div>
                        <div class="metric-content">
                            <div class="metric-label" style="
                                font-size: 12px;
                                color: #475569;
                                font-weight: 500;
                            ">VERSION</div>
                            <div class="metric-value" id="tenantVersionValue" style="
                                font-size: 20px;
                                font-weight: 700;
                                color: #34475e;
                            ">n/a</div>
                        </div>
                    </div>

                    <!-- BYTE SIZE -->
                    <div class="metric-card-themed" style="
                        background-color: #f5faff;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        padding: 15px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    ">
                        <div class="metric-icon" style="
                            background: #e6f4fa;
                            width: 40px;
                            height: 40px;
                            border-radius: 999px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: #1c96ca;
                            font-size: 20px;
                        "><i class="fa-solid fa-database"></i></div>
                        <div class="metric-content">
                            <div class="metric-label" style="
                                font-size: 12px;
                                color: #475569;
                                font-weight: 500;
                            ">BYTE SIZE</div>
                            <div class="metric-value" id="tenantSizeValue" style="
                                font-size: 20px;
                                font-weight: 700;
                                color: #34475e;
                            ">n/a</div>
                        </div>
                    </div>
                </div>
</div>

        </div>
    </div>
</div>

<!-- Selection logic: calls /meta/supers and /meta/super -->

<!-- Create/Delete SuperTable Modal -->
<div id="superModal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); z-index:9999; align-items:center; justify-content:center; padding:16px;">
  <div style="width: min(560px, 100%); background:#fff; border-radius:16px; border:1px solid rgba(15,23,42,.12); box-shadow: 0 18px 45px rgba(15,23,42,.25); overflow:hidden;">
    <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:linear-gradient(180deg, rgba(28,150,202,.10), rgba(28,150,202,.03));">
      <div style="font-weight:800; color:#0f172a;" id="superModalTitle">Action</div>
      <button type="button" id="superModalClose" style="border:0; background:transparent; font-size:18px; cursor:pointer; color:#334155;">✕</button>
    </div>
    <div style="padding:16px;">
      <div style="font-size:13px; color:#64748b; margin-bottom:10px;" id="superModalHint"></div>
      <label style="display:block; font-size:12px; font-weight:700; color:#334155; margin-bottom:8px;" for="superNameInput">SuperTable name</label>
      <input id="superNameInput" type="text" placeholder="e.g. example" style="width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(15,23,42,.15); outline:none; font-size:14px;">
      <div style="display:flex; gap:10px; margin-top:14px;">
        <button type="button" id="superModalPrimary" style="flex:1; padding:12px 12px; border-radius:12px; border:0; background:#1c96ca; color:#fff; font-weight:800; cursor:pointer;">Confirm</button>
        <button type="button" id="superModalCancel" style="flex:1; padding:12px 12px; border-radius:12px; border:1px solid rgba(15,23,42,.15); background:#fff; color:#0f172a; font-weight:800; cursor:pointer;">Cancel</button>
      </div>
      <div style="margin-top:12px; font-size:12px; color:#ef4444; display:none;" id="superModalError"></div>
      <div style="margin-top:10px; font-size:12px; color:#10b981; display:none;" id="superModalOk"></div>
    </div>
  </div>
</div>

<script>
(function () {
    // Organization and user hash are injected server-side from the current tenant / selected user.
    // sel_org comes from the backend tenant resolution; default_user_hash is derived from the first admin user.
    const ORG_NAME = {{ session_org|default(sel_org|default("", true), true)|tojson }};
    const USER_HASH = {{ session_user_hash|default(default_user_hash|default("", true), true)|tojson }};
    const IS_SUPERUSER = {{ session_is_superuser|default(false, true)|tojson }};
    const PRESELECT_SUP = {{ sel_sup|default("", true)|tojson }};

    const pairSel = document.getElementById("pairSel");
    let lastSupers = [];
    const btnCreateInline = document.getElementById("btnCreateSuperInline");
    const btnDeleteInline = document.getElementById("btnDeleteSuperInline");
const filesEl = document.getElementById("tenantFilesValue");
    const rowsEl = document.getElementById("tenantRowsValue");
    const sizeEl = document.getElementById("tenantSizeValue");
    const versionEl = document.getElementById("tenantVersionValue");
    const updatedEl = document.getElementById("tenantUpdatedValue");

    function formatBytes(bytes) {
        if (bytes === null || bytes === undefined || isNaN(bytes)) {
            return "n/a";
        }
        let val = Number(bytes);
        const units = ["B", "KB", "MB", "GB", "TB", "PB"];
        let i = 0;
        while (val >= 1024 && i < units.length - 1) {
            val /= 1024;
            i++;
        }
        return val.toFixed(1) + " " + units[i];
    }

    function formatDate(ms) {
        if (!ms && ms !== 0) return "n/a";
        const d = new Date(ms);
        if (isNaN(d.getTime())) return "n/a";
        return d.toLocaleString();
    }

    function clearEmbeddedTablesIfPresent() {
        const tbody = document.getElementById('tablesBody');
        if (tbody) tbody.innerHTML = '';
        const totalEl = document.getElementById('tablesTotalCount');
        const shownEl = document.getElementById('tablesShownCount');
        if (totalEl) totalEl.textContent = '0';
        if (shownEl) shownEl.textContent = '0';
    }

    function applySuperMeta(superMeta) {
        if (!superMeta) {
            filesEl.textContent = "n/a";
            rowsEl.textContent = "n/a";
            sizeEl.textContent = "n/a";
            versionEl.textContent = "n/a";
            updatedEl.textContent = "n/a";
            clearEmbeddedTablesIfPresent();
            return;
        }

        filesEl.textContent = superMeta.files != null ? superMeta.files : "0";
        rowsEl.textContent = superMeta.rows != null ? superMeta.rows : "0";
        sizeEl.textContent = superMeta.size != null ? formatBytes(superMeta.size) : "n/a";
        versionEl.textContent = superMeta.version != null ? superMeta.version : "n/a";
        updatedEl.textContent = formatDate(superMeta.updated_utc);
    }

    async function loadSupers() {
        try {
            const resp = await fetch(
                "/reflection/supers?organization=" + encodeURIComponent(ORG_NAME)
            );
            if (!resp.ok) {
                throw new Error("Failed to load supers: " + resp.status);
            }
            const data = await resp.json();
            const supers = (data && data.supers) || [];
            lastSupers = supers;

            pairSel.innerHTML = "";

            if (!supers.length) {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "No SuperTables found";
                pairSel.appendChild(opt);
                applySuperMeta(null);
                return;
            }

            supers.forEach(function (name) {
                const opt = document.createElement("option");
                opt.value = name;
                opt.textContent = name;
                pairSel.appendChild(opt);
            });

            // Prefer URL (?sup=) or server-selected sup when available.
            let initialSup = "";
            try {
                const params0 = new URLSearchParams(window.location.search || "");
                initialSup = (params0.get("sup") || "").trim();
            } catch (e) {
                // ignore
            }
            if (!initialSup) {
                initialSup = (PRESELECT_SUP || "").trim();
            }

            if (initialSup) {
                const found = Array.from(pairSel.options || []).some(o => o && o.value === initialSup);
                if (found) pairSel.value = initialSup;
            }

            // Auto-load selected SuperTable
            if (pairSel.value) {
                await loadSuperMeta(pairSel.value);
            } else {
                applySuperMeta(null);
            }
        } catch (err) {
            console.error("Error loading supers:", err);
            applySuperMeta(null);
        }
    }

    async function loadSuperMeta(superName) {
        clearEmbeddedTablesIfPresent();
        if (!superName) {
            applySuperMeta(null);
            return;
        }

        try {
            const params = new URLSearchParams({
                organization: ORG_NAME,
                super_name: superName,
                user_hash: USER_HASH
            });

            const resp = await fetch("/reflection/super?" + params.toString());
            if (!resp.ok) {
                throw new Error("Failed to load super meta: " + resp.status);
            }
            const data = await resp.json();
            const superMeta = data && data.meta && data.meta.super;
            applySuperMeta(superMeta || null);
        } catch (err) {
            console.error("Error loading super meta:", err);
            applySuperMeta(null);
        }
    }

    // Primary handler for the SuperTable selector.
    // - Updates the selection metrics block (this template)
    // - Notifies the host page (CustomEvent)
    // - Delegates to a page-provided onPairChange() if one exists
    // - Falls back to a full page reload for pages that are server-rendered (admin/notebooks/etc.)
    window.__st_onPairChange = function __st_onPairChange() {
        const superName = pairSel.value;

        // Always refresh selection metrics immediately.
        loadSuperMeta(superName);

        // Keep URL in sync so refresh / deep links preserve the selection.
        let nextHref = "";
        try {
            const u = new URL(window.location.href);
            if (ORG_NAME) u.searchParams.set("org", ORG_NAME);
            if (superName) u.searchParams.set("sup", superName);
            nextHref = u.toString();
            history.replaceState(null, "", nextHref);
        } catch (e) {
            // ignore
        }

        // Notify any page-level listeners (ingestion, etc.)
        let allowFallbackReload = true;
        try {
            const ev = new CustomEvent("supertable-changed", {
                cancelable: true,
                detail: { org: ORG_NAME, sup: superName, super_name: superName }
            });
            allowFallbackReload = window.dispatchEvent(ev);
        } catch (e) {
            // ignore
        }

        // If the host page defines its own onPairChange(), call it too (do not recurse).
        try {
            if (typeof window.onPairChange === "function" && window.onPairChange !== window.__st_onPairChange) {
                window.onPairChange(ORG_NAME, superName);
                return;
            }
        } catch (e) {
            console.error("Page onPairChange failed:", e);
        }

        // No page handler => reload so server-rendered sections change with the tenant.
        if (allowFallbackReload) {
            if (nextHref) {
                window.location.href = nextHref;
            } else {
                window.location.reload();
            }
        }
    };

    // Backwards-compat: keep onPairChange() available if the page doesn't define one.
    if (typeof window.onPairChange !== "function") {
        window.onPairChange = window.__st_onPairChange;
    }

    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", loadSupers);
    } else {
        loadSupers();
    }

    function showModal(mode, supersList, selectedName) {
        const modal = document.getElementById("superModal");
        const title = document.getElementById("superModalTitle");
        const hint = document.getElementById("superModalHint");
        const input = document.getElementById("superNameInput");
        const btnPrimary = document.getElementById("superModalPrimary");
        const btnClose = document.getElementById("superModalClose");
        const btnCancel = document.getElementById("superModalCancel");
        const err = document.getElementById("superModalError");
        const ok = document.getElementById("superModalOk");

        err.style.display = "none";
        ok.style.display = "none";
        input.value = "";
        if (mode === "delete" && (selectedName || "").trim()) {
            input.value = String(selectedName).trim();
            input.select();
        }
        input.setAttribute("list", "");
        input.removeAttribute("list");

        if (mode === "create") {
            title.textContent = "Create SuperTable";
            hint.textContent = "Enter a new SuperTable name and press Create.";
            btnPrimary.textContent = "Create";
        } else {
            title.textContent = "Delete SuperTable";
            const sel = (selectedName || "").trim();
            hint.textContent = sel
              ? ("Only the selected SuperTable can be deleted. Type \"" + sel + "\" to confirm, then press Delete.")
              : "Select a SuperTable first, then click − to delete. You must type its name to confirm.";
            btnPrimary.textContent = "Delete";
        }

        // datalist for delete autocomplete
        let dl = document.getElementById("superNameDatalist");
        if (!dl) {
            dl = document.createElement("datalist");
            dl.id = "superNameDatalist";
            document.body.appendChild(dl);
        }
        dl.innerHTML = "";
        (supersList || []).forEach(s => {
            const opt = document.createElement("option");
            opt.value = s;
            dl.appendChild(opt);
        });
        // For delete: restrict to selectedName; no datalist.
        if (mode === "delete") {
            input.removeAttribute("list");
        }

        function close() {
            modal.style.display = "none";
            modal.style.alignItems = "";
            modal.style.justifyContent = "";
        }

        btnClose.onclick = close;
        btnCancel.onclick = close;
        modal.onclick = (e) => { if (e.target === modal) close(); };

        btnPrimary.onclick = async () => {
            err.style.display = "none";
            ok.style.display = "none";
            const name = (input.value || "").trim();
            if (!name) {
                err.textContent = "SuperTable name is required.";
                err.style.display = "";
                return;
            }

            try {
                if (mode === "create") {
                    const url = `/reflection/super?organization=${encodeURIComponent(ORG_NAME)}&super_name=${encodeURIComponent(name)}`;
                    const res = await fetch(url, { method: "POST" });
                    const js = await res.json();
                    if (!js || !js.ok) throw new Error((js && js.detail) || "Create failed");
                    ok.textContent = `Created: ${js.name || name}`;
                    ok.style.display = "";
                } else {
                    const selected = (selectedName || "").trim();
                    if (!selected) {
                        err.textContent = "Select a SuperTable first.";
                        err.style.display = "";
                        return;
                    }
                    if (name !== selected) {
                        err.textContent = "Type the selected SuperTable name exactly to confirm deletion.";
                        err.style.display = "";
                        return;
                    }
                    const url = `/reflection/super?organization=${encodeURIComponent(ORG_NAME)}&super_name=${encodeURIComponent(selected)}&user_hash=${encodeURIComponent(USER_HASH)}`;
                    const res = await fetch(url, { method: "DELETE" });
                    const js = await res.json();
                    if (!js || !js.ok) throw new Error((js && js.detail) || "Delete failed");
                    ok.textContent = `Deleted: ${js.name || name}`;
                    ok.style.display = "";
                }

                // refresh list
                await loadSupers();
                close();
            } catch (e) {
                err.textContent = e && e.message ? e.message : "Operation failed.";
                err.style.display = "";
            }
        };

        modal.style.display = "flex";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";
        setTimeout(() => input.focus(), 50);
    }


    // Inline create/delete buttons next to SuperTable selector
    function setInlineSuperButtonsVisibility() {
      const show = !!IS_SUPERUSER;
      if (btnCreateInline) btnCreateInline.style.display = show ? "flex" : "none";
      if (btnDeleteInline) btnDeleteInline.style.display = show ? "flex" : "none";
    }
    setInlineSuperButtonsVisibility();

    if (btnCreateInline) {
      btnCreateInline.addEventListener("click", () => {
        showModal("create", Array.isArray(lastSupers) ? lastSupers : [], pairSel ? pairSel.value : "");
      });
    }

    if (btnDeleteInline) {
      btnDeleteInline.addEventListener("click", () => {
        showModal("delete", Array.isArray(lastSupers) ? lastSupers : [], pairSel ? pairSel.value : "");
      });
    }

})();
</script>
