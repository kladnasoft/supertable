{% extends "base.html" %}

{% block title %}Compute Pools{% endblock %}

{% block head_extra %}
<style>
  .muted { color:#64748b; font-size: 12px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  .root {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    padding: 24px 28px;
    border: 1px solid rgba(0,0,0,0.05);
    border-left: 5px solid #1c96ca;
  }
  .title { font-size: 18px; font-weight: 900; color:#0f172a; }

  .panel {
    border: 1px solid rgba(15,23,42,.10);
    border-radius: 16px;
    background: #fff;
    padding: 14px 14px;
  }
  .panel + .panel { margin-top: 12px; }
  .panel-head {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    flex-wrap: wrap;
  }
  .panel-title {
    font-weight: 900;
    color:#0f172a;
    display:flex;
    align-items:center;
    gap: 8px;
    font-size: 13px;
  }

  .btn-azure-outline {
    border: 1px solid #1c96ca;
    background: transparent;
    color: #1c96ca;
    font-weight: 600;
    transition: background-color 0.2s ease, color 0.2s ease;
  }
  .btn-azure-outline:hover { background: #1c96ca; color: #ffffff; }

  .btn-danger-outline {
    border: 1px solid rgba(239,68,68,0.75);
    background: transparent;
    color: rgba(239,68,68,0.9);
    font-weight: 700;
    transition: background-color 0.2s ease, color 0.2s ease;
  }
  .btn-danger-outline:hover { background: rgba(239,68,68,0.9); color:#fff; }

  .rowcard {
    border: 1px solid rgba(15,23,42,.10);
    border-radius: 16px;
    background:#fff;
    padding: 12px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 10px;
    flex-wrap: wrap;
  }
  .rowcard + .rowcard { margin-top: 10px; }

  .rowcard .name { font-weight: 900; color:#0f172a; font-size: 13px; }
  .rowcard .sub { margin-top: 4px; color:#64748b; font-size: 12px; }

  .toast {
    position: fixed;
    right: 18px;
    top: 16px;
    z-index: 5000;
    background: rgba(15,23,42,0.92);
    color: #fff;
    border-radius: 14px;
    padding: 10px 12px;
    font-size: 12px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.22);
    display:none;
    max-width: min(520px, calc(100vw - 36px));
  }
</style>
{% endblock %}

{% block content %}
{% include "selection.html" %}
<div style="height: 18px;"></div>

<div id="root" class="root" data-org="{{ sel_org }}" data-sup="{{ sel_sup }}" data-user-hash="{{ session_user_hash }}">
  <div>
    <div class="title">Compute Pools</div>
    <div class="muted" style="margin-top:4px;">
      Configure compute pools (clusters/runtimes). Pool binding for notebook execution will be refined later.
    </div>
  </div>

  {% if not has_tenant %}
    <div style="margin-top: 14px; color:#64748b;">Select a tenant (organization + super) first.</div>
  {% else %}
    <div class="panel" style="margin-top:14px;">
      <div class="panel-head">
        <div class="panel-title"><i class="fas fa-microchip" style="color:#1c96ca;"></i> Pools</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn-sm btn-azure-outline" id="btnNew"><i class="fas fa-plus"></i> New pool</button>
          <button class="btn btn-sm btn-azure-outline" id="btnRefresh"><i class="fas fa-rotate"></i> Refresh</button>
        </div>
      </div>
      <div id="list" style="margin-top:12px;"></div>
      <div id="empty" class="muted" style="display:none; margin-top:10px;">No pools yet.</div>
    </div>

    <div class="panel">
      <div class="panel-head">
        <div class="panel-title"><i class="fas fa-circle-info" style="color:#1c96ca;"></i> Notes</div>
      </div>
      <div class="muted" style="margin-top:10px;">
        Recommended fields we store now:
        <div class="mono" style="margin-top:6px;">kind: in-process | spark | kubernetes</div>
        <div class="mono">size: small | medium | large</div>
        <div class="mono">max_concurrency</div>
        <div class="mono">is_default</div>
        <div class="muted" style="margin-top:10px;">
          Later we can bind this into notebook execution (job payload), and route jobs to different backends.
        </div>
      </div>
    </div>
  {% endif %}
</div>

<div class="toast" id="toast"></div>

{% endblock %}

{% block body_scripts %}
<script>
(function () {
  const ln = document.getElementById("link-compute-pools");
  if (ln) ln.classList.add("active");

  function toast(msg) {
    const el = document.getElementById('toast');
    if (!el) return;
    el.textContent = String(msg || '');
    el.style.display = 'block';
    clearTimeout(toast._t);
    toast._t = setTimeout(() => { el.style.display = 'none'; }, 1800);
  }

  function root() { return document.getElementById('root'); }
  function ctx() {
    const r = root();
    return {
      org: r ? (r.dataset.org || '') : '',
      sup: r ? (r.dataset.sup || '') : '',
    };
  }

  async function getJSON(url) {
    const resp = await fetch(url, { credentials: "same-origin" });
    const text = await resp.text();
    let js = null;
    try { js = JSON.parse(text); } catch (e) { js = null; }
    if (!resp.ok) {
      const msg = (js && (js.detail || js.error)) || text || ("Request failed: " + resp.status);
      throw new Error(msg);
    }
    return js;
  }

  async function postJSON(url, obj) {
    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(obj || {}),
      credentials: "same-origin",
    });
    const text = await resp.text();
    let js = null;
    try { js = JSON.parse(text); } catch (e) { js = null; }
    if (!resp.ok) {
      const msg = (js && (js.detail || js.error)) || text || ("Request failed: " + resp.status);
      throw new Error(msg);
    }
    return js;
  }

  async function del(url) {
    const resp = await fetch(url, { method:'DELETE', credentials:'same-origin' });
    const text = await resp.text();
    let js = null;
    try { js = JSON.parse(text); } catch (e) { js = null; }
    if (!resp.ok) {
      const msg = (js && (js.detail || js.error)) || text || ("Request failed: " + resp.status);
      throw new Error(msg);
    }
    return js;
  }

  function esc(s) {
    return String(s||'')
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  let pools = [];

  async function loadPools() {
    const { org, sup } = ctx();
    const js = await getJSON(`/reflection/compute-pools/list?org=${encodeURIComponent(org)}&sup=${encodeURIComponent(sup)}`);
    pools = js && js.data && Array.isArray(js.data.items) ? js.data.items : [];
    render();
  }

  function render() {
    const wrap = document.getElementById('list');
    const empty = document.getElementById('empty');
    if (!wrap) return;
    wrap.innerHTML = '';

    pools.forEach(p => {
      const div = document.createElement('div');
      div.className = 'rowcard';
      div.innerHTML = `
        <div>
          <div class="name">${esc(p.name || 'Pool')}${p.is_default ? ' <span class="muted">(default)</span>' : ''}</div>
          <div class="sub">kind: <span class="mono">${esc(p.kind || '')}</span> • size: <span class="mono">${esc(p.size || '')}</span> • max: <span class="mono">${esc(String(p.max_concurrency || 1))}</span></div>
          ${p.notes ? `<div class="sub">${esc(p.notes)}</div>` : ``}
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn-sm btn-azure-outline" data-act="edit"><i class="fas fa-pen"></i> Edit</button>
          <button class="btn btn-sm btn-azure-outline" data-act="default"><i class="fas fa-star"></i> Default</button>
          <button class="btn btn-sm btn-danger-outline" data-act="del"><i class="fas fa-trash"></i> Delete</button>
        </div>
      `;

      div.querySelector('button[data-act="edit"]').addEventListener('click', () => editPool(p));
      div.querySelector('button[data-act="default"]').addEventListener('click', () => setDefault(p));
      div.querySelector('button[data-act="del"]').addEventListener('click', () => deletePool(p));
      wrap.appendChild(div);
    });

    if (empty) empty.style.display = pools.length ? 'none' : '';
  }

  async function upsertPool(pool) {
    const { org, sup } = ctx();
    await postJSON('/reflection/compute-pools/upsert', { org, sup, item: pool });
    await loadPools();
  }

  async function deletePool(pool) {
    const { org, sup } = ctx();
    if (!confirm('Delete this pool?')) return;
    await del(`/reflection/compute-pools/${encodeURIComponent(pool.id)}?org=${encodeURIComponent(org)}&sup=${encodeURIComponent(sup)}`);
    await loadPools();
    toast('Deleted');
  }

  async function setDefault(pool) {
    // mark as default via upsert
    const p = { ...pool, is_default: true };
    await upsertPool(p);
    toast('Default updated');
  }

  function promptPool(existing) {
    const p = existing ? { ...existing } : { id:'', name:'', kind:'in-process', size:'small', max_concurrency:1, is_default:false, notes:'' };
    const name = prompt('Pool name', p.name || '');
    if (name === null) return null;
    p.name = name.trim();
    if (!p.name) return null;

    const kind = prompt('Kind (in-process | spark | kubernetes)', p.kind || 'in-process');
    if (kind === null) return null;
    p.kind = kind.trim() || 'in-process';

    const size = prompt('Size (small | medium | large)', p.size || 'small');
    if (size === null) return null;
    p.size = size.trim() || 'small';

    const mc = prompt('Max concurrency', String(p.max_concurrency || 1));
    if (mc === null) return null;
    const n = parseInt(mc, 10);
    p.max_concurrency = (Number.isFinite(n) && n > 0) ? n : 1;

    const notes = prompt('Notes (optional)', p.notes || '');
    if (notes === null) return null;
    p.notes = notes;

    return p;
  }

  async function newPool() {
    const p = promptPool(null);
    if (!p) return;
    await upsertPool(p);
    toast('Created');
  }

  async function editPool(existing) {
    const p = promptPool(existing);
    if (!p) return;
    await upsertPool(p);
    toast('Saved');
  }

  const btnNew = document.getElementById('btnNew');
  if (btnNew) btnNew.addEventListener('click', (e) => { e.preventDefault(); newPool().catch(err => toast(err.message)); });

  const btnRefresh = document.getElementById('btnRefresh');
  if (btnRefresh) btnRefresh.addEventListener('click', (e) => { e.preventDefault(); loadPools().catch(err => toast(err.message)); });

  loadPools().catch(err => toast(err.message));
})();
</script>
{% endblock %}
