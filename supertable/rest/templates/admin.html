<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SuperTable Redis Admin</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- jQuery + Bootstrap -->
  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js">
  </script>

  <style>
    :root {
      /* Sidebar palette (from Data Reflection) */
      --primary-color: #1c96ca;
      --primary-light: #e6f4fa;
      --secondary-color: #147ba3;
      --dark-color: #1a1a2e;
      --light-color: #f8f9fa;
      --text-color: #2b2d42;
      --text-light: #8d99ae;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);

      /* Cards / panels */
      --panel-bg: #ffffff;
      --panel-border: #e0e5f0;
      --panel-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont;
      background: #f3f6fb;
      color: var(--text-color);
    }

    a {
      color: var(--primary-color);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    /* --------- SIDEBAR --------- */

    .sidebar {
      width: 280px;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      background: linear-gradient(180deg, #ffffff 0%, #f5faff 100%);
      box-shadow: 4px 0 15px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      z-index: 1100;
      transition: var(--transition);
      overflow: hidden;
    }

    .sidebar-collapsed {
      width: 80px;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 20px 15px;
      cursor: pointer;
      background: white;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      height: 80px;
    }

    .data-reflection-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      position: relative;
      flex-shrink: 0;
    }

    .data-cube {
      width: 30px;
      height: 30px;
      background: var(--primary-color);
      position: relative;
      transform: rotate(0deg);
      overflow: hidden;
      transition: var(--transition);
      box-shadow: 0 2px 8px rgba(28, 150, 202, 0.3);
    }

    #toggleSidebar:hover .data-cube {
      transform: rotate(90deg);
      box-shadow: 0 4px 12px rgba(28, 150, 202, 0.5);
    }

    .data-cube:before {
      content: '';
      position: absolute;
      width: 150%;
      height: 40%;
      background: linear-gradient(90deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.7) 50%,
        rgba(255,255,255,0) 100%);
      transform: translateX(-100%) rotate(45deg);
      top: -10%;
      left: -10%;
      transition: transform 0.8s ease;
    }

    #toggleSidebar:hover .data-cube:before {
      transform: translateX(100%) rotate(45deg);
    }

    .reflection {
      position: absolute;
      width: 10px;
      height: 10px;
      background: rgba(255,255,255,0.8);
      border-radius: 2px;
      bottom: 5px;
      right: 5px;
      transition: var(--transition);
      opacity: 0.7;
    }

    #toggleSidebar:hover .reflection {
      opacity: 1;
      transform: scale(1.3) translate(-2px, -2px);
    }

    .data-grid {
      position: absolute;
      width: 100%;
      height: 100%;
      background:
        linear-gradient(0deg, rgba(0,0,0,0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
      background-size: 7px 7px;
      opacity: 0.6;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 700;
      color: transparent;
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      background-clip: text;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      transition: var(--transition);
      white-space: nowrap;
      margin-left: 12px;
    }

    .sidebar-collapsed .logo-text {
      display: none;
    }

    #toggleSidebar:hover .logo-text {
      text-shadow: 0 2px 6px rgba(28, 150, 202, 0.4);
    }

    .sidebar-nav {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-light) transparent;
    }

    .sidebar-nav::-webkit-scrollbar {
      width: 4px;
    }

    .sidebar-nav::-webkit-scrollbar-thumb {
      background-color: var(--primary-light);
      border-radius: 4px;
    }

    .sidebar-link {
      color: var(--text-color);
      padding: 10px 12px;
      border-radius: 8px;
      transition: var(--transition);
      font-weight: 500;
      margin-bottom: 4px;
      background: linear-gradient(to right, transparent 50%, var(--primary-light) 50%);
      background-size: 200% 100%;
      background-position: right bottom;
      border-left: 3px solid transparent;
      display: flex;
      align-items: center;
    }

    .sidebar-link i {
      margin-right: 10px;
      width: 18px;
      text-align: center;
    }

    .sidebar-collapsed .sidebar-link span {
      display: none;
    }

    .sidebar-collapsed .sidebar-link i {
      margin-right: 0;
    }

    .sidebar-link:hover {
      background-position: left bottom;
      border-left-color: var(--primary-color);
      text-decoration: none;
    }

    .sidebar-link.active {
      background: #e6f0ff;
      border-left-color: var(--primary-color);
      font-weight: 600;
      color: var(--primary-color);
    }

    .profile-section {
      padding: 12px 15px;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      background: white;
      flex-shrink: 0;
    }

    .profile-section-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      color: var(--text-light);
    }

    .profile-section-inner strong {
      color: var(--text-color);
    }

    /* --------- CONTENT AREA --------- */

    .content-container {
      margin-left: 280px;
      min-height: 100vh;
      background-color: #f3f6fb;
      transition: var(--transition);
      padding-bottom: 40px;
    }

    .sidebar-collapsed ~ .content-container {
      margin-left: 80px;
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .card {
      background: var(--panel-bg);
      border-radius: 16px;
      box-shadow: var(--panel-shadow);
      border: 1px solid var(--panel-border);
    }

    .section {
      padding: 16px 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .top-row {
      display: flex;
      justify-content: flex-start;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    /* change this if you already have it, or add if not */
    .top-row .card {
      flex: 1 1 280px;   /* Tenant + Mirrors are wider, flexible */
    }

    /* NEW: make Root card narrower */
    .top-row .root-card {
      flex: 0 0 250px;   /* smaller fixed-ish width for the middle card */
    }

    .muted { color: var(--text-light); }
    .btn {
      padding: 8px 12px;
      border-radius: 10px;
      background: #0b2940;
      border: 1px solid #1d3b57;
      color: #e2e8f0;
      font-weight: 500;
      cursor: pointer;
      font-size: 13px;
    }

    .btn:hover { filter: brightness(1.1); }

    .btn-ghost {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #d0d7e7;
      background: transparent;
      color: #475569;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-ghost:hover {
      background: #e2e8f0;
    }

    input, select {
      background: #ffffff;
      border: 1px solid #d0d7e7;
      color: var(--text-color);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
    }

    input:focus, select:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(28,150,202,0.15);
      border-color: var(--primary-color);
    }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; }

    .border-b { border-bottom: 1px solid #e2e8f0; }
    .px-3 { padding-left: 12px; padding-right: 12px; }
    .py-2 { padding-top: 8px; padding-bottom: 8px; }
    .mt-2 { margin-top: 8px; }
    .mt-3 { margin-top: 12px; }
    .mt-4 { margin-top: 16px; }
    .rounded { border-radius: 10px; }
    .text-sm { font-size: 12px; }
    .text-xs { font-size: 11px; }
    .font-mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                   "Liberation Mono", "Courier New", monospace;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f1f5f9;
      border: 1px solid #d0d7e7;
      font-size: 11px;
    }

    .flex { display:flex; align-items:center; gap:10px; }
    .right { text-align: right; }
    .break-all { word-break: break-all; }

    .tabs {
      display:flex;
      gap:8px;
      margin-top:12px;
    }

    .tab {
      padding:8px 12px;
      border:1px solid #d0d7e7;
      border-radius:10px;
      cursor:pointer;
      font-size: 13px;
      background: #ffffff;
    }

    .tab.active {
      background: #e6f4fa;
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .hidden { display:none; }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index: 2000;
    }

    .modal .panel {
      background:#ffffff;
      max-width:900px;
      width:100%;
      border-radius:16px;
      padding:16px;
      box-shadow: var(--panel-shadow);
      border: 1px solid var(--panel-border);
      color: var(--text-color);
    }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 12px;
    }
  </style>

  <script>
    function api(path, opts) {
      opts = opts || {};
      opts.headers = opts.headers || {};
      if (window.__admintoken) opts.headers['X-Admin-Token'] = window.__admintoken;
      return fetch(path, opts).then(async res => {
        if (!res.ok) { const t = await res.text(); throw new Error(''+res.status+': '+t); }
        return res.json();
      });
    }

    function onPairChange() {
      const sel = document.getElementById('pairSel');
      const [org, sup] = sel.value.split('|');
      const params = new URLSearchParams(window.location.search);
      params.set('org', org);
      params.set('sup', sup);
      params.set('page','1');
      window.location.search = params.toString();
    }

    async function toggleMirror(fmt, el) {
      const enable = el.checked;
      const sel = document.getElementById('pairSel');
      const [org, sup] = sel.value.split('|');
      const ep = enable ? '/api/mirrors/enable' : '/api/mirrors/disable';
      await api(`${ep}?fmt=${encodeURIComponent(fmt)}&org=${encodeURIComponent(org)}&sup=${encodeURIComponent(sup)}`, {method:'POST'});
      location.reload();
    }

    async function viewUser(hash) {
      const sel = document.getElementById('pairSel');
      const [org, sup] = sel.value.split('|');
      const data = await api(`/api/user/${encodeURIComponent(hash)}?org=${encodeURIComponent(org)}&sup=${encodeURIComponent(sup)}`);
      showModal('User '+hash, JSON.stringify(data, null, 2));
    }

    async function viewRole(hash) {
      const sel = document.getElementById('pairSel');
      const [org, sup] = sel.value.split('|');
      const data = await api(`/api/role/${encodeURIComponent(hash)}?org=${encodeURIComponent(org)}&sup=${encodeURIComponent(sup)}`);
      showModal('Role '+hash, JSON.stringify(data, null, 2));
    }

    function switchTab(id) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tabpane').forEach(p => p.classList.add('hidden'));
      document.getElementById('tab-'+id).classList.add('active');
      document.getElementById('pane-'+id).classList.remove('hidden');
    }

    function showModal(title, body) {
      document.getElementById('m-title').textContent = title;
      document.getElementById('m-body').textContent = body;
      document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    // Sidebar toggle + active link handling
    $(document).ready(function(){
      window.__admintoken = "{{ token|e }}";

      $("#toggleSidebar").on("click", function() {
        $("#sidebar").toggleClass("sidebar-collapsed");
        localStorage.setItem('st_sidebar_collapsed', $("#sidebar").hasClass("sidebar-collapsed"));
      });

      if (localStorage.getItem('st_sidebar_collapsed') === 'true') {
        $("#sidebar").addClass("sidebar-collapsed");
      }

      var path = window.location.pathname;
      if (path.startsWith("/admin/config")) {
        $("#link-config").addClass("active");
      } else if (path.startsWith("/admin/execute")) {
        $("#link-execute").addClass("active");
      } else if (path.startsWith("/admin/tables")) {
        $("#link-tables").addClass("active");
      } else {
        $("#link-admin").addClass("active");
      }
    });
  </script>
</head>
<body>
  {% include "sidebar.html" %}

  <!-- MAIN CONTENT -->
  <div class="content-container">
    {% if not authorized %}
      <div class="wrap"><p>Unauthorized</p></div>
    {% else %}
    <div class="wrap">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
        <div>
          <h1 style="font-size:22px; margin:0;">SuperTable Redis Admin</h1>
          <div class="text-xs muted">Manage SuperTable Redis metadata and users.</div>
        </div>
        <div class="text-xs">
          <a href="/admin/config">Config</a> Â·
          <a href="/admin/logout">Sign out</a>
        </div>
      </div>

      <!-- Tenant + Root / Mirrors / Tables in a single row -->
      <div class="top-row">
        <!-- Tenant card -->
        <div class="card">
          <div class="section">
            <div class="grid">
              <div>
                <label class="muted text-sm">Tenant</label><br/>
                <select id="pairSel" onchange="onPairChange()" style="min-width:300px">
                  {% for t in tenants %}
                    <option value="{{t.org}}|{{t.sup}}" {% if t.selected %}selected{% endif %}>
                      {{t.org}} / {{t.sup}}
                    </option>
                  {% endfor %}
                </select>
                {% if has_tenant %}
                  <div class="muted text-xs mt-2">Showing: {{ sel_org }} / {{ sel_sup }}</div>
                {% else %}
                  <div class="muted text-xs mt-2">No tenant discovered in Redis.</div>
                {% endif %}
              </div>
              <div class="right"></div>
            </div>
          </div>
        </div>

        {% if has_tenant %}
        <!-- Root card -->
        <div class="card root-card">
          <div class="section">
            <div class="muted text-sm">Root</div>
            <div class="mt-2">
              <span class="chip">
                <span style="text-transform:uppercase; font-weight:600;">version</span>
                <strong>{{ root_version }}</strong>
              </span>
            </div>
            <div class="mt-2 text-xs">Updated: {{ root_ts }}</div>
          </div>
        </div>

        <!-- Mirrors card -->
        <div class="card">
          <div class="section">
            <div class="muted text-sm">Mirrors</div>
            <div class="mt-2 flex">
              {% for fmt in ["DELTA","ICEBERG","PARQUET"] %}
                <label class="chip" style="gap:6px;">
                  <input type="checkbox"
                         {% if fmt in mirrors %}checked{% endif %}
                         onchange="toggleMirror('{{fmt}}', this)"/>
                  {{fmt}}
                </label>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Users / Roles tabs (non-table stuff) -->
      <div class="tabs">
        <div id="tab-users" class="tab active" onclick="switchTab('users')">
          <i class="fas fa-users"></i>&nbsp;Users
        </div>
        <div id="tab-roles" class="tab" onclick="switchTab('roles')">
          <i class="fas fa-user-shield"></i>&nbsp;Roles
        </div>
      </div>

      <!-- Users pane -->
      <div id="pane-users" class="tabpane">
        <div class="card mt-4">
          <div class="section">
            <div class="muted text-sm">Users</div>
            <div class="mt-2">
              <table>
                <thead>
                  <tr class="border-b">
                    <th class="px-3 py-2 text-xs muted">hash</th>
                    <th class="px-3 py-2 text-xs muted">name</th>
                    <th class="px-3 py-2 text-xs muted">roles</th>
                    <th class="px-3 py-2 text-xs muted">actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for u in users %}
                  <tr class="border-b">
                    <td class="px-3 py-2 font-mono text-sm">{{ u.hash }}</td>
                    <td class="px-3 py-2 text-sm">{{ u.get('name','') }}</td>
                    <td class="px-3 py-2 text-sm">
                      {{ (u.get('roles') or []) | join(', ') }}
                    </td>
                    <td class="px-3 py-2 text-sm">
                      <button class="btn-ghost" onclick="viewUser('{{ u.hash }}')">
                        Display
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Roles pane -->
      <div id="pane-roles" class="tabpane hidden">
        <div class="card mt-4">
          <div class="section">
            <div class="muted text-sm">Roles</div>
            <div class="mt-2">
              <table>
                <thead>
                  <tr class="border-b">
                    <th class="px-3 py-2 text-xs muted">hash</th>
                    <th class="px-3 py-2 text-xs muted">type</th>
                    <th class="px-3 py-2 text-xs muted">description</th>
                    <th class="px-3 py-2 text-xs muted">actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in roles %}
                  <tr class="border-b">
                    <td class="px-3 py-2 font-mono text-sm">{{ r.hash }}</td>
                    <td class="px-3 py-2 text-sm">{{ r.get('type','') }}</td>
                    <td class="px-3 py-2 text-sm">{{ r.get('description','') }}</td>
                    <td class="px-3 py-2 text-sm">
                      <button class="btn-ghost" onclick="viewRole('{{ r.hash }}')">
                        Display
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div id="modal" class="modal"
           onclick="if(event.target.id==='modal'){closeModal()}">
        <div class="panel">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <h3 id="m-title" style="margin:0; font-size:16px;"></h3>
            <button class="btn-ghost" onclick="closeModal()">Close</button>
          </div>
          <pre id="m-body" class="mt-2" style="max-height:60vh; overflow:auto;"></pre>
        </div>
      </div>

    </div>  {# closes .wrap #}
    {% endif %}  {# closes {% if not authorized %} #}
  </div>
</body>
</html>
