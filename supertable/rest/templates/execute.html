<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SuperTable – Execute SQL</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Bootstrap for basic layout (matches admin sidebar) -->
  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <!-- CodeMirror styles -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.css">

  <style>
    :root {
      --primary-color: #1c96ca;
      --primary-light: #e6f4fa;
      --secondary-color: #147ba3;
      --dark-color: #1a1a2e;
      --light-color: #f8f9fa;
      --text-color: #2b2d42;
      --text-light: #8d99ae;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);

      --panel-bg: #ffffff;
      --panel-border: #e0e5f0;
      --panel-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont;
      background: #f3f6fb;
      color: var(--text-color);
    }

    a {
      color: var(--primary-color);
      text-decoration: none;
    }
    a:hover { text-decoration: underline; }

    /* ------------ MAIN CONTENT ------------ */

    .content-container {
      margin-left: 280px;
      min-height: 100vh;
      background-color: #f3f6fb;
      transition: var(--transition);
      padding-bottom: 40px;
    }

    .sidebar-collapsed ~ .content-container {
      margin-left: 80px;
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .card {
      background: var(--panel-bg);
      border-radius: 16px;
      box-shadow: var(--panel-shadow);
      border: 1px solid var(--panel-border);
    }

    .section { padding: 16px 20px; }
    .muted { color: var(--text-light); }
    .text-xs { font-size: 11px; }
    .text-sm { font-size: 12px; }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .header-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }

    .btn {
      padding: 8px 12px;
      border-radius: 10px;
      background: #0b2940;
      border: 1px solid #1d3b57;
      color: #e2e8f0;
      font-weight: 500;
      cursor: pointer;
      font-size: 13px;
    }

    .btn:hover { filter: brightness(1.05); }

    .btn-ghost {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #d0d7e7;
      background: transparent;
      color: #475569;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-ghost:hover { background: #e2e8f0; }

    input, select, textarea {
      background: #ffffff;
      border: 1px solid #d0d7e7;
      color: var(--text-color);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      width: 100%;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(28,150,202,0.15);
      border-color: var(--primary-color);
    }

    textarea { resize: vertical; min-height: 120px; }

    /* CodeMirror styling – white editor */
    .CodeMirror {
      border-radius: 12px;
      border: 1px solid #d0d7e7;
      background: #ffffff;
      color: #0b1220;
      font-size: 13px;
      min-height: 200px;
    }

    .CodeMirror-focused {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(28,150,202,0.25);
    }

    .btn-exec {
      color: #0b1220;
      background: linear-gradient(135deg, #38bdf8 0%, #1ac8ff 100%);
      border: none;
      padding: 10px 18px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      font-size: 13px;
      box-shadow: 0 4px 15px rgba(28,150,202,.35);
      transition: transform .1s ease;
      white-space: nowrap;
    }
    .btn-exec:active { transform: translateY(1px); }

    #status i { color: #10b981; }
    #status.executing i { color: #f59e0b; animation: spin 1s linear infinite; }
    #status.error i { color: #ef4444; }

    @keyframes spin {
      0% { transform:rotate(0deg); }
      100% { transform:rotate(360deg); }
    }

    #result table {
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
    }

    #result th, #result td {
      padding: 8px 10px;
      border:1px solid #e2e8f0;
      background:#ffffff;
    }

    #result thead th {
      position: sticky;
      top: 0;
      background: #f1f5f9;
      z-index: 1;
    }

    #result tr:nth-child(even) td {
      background: #f9fafb;
    }

    #result tr:hover td {
      background: #e0f2fe;
    }

    #result .row-index {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: #64748b;
    }

    .download-row {
      margin-top: 12px;
      text-align: right;
    }

    .btn-download {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #0f172a;
      background: #0f172a;
      color: #e2e8f0;
      cursor: pointer;
      font-size: 12px;
    }
    .btn-download:hover { filter: brightness(1.08); }

    .pagination {
      margin-top: 12px;
      text-align: right;
    }

    .page-btn {
      padding: 4px 8px;
      margin-left: 4px;
      border-radius: 6px;
      border: 1px solid #d0d7e7;
      background: #ffffff;
      cursor: pointer;
      font-size: 11px;
    }

    .page-btn.active {
      border-color: var(--primary-color);
      color: var(--primary-color);
      font-weight: 600;
      background: #e6f4fa;
    }
  </style>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js">
  </script>

  <script>
    // --- Shared admin API helper ---
    function api(path, opts) {
      opts = opts || {};
      opts.headers = opts.headers || {};
      if (window.__admintoken) opts.headers['X-Admin-Token'] = window.__admintoken;
      return fetch(path, opts).then(async res => {
        const ct = res.headers.get('content-type') || '';
        const payload = ct.includes('application/json')
          ? await res.json()
          : await res.text();
        if (!res.ok) {
          const msg = typeof payload === 'string' ? payload : JSON.stringify(payload);
          throw new Error(msg);
        }
        return payload;
      });
    }

    function onPairChange() {
      const sel = document.getElementById('pairSel');
      const [org, sup] = (sel.value || '|').split('|');
      const url = new URL(window.location.href);
      url.searchParams.set('org', org);
      url.searchParams.set('sup', sup);
      window.location.href = url.toString();
    }

    function goBackAdmin() {
      const sel = document.getElementById('pairSel');
      const [org, sup] = (sel.value || '|').split('|');
      const url = new URL('/admin', window.location.origin);
      if (org) url.searchParams.set('org', org);
      if (sup) url.searchParams.set('sup', sup);
      window.location.href = url.toString();
    }

    function getTenant() {
      const sel = document.getElementById('pairSel');
      const [organization, superName] = (sel?.value || '|').split('|');
      return { organization, superName };
    }

    function setStatus(text, cls) {
      const el = document.getElementById('status');
      el.className = 'text-sm muted ' + (cls || '');
      el.innerHTML = `<i class="fas fa-circle" style="font-size:8px;"></i>&nbsp;${text}`;
    }

    function renderError(msg) {
      document.getElementById('result').innerHTML = `
        <div style="
            border:1px solid #fecaca;
            background:#fef2f2;
            color:#7f1d1d;
            border-radius:10px;
            padding:12px;">
          <strong>Error:</strong>
          <pre style="white-space:pre-wrap; margin:4px 0 0 0;">${(msg||'').toString()}</pre>
        </div>`;
    }

    function renderTable(rows, total, page, pageSize, onPage) {
      if (!rows || !rows.length) {
        document.getElementById('result').innerHTML =
          '<div class="muted text-sm">No results</div>';
        window.__curRows = []; window.__curHeaders = [];
        return;
      }
      const headers = Object.keys(rows[0]);
      let html =
        '<div style="overflow:auto; max-height:60vh;">' +
        '<table><thead><tr><th>#</th>';
      headers.forEach(h => { html += `<th>${h}</th>`; });
      html += '</tr></thead><tbody>';

      rows.forEach((r, i) => {
        const absIdx = (page-1)*pageSize + i + 1;
        html += '<tr>';
        html += `<td class="row-index">${absIdx}</td>`;
        headers.forEach(h => {
          let v = r[h];
          if (v === null || v === undefined) v = '';
          if (typeof v === 'object') v = JSON.stringify(v);
          html += `<td>${v}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table></div>';

      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (totalPages > 1) {
        html += '<div class="pagination">';
        for (let p = 1; p <= totalPages; p++) {
          const cls = p === page ? 'page-btn active' : 'page-btn';
          html += `<button class="${cls}" onclick="(${onPage.toString()})(${p})">${p}</button>`;
        }
        html += '</div>';
      }

      document.getElementById('result').innerHTML = html;
      window.__curRows = rows;
      window.__curHeaders = headers;
    }

    function downloadCSV() {
      const rows = window.__curRows || [];
      const headers = window.__curHeaders || [];
      if (!rows.length || !headers.length) return;
      const csv = [
        headers.join(','),
        ...rows.map(r =>
          headers.map(h => {
            let v = r[h];
            if (v === null || v === undefined) v = '';
            if (typeof v === 'object') v = JSON.stringify(v);
            const s = String(v).replace(/"/g, '""');
            return `"${s}"`;
          }).join(',')
        )
      ].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `query_results_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function loadSchema() {
      const userHash = document.getElementById('userHash')?.value;
      const { organization, superName } = getTenant();
      if (!organization || !superName || !userHash) return;

      try {
        const data = await api('/admin/schema', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            organization,
            super_name: superName,
            user_hash: userHash
          })
        });
        if (data.status === 'ok') {
          const hint = {};
          (data.schema || []).forEach(obj => {
            const t = Object.keys(obj)[0];
            const cols = obj[t] || [];
            hint[t] = { columns: cols };
          });
          window.__hintTables = hint;
          if (window.editor) {
            window.editor.setOption('hintOptions', {
              completeSingle:false,
              tables: hint
            });
          }
        }
      } catch (e) {
        console.error('Schema load failed:', e);
      }
    }

    // --- execution timing state ---
    let execStartTime = null;
    let execTimerId = null;

    async function executeSQL(page) {
      const userHash = document.getElementById('userHash').value;
      const pageSize = parseInt(document.getElementById('pageSize').value || '100', 10);
      const query = window.editor.getValue().trim();
      const { organization, superName } = getTenant();

      if (!organization || !superName || !userHash) {
        setStatus('Please select a tenant and a user hash.', 'error');
        return;
      }
      if (!/^\s*(select|with)\b/i.test(query)) {
        setStatus('Only SELECT/WITH queries are allowed.', 'error');
        return;
      }

      const startedAt = Date.now();
      execStartTime = startedAt;

      if (execTimerId) {
        clearInterval(execTimerId);
        execTimerId = null;
      }

      // live timer while executing
      execTimerId = setInterval(() => {
        if (execStartTime === null) return;
        const elapsedSec = (Date.now() - execStartTime) / 1000;
        const text = `Executing… ${elapsedSec.toFixed(1)}s`;
        setStatus(text, 'executing');
      }, 150);

      setStatus('Executing…', 'executing');

      try {
        const data = await api('/admin/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            organization,
            super_name: superName,
            user_hash: userHash,
            query,
            page: page || 1,
            page_size: pageSize
          })
        });

        const finishedAt = Date.now();
        const elapsedMsClient = finishedAt - startedAt;

        // stop timer
        execStartTime = null;
        if (execTimerId) {
          clearInterval(execTimerId);
          execTimerId = null;
        }

        if (data.status === 'ok') {
          renderTable(
            data.result || [],
            data.total_count || 0,
            page || 1,
            pageSize,
            (p) => executeSQL(p)
          );

          // prefer backend duration if available, else client timing
          let durationMs = null;
          if (typeof data.duration_ms === 'number') {
            durationMs = data.duration_ms;
          } else if (typeof data.duration === 'number') {
            durationMs = data.duration;
          } else {
            durationMs = elapsedMsClient;
          }

          const durationStr = (durationMs / 1000).toFixed(3) + 's';
          const rowsLen = (data.result || []).length;
          const total = data.total_count || 0;

          const statusText =
            `Success — ${rowsLen} rows (total ${total}) in ${durationStr}`;

          setStatus(statusText);
        } else {
          const finishedAtError = Date.now();
          const elapsedErrorSec = ((finishedAtError - startedAt) / 1000).toFixed(3);

          setStatus(`Error executing query after ${elapsedErrorSec}s`, 'error');
          renderError(data.message || 'Unknown error');
        }
      } catch (e) {
        const finishedAt = Date.now();
        const elapsedSec = ((finishedAt - startedAt) / 1000).toFixed(3);

        execStartTime = null;
        if (execTimerId) {
          clearInterval(execTimerId);
          execTimerId = null;
        }

        setStatus(`Error executing query after ${elapsedSec}s`, 'error');
        renderError(e.message || String(e));
      }
    }

    // Sidebar toggle + nav highlight
    $(document).ready(function(){
      window.__admintoken = "{{ token|e }}";

      $("#toggleSidebar").on("click", function() {
        $("#sidebar").toggleClass("sidebar-collapsed");
        localStorage.setItem('st_sidebar_collapsed',
          $("#sidebar").hasClass("sidebar-collapsed"));
      });

      if (localStorage.getItem('st_sidebar_collapsed') === 'true') {
        $("#sidebar").addClass("sidebar-collapsed");
      }

      $("#link-execute").addClass("active");
    });
  </script>
</head>
<body>
  {% include "sidebar.html" %}

  <!-- MAIN CONTENT -->
  <div class="content-container">
    <div class="wrap">
      <div class="header-row">
        <div>
          <h1 style="font-size:22px; margin:0;">SuperTable – Execute SQL</h1>
          <div class="text-xs muted">
            Interactive SQL runner with RBAC enforced by selected user hash.
          </div>
        </div>
        <div class="text-xs">
          <a href="/admin/config">Config</a> ·
          <a href="/admin/logout">Sign out</a>
        </div>
      </div>

      <!-- Tenant selection -->
      <div class="card">
        <div class="section">
          <div class="grid">
            <div>
              <label class="text-sm muted">Tenant</label><br/>
              <select id="pairSel" onchange="onPairChange()" style="min-width:300px">
                {% for t in tenants %}
                  <option value="{{t.org}}|{{t.sup}}" {% if t.selected %}selected{% endif %}>
                    {{t.org}} / {{t.sup}}
                  </option>
                {% endfor %}
              </select>
              {% if has_tenant %}
                <div class="text-xs muted" style="margin-top:6px;">
                  Selected: {{ sel_org }} / {{ sel_sup }}
                </div>
              {% else %}
                <div class="text-xs muted" style="margin-top:6px;">
                  No tenant discovered in Redis.
                </div>
              {% endif %}
            </div>
            <div style="text-align:right;">
              <button class="btn-ghost" onclick="goBackAdmin()">
                <i class="fas fa-arrow-left"></i>&nbsp;Back to Redis Admin
              </button>
            </div>
          </div>
        </div>
      </div>

      {% if has_tenant %}
      <!-- User + SQL editor -->
      <div class="card" style="margin-top:16px;">
        <div class="section">
          <div class="grid">
            <div>
              <label class="text-sm muted">User (hash)</label>
              <select id="userHash" onchange="loadSchema()">
                {% for u in users %}
                  <option value="{{u.hash}}">
                    {{u.hash}}{% if u.get('name') %} — {{u.get('name')}}{% endif %}
                  </option>
                {% endfor %}
              </select>
              <div class="text-xs muted" style="margin-top:6px;">
                RBAC is enforced via the selected user hash.
              </div>
            </div>
            <div>
              <label class="text-sm muted">Page size</label>
              <input id="pageSize" type="number" min="1" max="5000" value="100"/>
            </div>
          </div>

          <div style="margin-top:12px;">
            <label class="text-sm muted">SQL Query</label>
            <textarea id="sql" rows="8">SELECT * FROM {{ sel_sup }} LIMIT 100</textarea>
          </div>

          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px;">
            <div id="status" class="text-sm muted">
              <i class="fas fa-circle" style="font-size:8px;"></i>&nbsp;Ready
            </div>
            <div style="display:flex; gap:8px;">
              <button id="btnExec" class="btn-exec">
                <i class="fas fa-play"></i>&nbsp;Execute
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div class="card" style="margin-top:16px;">
        <div class="section">
          <div id="result"></div>
          <div class="download-row">
            <button class="btn-download" onclick="downloadCSV()">
              <i class="fas fa-file-csv"></i>&nbsp;Download CSV
            </button>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- CodeMirror scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/sql/sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/sql-hint.min.js"></script>

  <script>
    // Initialize CodeMirror + hooks
    window.__admintoken = "{{ token|e }}";

    window.editor = CodeMirror.fromTextArea(document.getElementById('sql'), {
      mode: "text/x-sql",
      theme: 'default',
      lineNumbers: true,
      matchBrackets: true,
      lineWrapping: true,
      extraKeys: {
        "Ctrl-Enter": function(cm){ executeSQL(1); return false; },
        "Cmd-Enter": function(cm){ executeSQL(1); return false; },
        "Ctrl-Space": function(cm){
          cm.showHint({
            completeSingle:false,
            hint: CodeMirror.hint.sql,
            tables: window.__hintTables || {}
          });
        }
      },
      hintOptions: { completeSingle:false, tables: {} }
    });

    document.getElementById('btnExec')
            .addEventListener('click', () => executeSQL(1));

    // Load schema hints once UI is ready
    loadSchema();
  </script>
</body>
</html>
